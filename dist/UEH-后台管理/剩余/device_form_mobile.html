<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>授权书 - 移动版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

    <!-- Tailwind 配置 - 苹果风格 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0071e3',
                        secondary: '#1d1d1f',
                        tertiary: '#86868b',
                        light: '#f5f5f7',
                        success: '#34c759',
                        warning: '#ff9500',
                        danger: '#ff3b30',
                        border: '#d2d2d7',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'apple': '0 2px 10px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.03)',
                        'apple-hover': '0 5px 15px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05)',
                    }
                },
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none transition-all duration-200;
            }
            .btn-apple {
                @apply bg-primary text-white font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-outline {
                @apply border border-primary text-primary font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-outline-black {
                @apply border border-black text-black font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .btn-black {
                @apply bg-black text-white font-medium py-3 px-4 rounded-xl shadow-sm transition-all duration-200 active:scale-95;
            }
            .input-apple {
                @apply w-full px-4 py-4 bg-light border border-transparent rounded-xl transition-all duration-200 text-base;
                &:focus {
                    @apply ring-2 ring-primary border-primary text-black outline-none bg-white;
                }
            }
            .label-apple {
                @apply block text-sm font-semibold text-secondary mb-2;
            }
            .card-apple {
                @apply bg-white rounded-2xl overflow-hidden transition-all duration-300;
            }
        }
    </style>

    <style>
        /* 全局样式 */
        html, body {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: #f5f5f7;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        /* 防止iOS弹性滚动 */
        .no-bounce {
            overscroll-behavior: contain;
        }
        
        /* 签名板样式 */
        .signature-pad {
            border: 2px dashed #d2d2d7;
            border-radius: 1rem;
            background-color: white;
            touch-action: none;
        }
        .signature-pad:focus {
            outline: none;
            border-color: #0071e3;
        }
        
        /* 底部固定按钮容器 */
        .fixed-bottom-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,1) 85%, rgba(255,255,255,0));
            z-index: 40;
        }
        
        /* 底部安全区域 */
        .bottom-safe-area {
            height: env(safe-area-inset-bottom);
            background: white;
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 触摸反馈 */
        .touchable {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        .touchable:active {
            opacity: 0.7;
        }
        
        /* 模态框动画 */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .modal-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        /* 状态消息动画 */
        @keyframes fadeSlideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .status-message {
            animation: fadeSlideDown 0.3s ease-out;
        }
        
        /* 隐藏滚动条但保持滚动功能 */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* 输入框聚焦时防止键盘遮挡 */
        input:focus, textarea:focus, select:focus {
            font-size: 16px !important;
        }
        
        /* 全屏模态框背景 */
        .modal-backdrop {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="font-sans text-secondary no-bounce">
    <!-- 顶部固定导航栏 -->
    <header class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md z-50 safe-top border-b border-border">
        <div class="flex justify-between items-center px-4 py-3">
            <img src="logo_副本.png" alt="Logo" class="h-7 max-w-[120px] object-contain">
            <div class="flex items-center gap-2">
                <!-- 查询按钮 -->
                <button id="query-btn" class="touchable px-3 py-1.5 rounded-full bg-black text-white text-sm font-medium">
                    <i class="fa fa-search mr-1"></i>
                    <span data-i18n="query_btn">查询</span>
                </button>
                <!-- 语言切换按钮 -->
                <button id="lang-toggle-btn" class="touchable px-3 py-1.5 rounded-full bg-light text-sm font-medium">
                    <span id="current-lang">中文</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区域 -->
    <main class="pt-16 pb-24 safe-top" id="main-content">
        <!-- 状态消息 -->
        <div id="status-message" class="hidden fixed top-20 left-4 right-4 p-3 rounded-xl status-message z-50 safe-top"></div>

        <!-- 表单页面（默认显示） -->
        <div id="form-page" class="px-4 py-4">
            <h1 class="text-2xl font-bold mb-6" data-i18n="form_title">授权书</h1>
            
            <form id="device-form" class="space-y-4">
                <!-- 所有基本信息在一个大卡片内 -->
                <div class="card-apple p-4 space-y-6">
                    <!-- 品牌选择 -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2" data-i18n="brand_label">品牌</label>
                        <button type="button" id="brand-select-btn" class="w-full px-3 py-3 bg-light rounded-xl text-left flex justify-between items-center">
                            <span id="brand-display" class="text-base text-tertiary" data-i18n="please_select_brand">请选择品牌</span>
                            <i class="fa fa-chevron-down text-tertiary"></i>
                        </button>
                        <input type="hidden" id="brand" name="brand" value="">
                    </div>

                    <!-- 账号输入 -->
                    <div>
                        <label for="user-account" class="block text-sm font-medium text-secondary mb-2" data-i18n="account_label">账号</label>
                        <input type="text" id="user-account" name="user-account" 
                               placeholder="请输入账号" 
                               class="w-full px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                    </div>

                    <!-- 设备SN -->
                    <div>
                        <label for="device-sn" class="block text-sm font-medium text-secondary mb-2" data-i18n="sn_label">设备SN</label>
                        <div class="flex gap-2">
                            <input type="text" id="device-sn" name="device-sn" 
                                   placeholder="请输入设备SN码" 
                                   class="flex-1 px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                            <button type="button" id="scan-sn-btn" class="touchable px-4 py-3 bg-light rounded-xl">
                                <i class="fa fa-qrcode text-primary text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 设备地址 -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2" data-i18n="address_label">设备地址</label>
                        <div class="relative">
                            <input type="text" id="device-address" name="device-address" 
                                   placeholder="正在获取当前位置..." 
                                   class="w-full px-3 py-3 pr-20 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-2">
                                <button type="button" id="refresh-location-btn" class="touchable p-2" title="刷新位置">
                                    <i class="fa fa-location-arrow text-primary"></i>
                                </button>
                                <button type="button" id="select-region-btn" class="touchable p-2" title="选择地区">
                                    <i class="fa fa-map-marker text-primary"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 电表号 -->
                    <div>
                        <label for="meter-number" class="block text-sm font-medium text-secondary mb-2" data-i18n="meter_label">电表号</label>
                        <input type="text" id="meter-number" name="meter-number" 
                               placeholder="请输入电表号" 
                               class="w-full px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                    </div>

                    <!-- 签名区域 -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-secondary" data-i18n="signature_label">签名确认</label>
                            <button type="button" id="clear-signature-btn" class="touchable text-sm text-danger">
                                <span data-i18n="clear_signature">清除</span>
                            </button>
                        </div>
                        <canvas id="signature-pad" class="signature-pad w-full h-40"></canvas>
                        <p class="text-xs text-tertiary mt-2 text-center" data-i18n="signature_hint">请在上方区域签名</p>
                    </div>
                </div>

                <!-- 隐私协议 -->
                <div class="px-4 py-2">
                    <label class="flex items-start">
                        <input type="checkbox" id="privacy-agreement" name="privacy-agreement" 
                               class="mt-0.5 mr-3 w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary disabled:opacity-50"
                               disabled>
                        <div class="flex-1">
                            <p class="text-sm text-secondary">
                                <span data-i18n="privacy_text">我已阅读并同意</span>
                                <a href="#" class="text-primary privacy-link" data-i18n="privacy_policy">《隐私政策》</a>
                            </p>
                            <p id="privacy-hint" class="text-xs text-warning mt-0.5" data-i18n="privacy_hint">（请先阅读协议内容）</p>
                        </div>
                    </label>
                </div>
            </form>
        </div>

        <!-- 查询页面（初始隐藏） -->
        <div id="query-page" class="hidden px-4 py-4">
            <div class="flex items-center gap-3 mb-6">
                <button id="back-btn" class="touchable text-primary p-2 -ml-2">
                    <i class="fa fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-2xl font-bold" data-i18n="query_title">查询授权书</h1>
            </div>
            
            <div class="space-y-4">
                <!-- 查询条件区域 -->
                <div>
                    <!-- 返回图标 -->
                    <div class="flex justify-start mb-3">
                        <button id="query-form-back-btn" class="touchable flex items-center gap-1.5 -ml-1">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                            <span class="text-blue-500 text-base">返回</span>
                        </button>
                    </div>
                    <!-- 查询条件在一个大卡片内 -->
                    <div class="card-apple p-4 space-y-6">
                        <!-- 品牌选择 -->
                        <div>
                            <label class="block text-sm font-medium text-secondary mb-2" data-i18n="brand_label">品牌</label>
                            <button type="button" id="query-brand-select-btn" class="w-full px-3 py-3 bg-light rounded-xl text-left flex justify-between items-center">
                                <span id="query-brand-display" class="text-base text-tertiary" data-i18n="please_select_brand">请选择品牌</span>
                                <i class="fa fa-chevron-down text-tertiary"></i>
                            </button>
                            <input type="hidden" id="query-brand" name="query-brand" value="">
                        </div>
                        
                        <!-- 账号输入 -->
                        <div>
                            <label for="query-account-input" class="block text-sm font-medium text-secondary mb-2" data-i18n="account_label">账号</label>
                            <input type="text" id="query-account-input" 
                                   placeholder="请输入账号" 
                                   class="w-full px-3 py-3 bg-light rounded-xl text-base outline-none placeholder-tertiary">
                        </div>
                    </div>
                </div>
                
                <!-- 查询按钮 -->
                <button id="do-query-btn" class="btn-black w-full flex justify-center items-center gap-2">
                    <i class="fa fa-search"></i>
                    <span data-i18n="do_query">查询</span>
                </button>
            </div>
            
            <!-- 查询结果区域 -->
            <div id="query-result" class="hidden mt-6">
                <div class="card-apple p-4">
                    <div id="query-result-content" class="space-y-3 text-sm"></div>
                    <button id="edit-query-btn" class="btn-outline-black w-full mt-4 flex justify-center items-center gap-2">
                        <i class="fa fa-pencil"></i>
                        <span data-i18n="edit_query">编辑</span>
                    </button>
                </div>
            </div>
            
            <!-- 无数据提示 -->
            <div id="no-data-message" class="hidden mt-6 card-apple p-4 bg-danger/5 border border-danger/20">
                <div class="flex items-center gap-3">
                    <i class="fa fa-info-circle text-danger text-xl"></i>
                    <div>
                        <p class="font-medium text-danger" data-i18n="query_failed">查询失败</p>
                        <p class="text-xs text-tertiary mt-0.5" data-i18n="no_data">暂未查询到该账号信息</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交成功页面（初始隐藏） -->
        <div id="success-page" class="hidden px-4 py-4">
            <div class="text-center py-8">
                <div class="w-20 h-20 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-check text-success text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold mb-2" data-i18n="submit_success">提交成功</h2>
                <p class="text-tertiary text-sm" data-i18n="success_message">设备信息已成功提交</p>
            </div>
            
            <div class="card-apple p-4 space-y-4">
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="brand_label">品牌</span>
                    <span id="display-brand" class="font-medium text-sm"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="account_label">账号</span>
                    <span id="display-account" class="font-medium text-sm"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="sn_label">设备SN</span>
                    <span id="display-sn" class="font-medium text-sm"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="address_label">地址</span>
                    <span id="display-address" class="font-medium text-sm text-right max-w-[60%]"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="meter_label">电表号</span>
                    <span id="display-meter" class="font-medium text-sm"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-tertiary text-sm" data-i18n="auth_status">授权状态</span>
                    <span id="display-auth-status" class="font-medium text-sm"></span>
                </div>
                <div>
                    <span class="text-tertiary text-sm block mb-2" data-i18n="signature_label">签名</span>
                    <div id="display-signature-container" class="border border-border rounded-xl p-2 bg-light min-h-[60px] flex items-center justify-center"></div>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="edit-btn" class="btn-outline-black w-full">
                    <i class="fa fa-pencil mr-2"></i>
                    <span data-i18n="edit_info">修改信息</span>
                </button>
            </div>
        </div>
    </main>

    <!-- 底部固定提交按钮 -->
    <div id="submit-btn-container" class="fixed-bottom-btn p-4">
        <button type="submit" form="device-form" id="submit-btn" class="btn-black w-full flex justify-center items-center gap-2">
            <i class="fa fa-paper-plane"></i>
            <span data-i18n="submit_form">提交表单</span>
        </button>
        <div class="bottom-safe-area"></div>
    </div>

    <!-- 地址选择底部弹出框 -->
    <div id="address-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 85vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 模态框头部 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="select_address_title">选择地址</h3>
                    <button id="close-address-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 地址列表 -->
            <div class="overflow-y-auto hide-scrollbar" style="max-height: calc(85vh - 200px);">
                <!-- 搜索框 -->
                <div class="px-4 py-3 sticky top-0 bg-white border-b border-border">
                    <div class="relative">
                        <input type="text" id="address-search" 
                               placeholder="搜索地址" 
                               class="w-full pl-10 pr-4 py-3 bg-light rounded-xl">
                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-tertiary"></i>
                    </div>
                </div>
                
                <!-- 热门地址 -->
                <div class="px-4 py-3">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="popular_addresses">热门地址</p>
                    <div class="space-y-1" id="address-list-container">
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="悉尼, 新南威尔士州, 澳大利亚">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">悉尼</p>
                                    <p class="text-xs text-tertiary">新南威尔士州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="墨尔本, 维多利亚州, 澳大利亚">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">墨尔本</p>
                                    <p class="text-xs text-tertiary">维多利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="布里斯班, 昆士兰州, 澳大利亚">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">布里斯班</p>
                                    <p class="text-xs text-tertiary">昆士兰州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="珀斯, 西澳大利亚州, 澳大利亚">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">珀斯</p>
                                    <p class="text-xs text-tertiary">西澳大利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                        <button class="address-item touchable w-full text-left p-3 hover:bg-light rounded-xl" 
                                data-address="阿德莱德, 南澳大利亚州, 澳大利亚">
                            <div class="flex items-center gap-3">
                                <i class="fa fa-map-marker text-tertiary"></i>
                                <div>
                                    <p class="font-medium">阿德莱德</p>
                                    <p class="text-xs text-tertiary">南澳大利亚州, 澳大利亚</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- 手动输入 -->
                <div class="px-4 py-3 border-t border-border bg-white">
                    <p class="text-sm font-medium text-tertiary mb-3" data-i18n="manual_input">手动输入地址</p>
                    <div class="flex gap-2">
                        <input type="text" id="manual-address-input" 
                               placeholder="输入详细地址" 
                               class="flex-1 px-4 py-3 bg-light rounded-xl">
                        <button id="confirm-manual-address" class="btn-apple px-6">
                            <span data-i18n="confirm">确认</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐私政策模态框 -->
    <div id="privacy-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 85vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 模态框头部 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="privacy_title">隐私政策</h3>
                    <button id="close-privacy-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div class="px-4 py-4 overflow-y-auto hide-scrollbar" style="max-height: calc(85vh - 140px);">
                <div class="text-sm text-tertiary space-y-4">
                    <p>本隐私政策描述了我们如何收集、使用、存储和保护您提供的信息。</p>
                    <p>我们收集的信息仅用于设备管理和服务提供的目的，不会分享给第三方。</p>
                    <p>您有权访问、更正或删除您的个人信息。如有疑问，请联系我们的客服团队。</p>
                    <p>通过提交此表单，您确认您已阅读并同意我们的隐私政策。</p>
                </div>
            </div>
            
            <!-- 底部按钮 -->
            <div class="px-4 py-3 border-t border-border bg-white">
                <button id="privacy-read-btn" class="btn-black w-full">
                    <span data-i18n="privacy_read_btn">我已阅读</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 品牌选择模态框 -->
    <div id="brand-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up" style="max-height: 60vh;">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 标题 -->
            <div class="px-4 pb-3 border-b border-border">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-i18n="select_brand_title">选择品牌</h3>
                    <button id="close-brand-btn" class="touchable p-2">
                        <i class="fa fa-times text-xl text-tertiary"></i>
                    </button>
                </div>
            </div>
            
            <!-- 品牌列表 -->
            <div class="overflow-y-auto" style="max-height: calc(60vh - 120px);">
                <div class="py-2">
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="ipotisedge">
                        <span class="text-base">ipotisedge</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                    
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="foxess">
                        <span class="text-base">FOX ESS</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                    
                    <button class="brand-option touchable w-full text-left px-4 py-4 flex items-center justify-between hover:bg-light transition-colors" data-value="weiheng">
                        <span class="text-base">weiheng</span>
                        <i class="fa fa-check text-primary hidden brand-check"></i>
                    </button>
                </div>
            </div>
            
            <!-- 底部安全区 -->
            <div class="safe-bottom bg-white"></div>
        </div>
    </div>
    
    <!-- 语言选择模态框 -->
    <div id="lang-modal" class="fixed inset-0 bg-black/50 z-50 hidden modal-backdrop">
        <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl modal-slide-up">
            <!-- 顶部拖动条 -->
            <div class="py-2">
                <div class="w-12 h-1 bg-tertiary/30 rounded-full mx-auto"></div>
            </div>
            
            <!-- 标题 -->
            <div class="px-4 pb-3 border-b border-border">
                <h3 class="text-lg font-bold">选择语言</h3>
            </div>
            
            <!-- 语言选项 -->
            <div class="py-2">
                <button class="lang-option touchable w-full text-left px-4 py-4 flex justify-between items-center" data-lang="zh">
                    <span class="text-base">中文</span>
                    <i class="fa fa-check text-primary hidden" id="lang-check-zh"></i>
                </button>
                <button class="lang-option touchable w-full text-left px-4 py-4 flex justify-between items-center" data-lang="en">
                    <span class="text-base">English</span>
                    <i class="fa fa-check text-primary hidden" id="lang-check-en"></i>
                </button>
            </div>
            
            <!-- 取消按钮 -->
            <div class="px-4 py-3 border-t border-border bg-white safe-bottom">
                <button id="close-lang-btn" class="touchable text-center w-full py-3 text-primary font-medium">
                    取消
                </button>
            </div>
        </div>
    </div>
    

    <!-- 扫码功能替代实现 -->
    <script>
        function Html5Qrcode(elementId) {
            this.elementId = elementId;
        }
        
        Html5Qrcode.prototype.start = function() {
            alert('扫码功能需要摄像头权限，请手动输入设备SN码');
            return Promise.reject('Camera not available');
        };
        
        Html5Qrcode.prototype.stop = function() {
            return Promise.resolve();
        };
    </script>

    <script>
        // 语言翻译数据
        const translations = {
            en: {
                form_title: 'Authorization',
                brand_label: 'Brand',
                account_label: 'Account',
                sn_label: 'Device SN',
                meter_label: 'NMI',
                signature_label: 'Signature',
                clear_signature: 'Clear',
                signature_hint: 'Please sign above',
                privacy_text: 'I have read and agree to',
                privacy_policy: 'Privacy Policy',
                privacy_hint: '(Please read first)',
                privacy_read_btn: 'I Have Read',
                submit_form: 'Submit',
                submit_success: 'Success',
                success_message: 'Device information submitted',
                edit_info: 'Edit',
                query_btn: 'Query',
                query_title: 'Query Authorization',
                back_btn: 'Back',
                do_query: 'Search',
                edit_query: 'Edit',
                no_data: 'No data found',
                query_failed: 'Query Failed',
                auth_status: 'Status',
                authorized: 'Authorized',
                unauthorized: 'Unauthorized',
                authorizing: 'Authorizing',
                submit_time: 'Submit Time',
                edit_message: 'You can now edit the information',
                address_label: 'Address',
                select_address: 'Select address',
                select_address_title: 'Select Address',
                current_location: 'Current Location',
                click_to_locate: 'Click to get location',
                popular_addresses: 'Popular Addresses',
                manual_input: 'Manual Input',
                confirm: 'Confirm',
                privacy_title: 'Privacy Policy',
                current_lang: 'EN',
                getting_location: 'Getting location...',
                select_brand_title: 'Select Brand',
                please_select_brand: 'Please select brand',
            },
            zh: {
                form_title: '授权书',
                brand_label: '品牌',
                account_label: '账号',
                sn_label: '设备SN',
                meter_label: '电表号',
                signature_label: '签名确认',
                clear_signature: '清除',
                signature_hint: '请在上方区域签名',
                privacy_text: '我已阅读并同意',
                privacy_policy: '《隐私政策》',
                privacy_hint: '（请先阅读协议内容）',
                privacy_read_btn: '我已阅读',
                submit_form: '提交表单',
                submit_success: '提交成功',
                success_message: '设备信息已成功提交',
                edit_info: '修改信息',
                query_btn: '查询',
                query_title: '查询授权书',
                back_btn: '返回',
                do_query: '查询',
                edit_query: '编辑',
                no_data: '暂未查询到该账号信息',
                query_failed: '查询失败',
                auth_status: '授权状态',
                authorized: '已授权',
                unauthorized: '未授权',
                authorizing: '授权中',
                exited: '已退出',
                submit_time: '提交时间',
                edit_message: '您现在可以修改信息',
                address_label: '设备地址',
                select_address: '点击选择地址',
                select_address_title: '选择地址',
                current_location: '当前位置',
                click_to_locate: '点击获取当前位置',
                popular_addresses: '热门地址',
                manual_input: '手动输入地址',
                confirm: '确认',
                privacy_title: '隐私政策',
                current_lang: '中文',
                getting_location: '正在获取位置...',
                select_brand_title: '选择品牌',
                please_select_brand: '请选择品牌',
            }
        };

        let currentLang = 'zh';
        let signaturePad;
        let privacyEnabled = false;

        // 更新地址选项显示语言
        function updateAddressOptions(lang) {
            const addressItems = document.querySelectorAll('.address-item');
            
            if (lang === 'en') {
                const enAddresses = [
                    { value: 'Sydney, NSW, Australia', display: 'Sydney', subtitle: 'New South Wales, Australia' },
                    { value: 'Melbourne, VIC, Australia', display: 'Melbourne', subtitle: 'Victoria, Australia' },
                    { value: 'Brisbane, QLD, Australia', display: 'Brisbane', subtitle: 'Queensland, Australia' },
                    { value: 'Perth, WA, Australia', display: 'Perth', subtitle: 'Western Australia, Australia' },
                    { value: 'Adelaide, SA, Australia', display: 'Adelaide', subtitle: 'South Australia, Australia' },
                ];
                
                addressItems.forEach((item, index) => {
                    if (index < enAddresses.length) {
                        item.dataset.address = enAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-xs');
                        if (titleEl) titleEl.textContent = enAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = enAddresses[index].subtitle;
                    }
                });
            } else {
                const zhAddresses = [
                    { value: '悉尼, 新南威尔士州, 澳大利亚', display: '悉尼', subtitle: '新南威尔士州, 澳大利亚' },
                    { value: '墨尔本, 维多利亚州, 澳大利亚', display: '墨尔本', subtitle: '维多利亚州, 澳大利亚' },
                    { value: '布里斯班, 昆士兰州, 澳大利亚', display: '布里斯班', subtitle: '昆士兰州, 澳大利亚' },
                    { value: '珀斯, 西澳大利亚州, 澳大利亚', display: '珀斯', subtitle: '西澳大利亚州, 澳大利亚' },
                    { value: '阿德莱德, 南澳大利亚州, 澳大利亚', display: '阿德莱德', subtitle: '南澳大利亚州, 澳大利亚' },
                ];
                
                addressItems.forEach((item, index) => {
                    if (index < zhAddresses.length) {
                        item.dataset.address = zhAddresses[index].value;
                        const titleEl = item.querySelector('.font-medium');
                        const subtitleEl = item.querySelector('.text-xs');
                        if (titleEl) titleEl.textContent = zhAddresses[index].display;
                        if (subtitleEl) subtitleEl.textContent = zhAddresses[index].subtitle;
                    }
                });
            }
        }

        // 语言切换函数
        function changeLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            // 更新placeholder
            const placeholders = {
                'user-account': lang === 'zh' ? '请输入您的账号' : 'Enter your account',
                'device-sn': lang === 'zh' ? '请输入设备SN码' : 'Enter device SN',
                'meter-number': lang === 'zh' ? '请输入电表号' : 'Enter NMI',
                'address-search': lang === 'zh' ? '搜索地址' : 'Search address',
                'manual-address-input': lang === 'zh' ? '输入详细地址' : 'Enter detailed address',
                'query-account-input': lang === 'zh' ? '请输入账号' : 'Enter account'
            };
            
            Object.keys(placeholders).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.placeholder = placeholders[id];
            });
            
            document.getElementById('current-lang').textContent = translations[lang].current_lang;
            updateAddressOptions(lang);
            
            // 更新语言选择器勾选状态
            document.getElementById('lang-check-zh').classList.toggle('hidden', lang !== 'zh');
            document.getElementById('lang-check-en').classList.toggle('hidden', lang !== 'en');
        }

        // 显示状态消息
        function showStatusMessage(message, type = 'info') {
            const statusMessage = document.getElementById('status-message');
            
            statusMessage.className = 'fixed top-20 left-4 right-4 p-3 rounded-xl status-message z-50 safe-top';
            if (type === 'success') {
                statusMessage.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-danger', 'text-white');
            } else {
                statusMessage.classList.add('bg-primary', 'text-white');
            }
            
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // 初始化签名板
        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)',
                velocityFilterWeight: 0.7,
                minWidth: 1.5,
                maxWidth: 3
            });
            
            // 清除签名
            document.getElementById('clear-signature-btn').addEventListener('click', function() {
                signaturePad.clear();
            });
        }

        // 初始化地址和定位功能
        function initLocationFeatures() {
            const addressInput = document.getElementById('device-address');
            const refreshLocationBtn = document.getElementById('refresh-location-btn');
            const selectRegionBtn = document.getElementById('select-region-btn');
            const addressModal = document.getElementById('address-modal');
            const closeAddressBtn = document.getElementById('close-address-btn');
            const searchInput = document.getElementById('address-search');
            const manualInput = document.getElementById('manual-address-input');
            const confirmBtn = document.getElementById('confirm-manual-address');
            
            // 页面加载时自动尝试获取位置
            setTimeout(() => {
                getCurrentLocation();
            }, 500);
            
            // 获取当前位置
            function getCurrentLocation() {
                addressInput.placeholder = translations[currentLang].getting_location || 'Getting location...';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            // 尝试反向地理编码获取地址
                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=${currentLang}`,
                                    {
                                        headers: {
                                            'User-Agent': 'AuthorizationForm/1.0'
                                        }
                                    }
                                );
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.display_name) {
                                        addressInput.value = data.display_name;
                                        addressInput.placeholder = '设备地址';
                                        return;
                                    }
                                }
                            } catch (error) {
                                console.error('Reverse geocoding error:', error);
                            }
                            
                            // 如果反向地理编码失败，显示坐标
                            addressInput.value = `纬度: ${lat.toFixed(6)}, 经度: ${lon.toFixed(6)}`;
                            addressInput.placeholder = '设备地址';
                        },
                        function(error) {
                            console.error('Location error:', error);
                            addressInput.placeholder = '无法获取位置，请手动输入';
                            
                            // 尝试IP定位作为备选
                            getLocationByIP();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    addressInput.placeholder = '浏览器不支持定位，请手动输入';
                }
            }
            
            // 通过IP获取大概位置
            async function getLocationByIP() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    if (data.city && data.country_name) {
                        const address = currentLang === 'zh' 
                            ? `${data.country_name} ${data.region} ${data.city}` 
                            : `${data.city}, ${data.region}, ${data.country_name}`;
                        
                        addressInput.value = address;
                        addressInput.placeholder = '设备地址';
                    }
                } catch (error) {
                    console.error('IP location error:', error);
                }
            }
            
            // 刷新位置按钮
            refreshLocationBtn.addEventListener('click', function() {
                getCurrentLocation();
            });
            
            // 选择地区按钮
            selectRegionBtn.addEventListener('click', function() {
                addressModal.classList.remove('hidden');
            });
            
            // 关闭地址选择模态框
            function closeAddressModal() {
                addressModal.classList.add('hidden');
            }
            
            closeAddressBtn.addEventListener('click', closeAddressModal);
            addressModal.addEventListener('click', function(e) {
                if (e.target === addressModal) closeAddressModal();
            });
            
            // 选择地址项
            document.querySelectorAll('.address-item').forEach(item => {
                item.addEventListener('click', function() {
                    const address = this.dataset.address;
                    addressInput.value = address;
                    closeAddressModal();
                });
            });
            
            // 搜索地址
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                document.querySelectorAll('.address-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
            
            // 手动输入地址
            confirmBtn.addEventListener('click', function() {
                const address = manualInput.value.trim();
                if (address) {
                    addressInput.value = address;
                    manualInput.value = '';
                    closeAddressModal();
                }
            });
            
        }

        // 初始化隐私协议
        function initPrivacy() {
            const privacyCheckbox = document.getElementById('privacy-agreement');
            const privacyHint = document.getElementById('privacy-hint');
            const privacyModal = document.getElementById('privacy-modal');
            const closePrivacyBtn = document.getElementById('close-privacy-btn');
            const privacyReadBtn = document.getElementById('privacy-read-btn');
            const privacyLinks = document.querySelectorAll('.privacy-link');
            
            // 点击复选框时检查是否已阅读
            privacyCheckbox.addEventListener('click', function(e) {
                if (!privacyEnabled) {
                    e.preventDefault();
                    privacyModal.classList.remove('hidden');
                }
            });
            
            // 打开隐私政策
            privacyLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    privacyModal.classList.remove('hidden');
                });
            });
            
            // 关闭隐私政策
            function closePrivacyModal() {
                privacyModal.classList.add('hidden');
            }
            
            closePrivacyBtn.addEventListener('click', closePrivacyModal);
            privacyModal.addEventListener('click', function(e) {
                if (e.target === privacyModal) closePrivacyModal();
            });
            
            // 已阅读按钮
            privacyReadBtn.addEventListener('click', function() {
                privacyEnabled = true;
                privacyCheckbox.disabled = false;
                privacyCheckbox.checked = true;
                privacyHint.classList.add('hidden');
                closePrivacyModal();
            });
        }

        // 初始化语言选择
        function initLanguageSelector() {
            const langToggleBtn = document.getElementById('lang-toggle-btn');
            const langModal = document.getElementById('lang-modal');
            const closeLangBtn = document.getElementById('close-lang-btn');
            const langOptions = document.querySelectorAll('.lang-option');
            
            langToggleBtn.addEventListener('click', function() {
                langModal.classList.remove('hidden');
            });
            
            closeLangBtn.addEventListener('click', function() {
                langModal.classList.add('hidden');
            });
            
            langModal.addEventListener('click', function(e) {
                if (e.target === langModal) {
                    langModal.classList.add('hidden');
                }
            });
            
            langOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    changeLanguage(lang);
                    langModal.classList.add('hidden');
                });
            });
        }

        // 初始化表单提交
        function initFormSubmit() {
            const form = document.getElementById('device-form');
            const formPage = document.getElementById('form-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            const editBtn = document.getElementById('edit-btn');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单数据
                const brandValue = document.getElementById('brand').value;
                const brandDisplay = document.getElementById('brand-display').textContent;
                const account = document.getElementById('user-account').value || '--';
                const sn = document.getElementById('device-sn').value || '--';
                const address = document.getElementById('device-address').value || '--';
                const meter = document.getElementById('meter-number').value || '--';
                const hasSignature = !signaturePad.isEmpty();
                
                // 显示提交信息
                document.getElementById('display-brand').textContent = brandValue ? brandDisplay : '--';
                document.getElementById('display-account').textContent = account;
                document.getElementById('display-sn').textContent = sn;
                document.getElementById('display-address').textContent = address;
                document.getElementById('display-meter').textContent = meter;
                
                // 授权状态
                const isAuthorized = Math.random() > 0.3;
                const authStatus = document.getElementById('display-auth-status');
                authStatus.textContent = isAuthorized ? translations[currentLang].authorized : translations[currentLang].unauthorized;
                authStatus.className = isAuthorized ? 'font-medium text-sm text-success' : 'font-medium text-sm text-warning';
                
                // 显示签名
                const signatureContainer = document.getElementById('display-signature-container');
                if (hasSignature) {
                    const img = document.createElement('img');
                    img.src = signaturePad.toDataURL('image/png');
                    img.className = 'w-full h-auto max-h-20 object-contain';
                    signatureContainer.innerHTML = '';
                    signatureContainer.appendChild(img);
                } else {
                    signatureContainer.innerHTML = '<span class="text-tertiary">--</span>';
                }
                
                // 切换页面
                formPage.classList.add('hidden');
                successPage.classList.remove('hidden');
                submitBtnContainer.classList.add('hidden');
            });
            
            // 编辑按钮
            editBtn.addEventListener('click', function() {
                successPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
            });
        }

        // 初始化查询功能
        function initQuery() {
            const queryBtn = document.getElementById('query-btn');
            const backBtn = document.getElementById('back-btn');
            const doQueryBtn = document.getElementById('do-query-btn');
            const formPage = document.getElementById('form-page');
            const queryPage = document.getElementById('query-page');
            const successPage = document.getElementById('success-page');
            const submitBtnContainer = document.getElementById('submit-btn-container');
            const queryResult = document.getElementById('query-result');
            const noDataMessage = document.getElementById('no-data-message');
            const editQueryBtn = document.getElementById('edit-query-btn');
            const queryFormBackBtn = document.getElementById('query-form-back-btn');
            
            let queryToggle = false;
            let queryResultData = null;
            
            queryBtn.addEventListener('click', function() {
                formPage.classList.add('hidden');
                successPage.classList.add('hidden');
                queryPage.classList.remove('hidden');
                submitBtnContainer.classList.add('hidden');
                queryResult.classList.add('hidden');
                noDataMessage.classList.add('hidden');
            });
            
            backBtn.addEventListener('click', function() {
                queryPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
            });
            
            // 查询条件卡片的返回按钮 - 返回到表单页面
            if (queryFormBackBtn) {
                queryFormBackBtn.addEventListener('click', function() {
                    queryPage.classList.add('hidden');
                    formPage.classList.remove('hidden');
                    submitBtnContainer.classList.remove('hidden');
                });
            }
            
            doQueryBtn.addEventListener('click', function() {
                const brand = document.getElementById('query-brand').value;
                const account = document.getElementById('query-account-input').value;
                
                if (!brand || !account) {
                    showStatusMessage('请填写完整信息', 'error');
                    return;
                }
                
                // 按顺序循环切换查询结果场景（与桌面版保持一致）
                const scenarios = ['two_records', 'authorized', 'authorizing', 'exited', 'fail'];
                
                // 获取或初始化场景索引
                if (!window.queryScenarioIndex) {
                    window.queryScenarioIndex = 0;
                }
                
                // 获取当前场景
                const scenario = scenarios[window.queryScenarioIndex];
                
                // 更新场景索引
                window.queryScenarioIndex = (window.queryScenarioIndex + 1) % scenarios.length;
                
                if (scenario === 'fail') {
                    // 查询失败
                    queryResult.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                } else {
                    const resultContent = document.getElementById('query-result-content');
                    const brandDisplay = document.getElementById('query-brand-display').textContent;
                    
                    if (scenario === 'two_records') {
                        // 查询成功 - 显示两条记录（一个已授权，一个授权中）
                        const authorizedDevice = {
                            sn: 'SN20231125',
                            submitTime: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US'),
                            isAuthorized: true
                        };
                        
                        const authorizingDevice = {
                            sn: 'SN20241208',
                            submitTime: new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US'),
                            isAuthorized: false
                        };
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: authorizingDevice.sn,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString()
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 2 条记录' : 'Found 2 records'}
                            </div>
                            
                            <!-- 记录1 - 已授权设备 -->
                            <div class="bg-light/70 rounded-xl p-3 mb-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备 1' : 'Device 1'}</span>
                                    <span class="px-2 py-0.5 bg-success/10 text-success text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorized || '已授权'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">品牌:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">账号:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备SN:</span>
                                        <span class="font-medium">${authorizedDevice.sn}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备地址:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">提交时间:</span>
                                        <span class="font-medium">${authorizedDevice.submitTime}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 记录2 - 授权中设备 -->
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备 2' : 'Device 2'}</span>
                                    <span class="px-2 py-0.5 bg-warning/10 text-warning text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorizing || '授权中'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">品牌:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">账号:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备SN:</span>
                                        <span class="font-medium">${authorizingDevice.sn}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备地址:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">提交时间:</span>
                                        <span class="font-medium">${authorizingDevice.submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_btn || '编辑';
                        
                    } else if (scenario === 'authorized') {
                        // 查询成功 - 单条已授权记录
                        const deviceSN = 'SN2024' + Math.floor(Math.random() * 10000);
                        const submitTime = new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: deviceSN,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString(),
                            isAuthorized: true
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-success/10 text-success text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorized || '已授权'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">品牌:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">账号:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备SN:</span>
                                        <span class="font-medium">${deviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备地址:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">提交时间:</span>
                                        <span class="font-medium">${submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_btn || '编辑';
                        
                    } else if (scenario === 'authorizing') {
                        // 查询成功 - 单条授权中记录
                        const deviceSN = 'SN2024' + Math.floor(Math.random() * 10000);
                        const submitTime = new Date().toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: deviceSN,
                            address: currentLang === 'zh' ? '悉尼, 新南威尔士州, 澳大利亚' : 'Sydney, NSW, Australia',
                            meter: Math.floor(Math.random() * 100000000).toString(),
                            isAuthorized: false
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-warning/10 text-warning text-xs rounded-full font-medium">
                                        ${translations[currentLang].authorizing || '授权中'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">品牌:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">账号:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备SN:</span>
                                        <span class="font-medium">${deviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备地址:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '墨尔本, 维多利亚州' : 'Melbourne, VIC'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">提交时间:</span>
                                        <span class="font-medium">${submitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = translations[currentLang].edit_btn || '编辑';
                        
                    } else if (scenario === 'exited') {
                        // 查询成功 - 单条已退出记录
                        const exitedDeviceSN = 'SN2023' + Math.floor(1000 + Math.random() * 9000);
                        const exitedSubmitTime = new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                        
                        queryResultData = {
                            brand: brand,
                            brandDisplay: brandDisplay,
                            account: account,
                            sn: exitedDeviceSN,
                            address: currentLang === 'zh' ? '布里斯班, 昆士兰州, 澳大利亚' : 'Brisbane, QLD, Australia',
                            meter: Math.floor(10000000 + Math.random() * 90000000).toString(),
                            isExited: true
                        };
                        
                        resultContent.innerHTML = `
                            <div class="text-sm text-tertiary mb-3">
                                ${currentLang === 'zh' ? '共找到 1 条记录' : 'Found 1 record'}
                            </div>
                            <div class="bg-light/70 rounded-xl p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="font-semibold text-sm">${currentLang === 'zh' ? '设备信息' : 'Device Info'}</span>
                                    <span class="px-2 py-0.5 bg-danger/10 text-danger text-xs rounded-full font-medium">
                                        ${translations[currentLang].exited || '已退出'}
                                    </span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">品牌:</span>
                                        <span class="font-medium">${brandDisplay}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">账号:</span>
                                        <span class="font-medium">${account}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备SN:</span>
                                        <span class="font-medium">${exitedDeviceSN}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">设备地址:</span>
                                        <span class="font-medium text-right max-w-[60%]">${currentLang === 'zh' ? '布里斯班, 昆士兰州' : 'Brisbane, QLD'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-tertiary">提交时间:</span>
                                        <span class="font-medium">${exitedSubmitTime}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        editQueryBtn.textContent = currentLang === 'zh' ? '重新授权' : 'Re-authorize';
                    }
                    
                    queryResult.classList.remove('hidden');
                    noDataMessage.classList.add('hidden');
                }
            });
            
            
            editQueryBtn.addEventListener('click', function() {
                if (queryResultData) {
                    // 填充表单数据
                    document.getElementById('brand').value = queryResultData.brand;
                    document.getElementById('brand-display').textContent = queryResultData.brandDisplay;
                    document.getElementById('brand-display').classList.remove('text-tertiary');
                    document.getElementById('brand-display').classList.add('text-secondary');
                    
                    document.getElementById('user-account').value = queryResultData.account;
                    document.getElementById('device-sn').value = queryResultData.sn;
                    document.getElementById('device-address').value = queryResultData.address;
                    document.getElementById('meter-number').value = queryResultData.meter;
                    
                    showStatusMessage(translations[currentLang].edit_message || '您现在可以修改信息', 'info');
                }
                
                queryPage.classList.add('hidden');
                formPage.classList.remove('hidden');
                submitBtnContainer.classList.remove('hidden');
            });
        }

        // 初始化扫码功能
        function initScanner() {
            const scanBtn = document.getElementById('scan-sn-btn');
            const deviceSnInput = document.getElementById('device-sn');
            
            scanBtn.addEventListener('click', async function() {
                // 检查是否支持相机API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showStatusMessage('您的设备不支持相机功能', 'error');
                    return;
                }
                
                // 创建扫码界面
                createScannerUI();
            });
            
            function createScannerUI() {
                // 创建全屏扫码界面
                const scannerOverlay = document.createElement('div');
                scannerOverlay.className = 'fixed inset-0 bg-black z-50';
                scannerOverlay.innerHTML = `
                    <div class="relative w-full h-full">
                        <video id="scanner-video" class="w-full h-full object-cover"></video>
                        
                        <!-- 扫码框 -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="relative">
                                <div class="w-64 h-64 border-2 border-white rounded-2xl">
                                    <div class="absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-primary rounded-tl-xl"></div>
                                    <div class="absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-primary rounded-tr-xl"></div>
                                    <div class="absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-primary rounded-bl-xl"></div>
                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-primary rounded-br-xl"></div>
                                </div>
                                <div class="absolute w-full h-0.5 bg-primary top-1/2 transform -translate-y-1/2 animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- 顶部栏 -->
                        <div class="absolute top-0 left-0 right-0 safe-top bg-gradient-to-b from-black/70 to-transparent p-4">
                            <div class="flex justify-between items-center">
                                <button id="close-scanner" class="text-white p-2">
                                    <i class="fa fa-arrow-left text-2xl"></i>
                                </button>
                                <span class="text-white font-medium">扫描设备SN码</span>
                                <button id="toggle-flash" class="text-white p-2">
                                    <i class="fa fa-bolt text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 底部提示 -->
                        <div class="absolute bottom-0 left-0 right-0 safe-bottom bg-gradient-to-t from-black/70 to-transparent p-6">
                            <p class="text-white text-center mb-4">将二维码放入框内，即可自动扫描</p>
                            <button id="manual-input-scanner" class="w-full py-3 bg-white/20 backdrop-blur-md text-white rounded-xl border border-white/30">
                                手动输入
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(scannerOverlay);
                
                // 启动相机
                startCamera();
                
                // 关闭扫码
                document.getElementById('close-scanner').addEventListener('click', function() {
                    stopCamera();
                    scannerOverlay.remove();
                });
                
                // 手动输入
                document.getElementById('manual-input-scanner').addEventListener('click', function() {
                    stopCamera();
                    scannerOverlay.remove();
                    deviceSnInput.focus();
                });
                
                // 闪光灯开关
                let flashOn = false;
                document.getElementById('toggle-flash').addEventListener('click', function() {
                    flashOn = !flashOn;
                    this.classList.toggle('text-yellow-400');
                    toggleFlash(flashOn);
                });
            }
            
            let stream = null;
            let videoTrack = null;
            
            async function startCamera() {
                try {
                    const video = document.getElementById('scanner-video');
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment', // 使用后置摄像头
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    video.srcObject = stream;
                    videoTrack = stream.getVideoTracks()[0];
                    
                    // 模拟扫码成功（实际项目中需要集成真实的二维码识别库）
                    setTimeout(() => {
                        simulateScanSuccess();
                    }, 3000);
                    
                } catch (error) {
                    console.error('相机启动失败:', error);
                    showStatusMessage('无法启动相机', 'error');
                    document.querySelector('.fixed.inset-0').remove();
                }
            }
            
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
            
            function toggleFlash(on) {
                if (videoTrack && videoTrack.getCapabilities) {
                    const capabilities = videoTrack.getCapabilities();
                    if (capabilities.torch) {
                        videoTrack.applyConstraints({
                            advanced: [{ torch: on }]
                        });
                    }
                }
            }
            
            function simulateScanSuccess() {
                // 生成模拟的SN码
                const mockSN = 'SN' + Date.now().toString().slice(-10);
                deviceSnInput.value = mockSN;
                
                // 播放成功提示
                showStatusMessage('扫码成功！', 'success');
                
                // 关闭扫码界面
                stopCamera();
                const scannerOverlay = document.querySelector('.fixed.inset-0');
                if (scannerOverlay) {
                    scannerOverlay.remove();
                }
            }
        }

        // 初始化品牌选择
        function initBrandSelector() {
            const brandSelectBtn = document.getElementById('brand-select-btn');
            const queryBrandSelectBtn = document.getElementById('query-brand-select-btn');
            const brandModal = document.getElementById('brand-modal');
            const closeBrandBtn = document.getElementById('close-brand-btn');
            const brandOptions = document.querySelectorAll('.brand-option');
            
            let currentTarget = 'form'; // 'form' 或 'query'
            
            // 打开品牌选择模态框 - 表单页面
            if (brandSelectBtn) {
                brandSelectBtn.addEventListener('click', function() {
                    currentTarget = 'form';
                    brandModal.classList.remove('hidden');
                    const brandInput = document.getElementById('brand');
                    updateBrandChecks(brandInput.value);
                });
            }
            
            // 打开品牌选择模态框 - 查询页面
            if (queryBrandSelectBtn) {
                queryBrandSelectBtn.addEventListener('click', function() {
                    currentTarget = 'query';
                    brandModal.classList.remove('hidden');
                    const queryBrandInput = document.getElementById('query-brand');
                    updateBrandChecks(queryBrandInput.value);
                });
            }
            
            // 关闭品牌选择模态框
            function closeBrandModal() {
                brandModal.classList.add('hidden');
            }
            
            closeBrandBtn.addEventListener('click', closeBrandModal);
            brandModal.addEventListener('click', function(e) {
                if (e.target === brandModal) closeBrandModal();
            });
            
            // 选择品牌
            brandOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const displayText = this.querySelector('.text-base').textContent;
                    
                    // 根据当前目标更新相应的输入和显示
                    if (currentTarget === 'form') {
                        const brandInput = document.getElementById('brand');
                        const brandDisplay = document.getElementById('brand-display');
                        
                        brandInput.value = value;
                        brandDisplay.textContent = displayText;
                        brandDisplay.classList.remove('text-tertiary');
                        brandDisplay.classList.add('text-secondary');
                    } else {
                        const queryBrandInput = document.getElementById('query-brand');
                        const queryBrandDisplay = document.getElementById('query-brand-display');
                        
                        queryBrandInput.value = value;
                        queryBrandDisplay.textContent = displayText;
                        queryBrandDisplay.classList.remove('text-tertiary');
                        queryBrandDisplay.classList.add('text-secondary');
                    }
                    
                    // 更新勾选状态
                    updateBrandChecks(value);
                    
                    // 关闭模态框
                    setTimeout(closeBrandModal, 200);
                });
            });
            
            // 更新勾选状态
            function updateBrandChecks(selectedValue) {
                document.querySelectorAll('.brand-check').forEach(check => {
                    check.classList.add('hidden');
                });
                
                if (selectedValue) {
                    const selectedOption = document.querySelector(`.brand-option[data-value="${selectedValue}"]`);
                    if (selectedOption) {
                        selectedOption.querySelector('.brand-check').classList.remove('hidden');
                    }
                }
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initSignaturePad();
            initLocationFeatures();
            initPrivacy();
            initLanguageSelector();
            initBrandSelector();
            initFormSubmit();
            initQuery();
            initScanner();
            
            // 防止iOS橡皮筋效果
            document.body.addEventListener('touchmove', function(e) {
                if (e.target.closest('.overflow-y-auto, .hide-scrollbar')) return;
                if (document.body.scrollTop === 0 && e.touches[0].clientY > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>
</html>