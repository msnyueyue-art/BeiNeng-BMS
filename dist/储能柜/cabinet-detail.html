<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚¨èƒ½æŸœè¯¦æƒ… - å‚¨èƒ½æŸœç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .detail-container {
            display: flex;
            height: calc(100vh - 60px);
            background: #f5f5f5;
        }
        
        .cabinet-3d-container {
            flex: 0 0 35%;
            position: relative;
            background: #e5e5e5;
        }
        
        .component-annotations {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .annotation {
            position: absolute;
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: auto;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .annotation:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        
        .annotation-line {
            position: absolute;
            background: #ffffff;
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
        
        .data-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.08);
        }
        
        [data-theme="dark"] .data-panel {
            background: #1e293b;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* é—ªçƒæ ‡è®°ç‚¹æ ·å¼ */
        .blinking-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 3px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            animation: blink 1.5s infinite;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .blinking-marker::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border: 2px solid rgba(59, 130, 246, 0.6);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .marker-line {
            position: absolute;
            background: #10b981;
            height: 1px;
            transform-origin: left center;
            z-index: 15;
        }

        .marker-label {
            position: absolute;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 16;
        }
        
        
        
        .cabinet-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .cabinet-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #f59e0b;
        }
        
        .status-dot.fault {
            background: #ef4444;
        }
        
        .data-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #374151;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .settings-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .component-tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: thin;
            background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
            padding: 8px 16px;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        
        .component-tab {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 8px;
            position: relative;
            letter-spacing: 0.3px;
        }
        
        .component-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.08);
            border-color: #3b82f6;
            transform: translateY(-1px);
        }
        
        .component-tab.active {
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .component-tab.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #2563eb;
        }
        
        [data-theme="dark"] .component-tabs {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom-color: rgba(255,255,255,0.06);
        }
        
        [data-theme="dark"] .component-tab {
            color: #94a3b8;
            border-color: #334155;
        }
        
        [data-theme="dark"] .component-tab:hover {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            border-color: #60a5fa;
        }
        
        [data-theme="dark"] .component-tab.active {
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: transparent;
        }
        
        .data-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 0 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        
        [data-theme="dark"] .data-tabs {
            background: #1e293b;
            border-bottom-color: rgba(255,255,255,0.06);
        }
        
        .data-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .data-tab:hover {
            color: #334155;
        }
        
        .data-tab.active {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .data-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -2px 8px rgba(59, 130, 246, 0.3);
        }
        
        [data-theme="dark"] .data-tab {
            color: #94a3b8;
        }
        
        [data-theme="dark"] .data-tab:hover {
            color: #cbd5e1;
        }
        
        [data-theme="dark"] .data-tab.active {
            color: #60a5fa;
        }
        
        .data-content {
            padding: 24px;
        }
        
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
        }
        
        /* ç³»ç»Ÿä¿¡æ¯å¡ç‰‡ä¸“ç”¨æ ·å¼ */
        .system-info .metric-card {
            height: 123px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .metric-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        
        .metric-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .metric-status.good {
            color: #10b981;
        }
        
        .metric-status.warning {
            color: #f59e0b;
        }
        
        .metric-status.critical {
            color: #ef4444;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .chart-wrapper {
            height: 200px;
        }
        
        .alert-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .alert-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-item {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 4px;
        }
        
        .time-range-btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-range-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .time-range-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* æ‰‹åŠ¨æ¨¡å¼æŒ‰é’®æ ·å¼ */
        .manual-mode-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .manual-mode-btn:active {
            transform: translateY(0);
        }
        
        .manual-mode-btn:disabled {
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="header-left">
            <button class="menu-trigger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <img src="logo.png" alt="AlwaysControl Technology" />
            </div>
        </div>
        
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-moon" id="headerThemeIcon"></i>
            </button>
            <button class="lang-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€">
                <i class="fas fa-globe"></i>
            </button>
            <a href="alarm-management.html" class="notification-badge" style="cursor: pointer; text-decoration: none; display: inline-block;">
                <i class="fas fa-bell" style="font-size: 18px; color: var(--text-secondary);"></i>
            </a>
            <div class="user-menu" onclick="logout()">
                <div class="avatar">A</div>
                <span class="user-name" id="userName">ç®¡ç†å‘˜</span>
            </div>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
        <div class="menu">
            <a href="dashboard.html" class="menu-item" data-menu="dashboard">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ“Š</span>
                <span id="menuDashboard">ä»ªè¡¨ç›˜</span>
            </a>
            <a href="site1.html" class="menu-item" data-menu="site1">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ¢</span>
                <span>ç«™ç‚¹ç®¡ç†</span>
            </a>
            <a href="devices.html" class="menu-item active" data-menu="devices">
                <span style="font-size: 18px; margin-right: 12px;">âš™ï¸</span>
                <span id="menuDevices">è®¾å¤‡ç®¡ç†</span>
            </a>
            <a href="alarm-management.html" class="menu-item" data-menu="alarm-management">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ””</span>
                <span id="menuAlarms">å‘Šè­¦ç®¡ç†</span>
            </a>
            <a href="rule-engine.html" class="menu-item" data-menu="rule-engine" style="display: none;">
                <i class="fas fa-code-branch"></i>
                <span>è§„åˆ™å¼•æ“</span>
            </a>
            <div class="menu-item-group">
                <a href="javascript:void(0)" class="menu-item" data-menu="settings" onclick="toggleSubmenu(this)">
                    <span style="font-size: 18px; margin-right: 12px;">âš™ï¸</span>
                    <span id="menuSettings">ç³»ç»Ÿç®¡ç†</span>
                    <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                </a>
                <div class="submenu" style="display: none;">
                    <a href="menus.html" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ“‹</span>
                        <span>èœå•ç®¡ç†</span>
                    </a>
                    <a href="roles.html" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ‘¥</span>
                        <span>è§’è‰²ç®¡ç†</span>
                    </a>
                    <a href="personnel.html" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ‘¤</span>
                        <span>äººå‘˜ç®¡ç†</span>
                    </a>
                    <a href="logs.html" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ“„</span>
                        <span>æ—¥å¿—ç®¡ç†</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="mainContent" style="padding: 0;">
        <div class="detail-container">
            <!-- 3Dæ¨¡å‹å®¹å™¨ -->
            <div class="cabinet-3d-container" style="position: relative;">
                <!-- è®¾å¤‡æ§åˆ¶æŒ‰é’® - å·²éšè— -->
                <div style="position: absolute; top: 80px; right: 0; z-index: 100; display: none;">
                    <button onclick="openDeviceControlPanel()" style="
                        writing-mode: vertical-rl;
                        text-orientation: upright;
                        padding: 15px 8px;
                        background: linear-gradient(135deg, #3562E3 0%, #4f46e5 100%);
                        color: white;
                        border: none;
                        border-radius: 8px 0 0 8px;
                        cursor: pointer;
                        transition: all 0.3s;
                        font-size: 14px;
                        font-weight: 500;
                        box-shadow: -4px 0 12px rgba(53, 98, 227, 0.2);
                        letter-spacing: 3px;
                        height: auto;
                        min-height: 90px;
                        width: 32px;
                        line-height: 1;
                        white-space: nowrap;
                    " onmouseover="this.style.transform='translateX(-3px)'; this.style.boxShadow='-6px 0 16px rgba(53, 98, 227, 0.3)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='-4px 0 12px rgba(53, 98, 227, 0.2)'">
                        è®¾å¤‡æ§åˆ¶
                    </button>
                </div>
                
                <!-- å‚¨èƒ½æŸœå›¾ç‰‡å±•ç¤º -->
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1;">
                    <div style="position: relative; display: inline-block;">
                        <img src="æŸœå­æ‰“å¼€.png" alt="å‚¨èƒ½æŸœå†…éƒ¨ç»“æ„" style="max-width: 90%; max-height: 70vh; object-fit: contain;">
                        
                        <!-- ç»„ä»¶æ ‡è®°ç‚¹ -->
                        <!-- EMSæ§åˆ¶å™¨ (é¡¶éƒ¨ç™½è‰²æ§åˆ¶ç›’) -->
                        <div class="blinking-marker" style="top: 15%; left: 48%;" onclick="switchComponent('ems')"></div>
                        <div class="marker-label" style="top: 13%; left: 56%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="emsMarkerLabel" onclick="switchComponent('ems')">
                            <span style="font-weight: 500; color: #333333;">EMS</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="emsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="emsMarkerStatusText">åœ¨çº¿</span>
                            </div>
                        </div>
                        
                        <!-- PCSé€†å˜å™¨ (ä¸­é—´é»‘è‰²å¤§æ¨¡å—) -->
                        <div class="blinking-marker" style="top: 35%; left: 20%;" onclick="switchComponent('pcs')"></div>
                        <div class="marker-label" style="top: 33%; left: -22%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #ef4444; cursor: pointer;" id="pcsMarkerLabel" onclick="switchComponent('pcs')">
                            <span style="font-weight: 500; color: #333333;">é€†å˜å™¨</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot fault" id="pcsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #ef4444;" id="pcsMarkerStatusText">å¼‚å¸¸</span>
                            </div>
                        </div>
                        
                        <!-- BMSç³»ç»Ÿ (PCSä¸‹æ–¹çš„é»‘è‰²æ¨¡å—) -->
                        <div class="blinking-marker" style="top: 45%; left: 45%;" onclick="switchComponent('bms')"></div>
                        <div class="marker-label" style="top: 43%; left: 3%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="bmsMarkerLabel" onclick="switchComponent('bms')">
                            <span style="font-weight: 500; color: #333333;">BMS</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="bmsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="bmsMarkerStatusText">åœ¨çº¿</span>
                            </div>
                        </div>
                        
                        <!-- ç”µè¡¨ (æ–°å¢ï¼Œæ”¾åœ¨åˆé€‚ä½ç½®) -->
                        <div class="blinking-marker" style="top: 21%; left: 25%;" onclick="switchComponent('meter')"></div>
                        <div class="marker-label" style="top: 17%; left: -17%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #f59e0b; cursor: pointer;" id="meterMarkerLabel" onclick="switchComponent('meter')">
                            <span style="font-weight: 500; color: #333333;">ç”µè¡¨</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot offline" id="meterMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #f59e0b;" id="meterMarkerStatusText">ç¦»çº¿</span>
                            </div>
                        </div>
                        
                        <!-- æ¸©åº¦ç›‘æµ‹ (æ©™è‰²çº¿ç¼†åŒºåŸŸ) -->
                        <div class="blinking-marker" style="top: 38%; left: 71%;" onclick="switchComponent('thermal')"></div>
                        <div class="marker-label" style="top: 36%; left: 79%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="thermalMarkerLabel" onclick="switchComponent('thermal')">
                            <span style="font-weight: 500; color: #333333;">æ¸©åº¦</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="thermalMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="thermalMarkerStatusText">åœ¨çº¿</span>
                            </div>
                        </div>
                        
                        <!-- æ¶ˆé˜²ç³»ç»Ÿ (åº•éƒ¨çº¢è‰²ç®¡é“) -->
                        <div class="blinking-marker" style="top: 85%; left: 50%;" onclick="switchComponent('fire')"></div>
                        <div class="marker-label" style="top: 83%; left: 58%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="fireMarkerLabel" onclick="switchComponent('fire')">
                            <span style="font-weight: 500; color: #333333;">æ¶ˆé˜²</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="fireMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="fireMarkerStatusText">åœ¨çº¿</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; align-items: center; gap: 16px;">
                    <button class="back-button" onclick="goBack()" style="position: static; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-arrow-left"></i>
                        è¿”å›
                    </button>
                    <div style="display: flex; align-items: center; gap: 16px; background: rgba(255, 255, 255, 0.95); padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h2 id="cabinetNameTop" style="margin: 0; font-size: 18px; font-weight: 600; color: #333;">å‚¨èƒ½æŸœ 001</h2>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span class="status-dot online" id="statusDotTop"></span>
                            <span id="statusTextTop" style="font-size: 14px; color: #666;">åœ¨çº¿</span>
                        </div>
                        <div id="operationStatusTop" style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #666; font-weight: 500;">
                            <i class="fas fa-bolt" style="color: #10b981;"></i>
                            å……ç”µä¸­
                        </div>
                    </div>
                </div>
                
                <!-- å½“å‰å‘Šè­¦ -->
                <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 320px; z-index: 100;">
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 10px 14px; box-shadow: 0 4px 12px rgba(252, 211, 77, 0.2);">
                        <h4 style="font-size: 12px; color: #92400e; margin: 0 0 6px 0; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 11px;"></i>
                            å½“å‰å‘Šè­¦
                        </h4>
                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #78350f; line-height: 1.4;">
                            <li style="margin-bottom: 3px;">ç”µæ± æ¨¡ç»„3æ¸©åº¦åé«˜ (32.5Â°C)</li>
                            <li>BMSé€šä¿¡å»¶è¿Ÿ (150ms)</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®é¢æ¿ -->
            <div class="data-panel" style="position: relative;">
                
                <!-- ç»„ä»¶é€‰æ‹©æ ‡ç­¾é¡µ -->
                <div class="component-tabs">
                    <button class="component-tab active" onclick="switchComponent('overall')">æ•´æœº</button>
                    <button class="component-tab" onclick="switchComponent('ems')">EMS</button>
                    <button class="component-tab" onclick="switchComponent('pcs')">é€†å˜å™¨</button>
                    <button class="component-tab" onclick="switchComponent('bms')">BMS</button>
                    <button class="component-tab" onclick="switchComponent('meter')">ç”µè¡¨</button>
                    <button class="component-tab" onclick="switchComponent('thermal')">æ¸©åº¦</button>
                    <button class="component-tab" onclick="switchComponent('fire')">æ¶ˆé˜²</button>
                </div>
                
                <!-- æ•°æ®æ ‡ç­¾é¡µ -->
                <div class="data-tabs">
                    <button class="data-tab active" onclick="switchTab('realtime')">å®æ—¶æ•°æ®</button>
                    <button class="data-tab" onclick="switchTab('history')">å†å²æ•°æ®</button>
                    <button class="data-tab" onclick="switchTab('control')">æ§åˆ¶</button>
                </div>
                
                <!-- æ•°æ®å†…å®¹ -->
                <div class="data-content" id="dataContent">
                    <!-- å®æ—¶æ•°æ® -->
                    <div id="realtimeData">
                        <!-- æ ¸å¿ƒè¿è¡Œå‚æ•° -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="font-size: 14px; color: var(--text-secondary); margin: 0;">æ ¸å¿ƒè¿è¡Œå‚æ•°</h4>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">SOC</div>
                                    <div class="metric-value">
                                        <span id="soc">85.6</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="socStatus">ç”µé‡å……è¶³</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">SOH</div>
                                    <div class="metric-value">
                                        <span id="soh">96.8</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="sohStatus">å¥åº·çŠ¶æ€è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="temperature">28.5</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div class="metric-status good" id="tempStatus">æ¸©åº¦æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å……æ”¾ç”µåŠŸç‡</div>
                                    <div class="metric-value">
                                        <span id="power" style="color: #10b981;">+118.2</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div class="metric-status" id="powerStatus">å……ç”µä¸­</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¿è¡Œç»Ÿè®¡ -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">è¿è¡Œç»Ÿè®¡</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ä»Šæ—¥å……ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="todayCharge">856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ä»Šæ—¥æ”¾ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="todayDischarge">742.6</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å……ç”µæˆæœ¬</div>
                                    <div class="metric-value">
                                        <span id="chargingCost">Â¥685.2</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ”¾ç”µæ”¶ç›Š</div>
                                    <div class="metric-value">
                                        <span id="dischargingRevenue">Â¥1,126.8</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å†å²æ•°æ® -->
                    <div id="historyData" style="display: none;">
                        <!-- è®¾ç½®æŒ‰é’®å’Œæ—¶é—´èŒƒå›´é€‰æ‹© -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="time-range-btn active" onclick="changeTimeRange('24h')">24å°æ—¶</button>
                                <button class="time-range-btn" onclick="changeTimeRange('7d')">7å¤©</button>
                                <button class="time-range-btn" onclick="changeTimeRange('30d')">30å¤©</button>
                                <button class="time-range-btn" onclick="changeTimeRange('1y')">1å¹´</button>
                            </div>
                            <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0;">
                                <i class="fas fa-cog"></i>
                                <span>å­—æ®µè®¾ç½®</span>
                            </button>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">åŠŸç‡æ›²çº¿</div>
                            <div class="chart-wrapper">
                                <canvas id="powerHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">SOCä¸å……æ”¾ç”µçŠ¶æ€</div>
                            <div class="chart-wrapper">
                                <canvas id="socHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">ç”µæ± æ¸©åº¦åˆ†å¸ƒ</div>
                            <div class="chart-wrapper">
                                <canvas id="tempHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">ç”µå‹ä¸€è‡´æ€§</div>
                            <div class="chart-wrapper">
                                <canvas id="voltageConsistencyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">å……æ”¾ç”µæ•ˆç‡åˆ†æ</div>
                            <div class="chart-wrapper">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">å³°è°·å¥—åˆ©åˆ†æ</div>
                            <div class="chart-wrapper">
                                <canvas id="arbitrageChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">å¥åº·åº¦è¶‹åŠ¿</div>
                            <div class="chart-wrapper">
                                <canvas id="sohTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- ç´¯è®¡ç»Ÿè®¡ -->
                        <div class="statistics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">ç´¯è®¡ç»Ÿè®¡</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">ç´¯è®¡å……ç”µé‡</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">186,524 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">ç´¯è®¡æ”¾ç”µé‡</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">178,956 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">ç­‰æ•ˆå¾ªç¯æ¬¡æ•°</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">1,892 <span style="font-size: 12px; font-weight: 400;">æ¬¡</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">å¹³å‡æ•ˆç‡</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">95.8 <span style="font-size: 12px; font-weight: 400;">%</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">ç´¯è®¡æ”¶ç›Š</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px; color: #10b981;">Â¥124,658</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">å¹³å‡æ—¥æ”¶ç›Š</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">Â¥266 <span style="font-size: 12px; font-weight: 400;">/å¤©</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¿ç»´å»ºè®® -->
                        <div class="maintenance-section" style="margin-top: 20px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb"></i>
                                è¿ç»´å»ºè®®
                            </h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">
                                <li style="margin-bottom: 6px;">å»ºè®®åœ¨ç”µä»·ä½è°·æœŸï¼ˆ23:00-07:00ï¼‰å¢åŠ å……ç”µåŠŸç‡</li>
                                <li style="margin-bottom: 6px;">å½“å‰æ¸©åº¦æ§åˆ¶è‰¯å¥½ï¼Œç»§ç»­ä¿æŒç°æœ‰çƒ­ç®¡ç†ç­–ç•¥</li>
                                <li style="margin-bottom: 6px;">ç”µæ± å¥åº·åº¦ä¿æŒåœ¨95%ä»¥ä¸Šï¼Œå»ºè®®æ¯æœˆè¿›è¡Œä¸€æ¬¡æ·±åº¦å……æ”¾ç”µå¾ªç¯</li>
                                <li>ä¸‹æ¬¡ç»´æŠ¤æ—¶é—´ï¼š2024å¹´2æœˆ15æ—¥</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- æ§åˆ¶é¢æ¿ -->
                    <div id="controlPanel" style="display: none;">
                        <div style="padding: 20px;">
                            <!-- é¡¶éƒ¨ç¼–è¾‘æŒ‰é’® -->
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <button id="editControlBtn" onclick="toggleControlEdit()" style="padding: 8px 20px; font-size: 14px; background: #3562E3; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-edit" style="font-size: 14px;"></i>ç¼–è¾‘
                                </button>
                            </div>
                            
                            <!-- æ§åˆ¶è¦æ±‚ -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <!-- è¿è¡Œæ¨¡å¼é€‰æ‹© -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">è¿è¡Œæ¨¡å¼</label>
                                    <div style="display: flex; gap: 20px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="mode" value="auto" checked onchange="changeMode('auto')">
                                            <span style="font-size: 14px;">è‡ªåŠ¨æ¨¡å¼</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="mode" value="manual" onchange="changeMode('manual')">
                                            <span style="font-size: 14px;">æ‰‹åŠ¨æ¨¡å¼</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- è‡ªåŠ¨æ¨¡å¼æ§åˆ¶ -->
                                <div id="autoControl" style="padding: 16px; background: #f8fafc; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <i class="fas fa-robot" style="color: #10b981; font-size: 20px;"></i>
                                        <div>
                                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">ç³»ç»Ÿæ ¹æ®ä¸‹æ–¹æ—¶é—´è½´è‡ªåŠ¨æ§åˆ¶å……æ”¾ç”µ</div>
                                        </div>
                                    </div>
                                    
                                    <!-- å³°è°·å¥—åˆ©æ—¶é—´è½´ -->
                                    <div style="margin-bottom: 16px;">
                                        <div style="position: relative; height: 60px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                                            <!-- æ—¶é—´åˆ»åº¦ -->
                                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex;">
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">0</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">2</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">4</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">6</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">8</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">10</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">12</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">14</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">16</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">18</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">20</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280;">22</div>
                                            </div>
                                            <!-- æ—¶é—´å—å®¹å™¨ -->
                                            <div id="timelineContainer" style="position: absolute; top: 20px; left: 0; right: 0; bottom: 0; display: flex;">
                                                <!-- 24ä¸ªæ—¶é—´å— -->
                                            </div>
                                        </div>
                                        
                                        <!-- å›¾ä¾‹ -->
                                        <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 13px;">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;"></div>
                                                <span>å³°å€¼æ—¶æ®µ</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #3b82f6; border-radius: 4px;"></div>
                                                <span>è°·å€¼æ—¶æ®µ</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #e5e7eb; border-radius: 4px;"></div>
                                                <span>å¹³ä»·æ—¶æ®µ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ‰‹åŠ¨æ¨¡å¼æ§åˆ¶ -->
                                <div id="manualControl" style="display: none;">
                                    <div id="manualButtons">
                                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                            <button class="manual-mode-btn" data-mode="charge" onclick="selectManualMode('charge')" 
                                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; 
                                                           background: var(--bg-primary); font-size: 14px; font-weight: 600; cursor: pointer; 
                                                           transition: all 0.2s;">
                                                <i class="fas fa-battery-three-quarters" style="margin-right: 8px;"></i>å……ç”µ
                                            </button>
                                            <button class="manual-mode-btn" data-mode="discharge" onclick="selectManualMode('discharge')"
                                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; 
                                                           background: var(--bg-primary); font-size: 14px; font-weight: 600; cursor: pointer; 
                                                           transition: all 0.2s;">
                                                <i class="fas fa-bolt" style="margin-right: 8px;"></i>æ”¾ç”µ
                                            </button>
                                        </div>
                                        
                                    </div>
                                    
                                    <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
                                    <div id="manualStatus" style="padding: 16px; background: #f8fafc; border-radius: 8px; text-align: center; display: none;">
                                        <div id="statusContent" style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                            <!-- åŠ¨æ€å†…å®¹ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <!-- ç”µæ± å‚æ•°è®¾ç½® -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">ç”µæ± å‚æ•°</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">å……ç”µåœæ­¢SOC (%)</label>
                                        <input type="number" value="95" min="0" max="100" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">å……ç”µåŠŸç‡ (kW)</label>
                                        <input type="number" value="250" min="0" max="500" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">æ”¾ç”µåœæ­¢SOC (%)</label>
                                        <input type="number" value="10" min="0" max="100" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">æ”¾ç”µåŠŸç‡ (kW)</label>
                                        <input type="number" value="250" min="0" max="500" class="form-input" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">å‡è¡¡æ§åˆ¶</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>ä¸»åŠ¨å‡è¡¡</option>
                                            <option>è¢«åŠ¨å‡è¡¡</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">é£æ‰‡æ§åˆ¶</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>è‡ªåŠ¨</option>
                                            <option>å¼€å¯</option>
                                            <option>å…³é—­</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">æ¸©åº¦ä¿æŠ¤</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>å¼€å¯</option>
                                            <option>å…³é—­</option>
                                        </select>
                                    </div>
                                    <div>
                                        <!-- é¢„ç•™ä½ç½®ï¼Œä¿æŒç½‘æ ¼å¸ƒå±€å¹³è¡¡ -->
                                    </div>
                                </div>
                            </div>

                            <!-- æ¶ˆé˜²æ§åˆ¶ -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">æ¶ˆé˜²æ§åˆ¶</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">ç­ç«å¯åŠ¨</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>è‡ªåŠ¨å¯åŠ¨</option>
                                            <option>æ‰‹åŠ¨å¯åŠ¨</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">ç­ç«å‰‚ç±»å‹</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>å…¨æ°Ÿå·±é…®</option>
                                            <option>ä¸ƒæ°Ÿä¸™çƒ·</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">å£°å…‰æŠ¥è­¦</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>å¯ç”¨</option>
                                            <option>ç¦ç”¨</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">ç´§æ€¥æ–­ç”µ</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>è‡ªåŠ¨</option>
                                            <option>æ‰‹åŠ¨</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">é€šé£æ§åˆ¶</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option>è‡ªåŠ¨æ§åˆ¶</option>
                                            <option>å¼ºåˆ¶å¼€å¯</option>
                                            <option>å¼ºåˆ¶å…³é—­</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åº•éƒ¨æŒ‰é’® -->
                            <div id="controlButtons" style="display: none; position: sticky; bottom: 0; background: white; padding: 16px 0; margin-top: 24px; border-top: 1px solid var(--border-color); text-align: center;">
                                <button onclick="cancelControlEdit()" style="padding: 10px 32px; margin-right: 16px; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-times" style="margin-right: 6px;"></i>å–æ¶ˆ
                                </button>
                                <button onclick="saveControlSettings()" style="padding: 10px 32px; background: #3562E3; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check" style="margin-right: 6px;"></i>ä¿å­˜
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- å­—æ®µè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="fieldSettingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalTitle" style="margin: 0; font-size: 18px; font-weight: 600;">å­—æ®µæ˜¾ç¤ºè®¾ç½®</h3>
                <button onclick="closeFieldSettings()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- æ¨¡æ€æ¡†å†…å®¹ -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div id="fieldSettingsContent">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å­—æ®µåˆ—è¡¨ -->
                </div>
            </div>
            
            <!-- æ¨¡æ€æ¡†åº•éƒ¨ -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="resetFieldSettings()" style="padding: 8px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                    é‡ç½®é»˜è®¤
                </button>
                <button onclick="saveFieldSettings()" style="padding: 8px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ä¿å­˜è®¾ç½®
                </button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Toggle submenu
        function toggleSubmenu(element) {
            element.classList.toggle('expanded');
            const submenu = element.nextElementSibling;
            if (submenu && submenu.classList.contains('submenu')) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // æ‰“å¼€è®¾å¤‡æ§åˆ¶é¢æ¿
        function openDeviceControlPanel() {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.id = 'deviceControlOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // åˆ›å»ºæ§åˆ¶é¢æ¿
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                width: 95%;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 12px 48px rgba(0,0,0,0.2);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; color: var(--text-primary); font-weight: 600;">è®¾å¤‡æ§åˆ¶</h3>
                    <button onclick="closeDeviceControlPanel()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <!-- å¯åŠ¨æŒ‰é’® -->
                    <button onclick="deviceControl('start')" style="padding: 12px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.2)'">
                        <i class="fas fa-play" style="font-size: 16px;"></i>
                        <span>å¯åŠ¨</span>
                    </button>
                    
                    <!-- åœæ­¢æŒ‰é’® -->
                    <button onclick="deviceControl('stop')" style="padding: 12px 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.2)'">
                        <i class="fas fa-stop" style="font-size: 16px;"></i>
                        <span>åœæ­¢</span>
                    </button>
                    
                    <!-- å¾…æœºæŒ‰é’® -->
                    <button onclick="deviceControl('standby')" style="padding: 12px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.2)'">
                        <i class="fas fa-pause" style="font-size: 16px;"></i>
                        <span>å¾…æœº</span>
                    </button>
                    
                    <!-- é‡å¯æŒ‰é’® -->
                    <button onclick="deviceControl('restart')" style="padding: 12px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'">
                        <i class="fas fa-redo" style="font-size: 16px;"></i>
                        <span>é‡å¯</span>
                    </button>
                    
                    <!-- ç´§æ€¥åœæœºæŒ‰é’® -->
                    <button onclick="deviceControl('emergency')" style="padding: 12px 16px; background: linear-gradient(135deg, #7c2d12 0%, #991b1b 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(124, 45, 18, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(124, 45, 18, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(124, 45, 18, 0.2)'">
                        <i class="fas fa-power-off" style="font-size: 16px;"></i>
                        <span>ç´§æ€¥åœæœº</span>
                    </button>
                    
                    <!-- å¤ä½æŒ‰é’® -->
                    <button onclick="deviceControl('reset')" style="padding: 12px 16px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(107, 114, 128, 0.2)'">
                        <i class="fas fa-sync-alt" style="font-size: 16px;"></i>
                        <span>å¤ä½</span>
                    </button>
                </div>
                
                <!-- OTAå‡çº§éƒ¨åˆ† -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cloud-download-alt" style="color: #3b82f6;"></i>
                        OTAå›ºä»¶å‡çº§
                    </h4>
                    
                    <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                            <div>
                                <span style="color: #6b7280;">å½“å‰ç‰ˆæœ¬ï¼š</span>
                                <span style="color: #1f2937; font-weight: 500;">V2.3.5</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">æœ€æ–°ç‰ˆæœ¬ï¼š</span>
                                <span style="color: #10b981; font-weight: 500;">V2.4.0</span>
                                <span style="background: #10b981; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">å¯æ›´æ–°</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">è®¾å¤‡å‹å·ï¼š</span>
                                <span style="color: #1f2937; font-weight: 500;">ESS-2500</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">æ›´æ–°æ—¶é—´ï¼š</span>
                                <span style="color: #1f2937; font-weight: 500;">2024-01-15</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: #92400e;">
                        <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                        æ›´æ–°è¯´æ˜ï¼šä¿®å¤BMSé€šä¿¡å»¶è¿Ÿé—®é¢˜ï¼Œä¼˜åŒ–å……æ”¾ç”µæ§åˆ¶ç®—æ³•ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="checkForUpdates()" style="flex: 1; padding: 12px 20px; background: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            <i class="fas fa-sync" style="margin-right: 6px;"></i>
                            æ£€æŸ¥æ›´æ–°
                        </button>
                        <button onclick="startOTAUpgrade()" style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 500; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'">
                            <i class="fas fa-download" style="margin-right: 6px;"></i>
                            å¼€å§‹å‡çº§
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                overlay.style.opacity = '1';
                panel.style.transform = 'scale(1)';
            }, 10);
            
            // ç‚¹å‡»é®ç½©å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeDeviceControlPanel();
                }
            });
        }
        
        // å…³é—­è®¾å¤‡æ§åˆ¶é¢æ¿
        function closeDeviceControlPanel() {
            const overlay = document.getElementById('deviceControlOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.querySelector('div').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            }
        }
        
        // æ£€æŸ¥æ›´æ–°
        function checkForUpdates() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-sync fa-spin"></i>
                æ­£åœ¨æ£€æŸ¥æ›´æ–°...
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.background = '#10b981';
                toast.innerHTML = `
                    <i class="fas fa-check"></i>
                    å‘ç°æ–°ç‰ˆæœ¬ V2.4.0 å¯ç”¨
                `;
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 2000);
            }, 1500);
        }
        
        // å¼€å§‹OTAå‡çº§
        function startOTAUpgrade() {
            if (!confirm('ç¡®å®šè¦å¼€å§‹å›ºä»¶å‡çº§å—ï¼Ÿ\nå‡çº§è¿‡ç¨‹ä¸­è®¾å¤‡å°†æš‚åœè¿è¡Œï¼Œè¯·ç¡®ä¿è®¾å¤‡å¤„äºå®‰å…¨çŠ¶æ€ã€‚')) {
                return;
            }
            
            // å…³é—­æ§åˆ¶é¢æ¿
            closeDeviceControlPanel();
            
            // åˆ›å»ºå‡çº§è¿›åº¦å¼¹çª—
            const progressOverlay = document.createElement('div');
            progressOverlay.id = 'otaProgressOverlay';
            progressOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const progressPanel = document.createElement('div');
            progressPanel.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 32px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            `;
            
            progressPanel.innerHTML = `
                <h3 style="margin: 0 0 24px 0; font-size: 18px; color: #1f2937; font-weight: 600; text-align: center;">
                    <i class="fas fa-cloud-download-alt" style="color: #3b82f6; margin-right: 8px;"></i>
                    å›ºä»¶å‡çº§ä¸­
                </h3>
                
                <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                        <span style="color: #6b7280;">å‡çº§è¿›åº¦</span>
                        <span id="otaProgress" style="color: #3b82f6; font-weight: 600;">0%</span>
                    </div>
                    <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="otaProgressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <div id="otaStatus" style="text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 20px;">
                    æ­£åœ¨ä¸‹è½½å›ºä»¶...
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 12px; color: #92400e;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>
                    è¯·å‹¿æ–­ç”µæˆ–å…³é—­è®¾å¤‡ï¼Œå‡çº§è¿‡ç¨‹å¤§çº¦éœ€è¦5-10åˆ†é’Ÿ
                </div>
            `;
            
            progressOverlay.appendChild(progressPanel);
            document.body.appendChild(progressOverlay);
            
            // æ¨¡æ‹Ÿå‡çº§è¿›åº¦
            let progress = 0;
            const updateInterval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                if (progress > 100) progress = 100;
                
                document.getElementById('otaProgress').textContent = Math.round(progress) + '%';
                document.getElementById('otaProgressBar').style.width = progress + '%';
                
                if (progress < 30) {
                    document.getElementById('otaStatus').textContent = 'æ­£åœ¨ä¸‹è½½å›ºä»¶...';
                } else if (progress < 60) {
                    document.getElementById('otaStatus').textContent = 'æ­£åœ¨éªŒè¯å›ºä»¶...';
                } else if (progress < 90) {
                    document.getElementById('otaStatus').textContent = 'æ­£åœ¨å®‰è£…å›ºä»¶...';
                } else {
                    document.getElementById('otaStatus').textContent = 'æ­£åœ¨é‡å¯è®¾å¤‡...';
                }
                
                if (progress >= 100) {
                    clearInterval(updateInterval);
                    setTimeout(() => {
                        progressPanel.innerHTML = `
                            <div style="text-align: center;">
                                <i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; margin-bottom: 16px;"></i>
                                <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #1f2937; font-weight: 600;">å‡çº§æˆåŠŸ</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-bottom: 24px;">å›ºä»¶å·²æˆåŠŸå‡çº§è‡³ V2.4.0</p>
                                <button onclick="closeOTAProgress()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    ç¡®å®š
                                </button>
                            </div>
                        `;
                    }, 1000);
                }
            }, 500);
        }
        
        // å…³é—­OTAè¿›åº¦çª—å£
        function closeOTAProgress() {
            const overlay = document.getElementById('otaProgressOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // è®¾å¤‡æ§åˆ¶å‡½æ•°
        function deviceControl(action) {
            const actionNames = {
                'start': 'å¯åŠ¨',
                'stop': 'åœæ­¢',
                'standby': 'å¾…æœº',
                'restart': 'é‡å¯', 
                'emergency': 'ç´§æ€¥åœæœº',
                'reset': 'å¤ä½'
            };
            
            const actionName = actionNames[action] || action;
            
            // ç‰¹æ®Šå¤„ç†ç´§æ€¥åœæœº - éœ€è¦ç¡®è®¤
            if (action === 'emergency') {
                if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ${actionName}æ“ä½œå—ï¼Ÿ\næ­¤æ“ä½œå°†ç«‹å³åœæ­¢è®¾å¤‡è¿è¡Œï¼Œå¯èƒ½ä¼šå½±å“æ­£åœ¨è¿›è¡Œçš„å·¥ä½œã€‚`)) {
                    return;
                }
            } else {
                // å…¶ä»–æ“ä½œçš„ç¡®è®¤
                if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ${actionName}æ“ä½œå—ï¼Ÿ`)) {
                    return;
                }
            }
            
            // å…³é—­æ§åˆ¶é¢æ¿
            closeDeviceControlPanel();
            
            // æ˜¾ç¤ºæ“ä½œè¿›åº¦æç¤º
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                æ­£åœ¨æ‰§è¡Œ${actionName}æ“ä½œ...
            `;
            
            document.body.appendChild(toast);
            
            // æ¨¡æ‹Ÿæ“ä½œå»¶è¿Ÿ
            setTimeout(() => {
                // æ›´æ–°æç¤ºä¸ºæˆåŠŸçŠ¶æ€
                toast.style.background = '#10b981';
                toast.innerHTML = `
                    <i class="fas fa-check"></i>
                    ${actionName}æ“ä½œæ‰§è¡ŒæˆåŠŸ
                `;
                
                // 2ç§’åç§»é™¤æç¤º
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 2000);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è®¾å¤‡æ§åˆ¶é€»è¾‘
                console.log(`è®¾å¤‡æ§åˆ¶: ${action} - ${actionName}`);
                
            }, 1500); // æ¨¡æ‹Ÿ1.5ç§’çš„æ“ä½œæ—¶é—´
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkAuth();
        
        // è®¾ç½®å½“å‰é¡µé¢èœå•é¡¹
        setActiveMenuItem('devices');
        
        // 3Dç›¸å…³å˜é‡å·²åˆ é™¤
        
        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.location.href = 'devices.html';
        }
        
        // 3Dåœºæ™¯å·²åˆ é™¤
        
        // 3Dæ¨¡å‹åˆ›å»ºå‡½æ•°å·²åˆ é™¤
        // 3DæŸœä½“åˆ›å»ºä»£ç å·²åˆ é™¤
        
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createBatteryModules
        function createBatteryModules() {
            // createBatteryModules 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºPCSå˜æµå™¨æ¨¡å—
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createPCSModule
        function createPCSModule() {
            // createPCSModule 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºBMSç”µæ± ç®¡ç†ç³»ç»Ÿ
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createBMSModule
        function createBMSModule() {
            // createBMSModule 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºçƒ­ç®¡ç†ç³»ç»Ÿ
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createCoolingSystem
        function createCoolingSystem() {
            // createCoolingSystem 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºæ¶ˆé˜²ç³»ç»Ÿ
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createFireSystem
        function createFireSystem() {
            // createFireSystem 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºé…ç”µæŸœ
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createElectricalPanel
        function createElectricalPanel() {
            // createElectricalPanel 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åˆ›å»ºç»„ä»¶æ ‡ç­¾
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - createComponentLabels
        function createComponentLabels() {
            // createComponentLabels 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // é€‰æ‹©ç»„ä»¶
        function selectComponent(componentName) {
            selectedComponent = componentName;
            
            // æ›´æ–°UI - ç§»é™¤äº†ç»„ä»¶æ ‡ç­¾é¢æ¿ç›¸å…³ä»£ç 
            
            // é«˜äº®æ˜¾ç¤ºç»„ä»¶
            Object.keys(components).forEach(key => {
                const group = components[key];
                group.traverse(child => {
                    if (child.isMesh) {
                        child.material.opacity = key === componentName ? 1 : 0.3;
                        child.material.transparent = true;
                        if (key === componentName) {
                            child.material.emissive = child.material.color;
                            child.material.emissiveIntensity = 0.2;
                        } else {
                            child.material.emissive = new THREE.Color(0x000000);
                            child.material.emissiveIntensity = 0;
                        }
                    }
                });
            });
            
            // æ˜ å°„3Dç»„ä»¶åˆ°tabç»„ä»¶
            const tabMapping = {
                'pcs': 'pcs',
                'bms': 'bms',
                'cooling': 'thermal',
                'fire': 'fire',
                'electrical': 'hv',
                'ems': 'ems'
            };
            
            const tabComponent = tabMapping[componentName] || 'overall';
            
            // æ›´æ–°æ ‡ç­¾é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            const targetTab = document.querySelector(`.component-tab[onclick*="'${tabComponent}'"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // æ›´æ–°å½“å‰ç»„ä»¶
            currentComponent = tabComponent;
            
            // æ›´æ–°æ•°æ®æ˜¾ç¤º
            updateComponentData(tabComponent);
        }
        
        // è·å–ç»„ä»¶å¯¹åº”çš„æ ‡ç­¾åç§°
        function getComponentTabName(componentName) {
            const mapping = {
                'overall': 'æ•´æœº',
                'ems': 'EMS',
                'pcs': 'PCS',
                'bms': 'BMS',
                'meter': 'ç”µè¡¨',
                'thermal': 'æ¸©åº¦',
                'cooling': 'æ¸©åº¦',
                'fire': 'æ¶ˆé˜²',
                'electrical': 'é«˜å‹ç®±',
                'hv': 'é«˜å‹ç®±'
            };
            return mapping[componentName] || 'æ•´ä½“';
        }
        
        // æ›´æ–°ç»„ä»¶æ•°æ®
        function updateComponentData(componentName) {
            const dataContent = document.getElementById('dataContent');
            const realtimeData = document.getElementById('realtimeData');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            realtimeData.innerHTML = '';
            
            // ç»„ä»¶åç§°å·²åœ¨switchComponentä¸­å¤„ç†
            
            switch(componentName) {
                case 'overall':
                    realtimeData.innerHTML = generateComponentHTML('overall');
                    break;
                case 'overall_old':
                    // åŠ¨æ€ç”ŸæˆHTMLï¼Œæ ¹æ®å­—æ®µè®¾ç½®æ˜¾ç¤º/éšè—
                    let overallHtml = `
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">æ ¸å¿ƒè¿è¡Œå‚æ•°</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                    `;
                    
                    // æ ¸å¿ƒæ•°æ®å­—æ®µ
                    if (shouldShowField('overall', 'realtime', 'soc')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">SOC</div>
                                <div class="metric-value">
                                    <span id="soc">88.0</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç”µé‡å……è¶³</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'soh')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">SOH</div>
                                <div class="metric-value">
                                    <span id="soh">96.8</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å¥åº·çŠ¶æ€è‰¯å¥½</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'power')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">å……æ”¾ç”µåŠŸç‡</div>
                                <div class="metric-value">
                                    <span id="power">+142.8</span>
                                    <span class="metric-unit">kW</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å……ç”µä¸­</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'temperature')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">æ¸©åº¦</div>
                                <div class="metric-value">
                                    <span id="temperature">26.3</span>
                                    <span class="metric-unit">Â°C</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦æ­£å¸¸</div>
                            </div>
                        `;
                    }
                    
                    // ç”µæ°”å‚æ•°å­—æ®µ
                    if (shouldShowField('overall', 'realtime', 'voltage')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">ç”µæ± ç”µå‹</div>
                                <div class="metric-value">
                                    <span id="voltage">748.8</span>
                                    <span class="metric-unit">V</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'current')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">ç”µæ± ç”µæµ</div>
                                <div class="metric-value">
                                    <span id="current">0.1</span>
                                    <span class="metric-unit">A</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'efficiency')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">ç³»ç»Ÿæ•ˆç‡</div>
                                <div class="metric-value">
                                    <span id="efficiency">94.5</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é«˜æ•ˆè¿è¡Œ</div>
                            </div>
                        `;
                    }
                    
                    overallHtml += `
                            </div>
                        </div>
                    `;
                    
                    // è¿è¡Œç»Ÿè®¡éƒ¨åˆ†
                    let hasStatisticsData = shouldShowField('overall', 'realtime', 'chargeCount') || 
                                           shouldShowField('overall', 'realtime', 'chargeAmount') || 
                                           shouldShowField('overall', 'realtime', 'chargeCost') ||
                                           shouldShowField('overall', 'realtime', 'dischargeCount') ||
                                           shouldShowField('overall', 'realtime', 'dischargeAmount') ||
                                           shouldShowField('overall', 'realtime', 'dischargeRevenue');
                    
                    if (hasStatisticsData) {
                        overallHtml += `
                            <!-- è¿è¡Œç»Ÿè®¡ -->
                            <div class="metrics-section" style="margin-top: 20px;">
                                <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">è¿è¡Œç»Ÿè®¡</h4>
                                <div class="metrics-grid">
                        `;
                        
                        if (shouldShowField('overall', 'realtime', 'chargeCount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">å……ç”µæ¬¡æ•°</div>
                                    <div class="metric-value">
                                        <span id="chargeCount">3</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'chargeAmount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">å……ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="chargeAmount">856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'chargeCost')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">å……ç”µæˆæœ¬</div>
                                    <div class="metric-value">
                                        <span id="chargeCost" style="color: #ef4444;">ï¿¥685.0</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeCount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">æ”¾ç”µæ¬¡æ•°</div>
                                    <div class="metric-value">
                                        <span id="dischargeCount">2</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeAmount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">æ”¾ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="dischargeAmount">743.0</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeRevenue')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">æ”¾ç”µæ”¶ç›Š</div>
                                    <div class="metric-value">
                                        <span id="dischargeRevenue" style="color: #10b981;">ï¿¥1114.5</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        
                        overallHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // å…¶ä»–å‚æ•°éƒ¨åˆ†
                    let hasOtherData = shouldShowField('overall', 'realtime', 'cycles') || 
                                       shouldShowField('overall', 'realtime', 'totalCharge') || 
                                       shouldShowField('overall', 'realtime', 'totalDischarge');
                    
                    if (hasOtherData) {
                        overallHtml += `
                            <!-- å…¶ä»–å‚æ•° -->
                            <div class="metrics-section" style="margin-top: 20px;">
                                <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">å…¶ä»–å‚æ•°</h4>
                                <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        `;
                        
                        if (shouldShowField('overall', 'realtime', 'cycles')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">å¾ªç¯æ¬¡æ•°</div>
                                    <div class="metric-value">
                                        <span id="cycles">128</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'totalCharge')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">ç´¯è®¡å……ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="totalChargeAccumulated">12856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'totalDischarge')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">ç´¯è®¡æ”¾ç”µé‡</div>
                                    <div class="metric-value">
                                        <span id="totalDischargeAccumulated">11743.0</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        overallHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    realtimeData.innerHTML = overallHtml;
                    break;
                    
                case 'ems':
                    realtimeData.innerHTML = generateComponentHTML('ems');
                    break;
                case 'ems_old':
                    realtimeData.innerHTML = `
                        <!-- ç­–ç•¥è°ƒåº¦å‚æ•° -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">ç­–ç•¥è°ƒåº¦å‚æ•°</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">å½“å‰ç­–ç•¥</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">å³°è°·å¥—åˆ©</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">è‡ªåŠ¨æ‰§è¡Œä¸­</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è°ƒåº¦æŒ‡ä»¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">å……ç”µ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç›®æ ‡åŠŸç‡125kW</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç›®æ ‡SOC</div>
                                    <div class="metric-value">
                                        <span id="emsTargetSOC">${(85 + Math.random() * 10).toFixed(0)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">å³°æ—¶æ”¾ç”µå‡†å¤‡</div>
                                </div>
                            </div>
                        </div>

                        <!-- é€šä¿¡æ§åˆ¶å‚æ•° -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">é€šä¿¡æ§åˆ¶å‚æ•°</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ä¸»ç«™é€šä¿¡</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">åœ¨çº¿</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é€šä¿¡æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è°ƒåº¦å“åº”æ—¶é—´</div>
                                    <div class="metric-value">
                                        <span id="emsResponseTime">${(15 + Math.random() * 25).toFixed(0)}</span>
                                        <span class="metric-unit">ms</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å“åº”åŠæ—¶</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">AGCæŒ‡ä»¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">${Math.random() > 0.5 ? 'ä¸Šè°ƒ' : 'ä¸‹è°ƒ'}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">è‡ªåŠ¨å‘ç”µæ§åˆ¶</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µç½‘é¢‘ç‡</div>
                                    <div class="metric-value">
                                        <span id="gridFrequency">${(49.95 + Math.random() * 0.1).toFixed(3)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é¢‘ç‡ç¨³å®š</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">åŠŸç‡åå·®</div>
                                    <div class="metric-value">
                                        <span id="powerDeviation">${(Math.random() * 10 - 5).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ§åˆ¶ç²¾åº¦é«˜</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ä¿æŠ¤çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ— ä¿æŠ¤åŠ¨ä½œ</div>
                                </div>
                            </div>
                        </div>

                    `;
                    break;
                case 'pcs':
                    realtimeData.innerHTML = generateComponentHTML('pcs');
                    break;
                case 'pcs_old':
                    realtimeData.innerHTML = `
                        <!-- ç”µåŠ›è½¬æ¢å‚æ•° -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">ç”µåŠ›è½¬æ¢å‚æ•°</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ç›´æµä¾§ç”µå‹</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç”µå‹ç¨³å®š</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç›´æµä¾§ç”µæµ</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-current">${(180 + Math.random() * 70).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç”µæµæ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">äº¤æµä¾§ç”µå‹</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-voltage">${(376 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">380Væ ‡å‡†</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">äº¤æµä¾§ç”µæµ</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-current">${(320 + Math.random() * 80).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">è´Ÿè·å‡è¡¡</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æœ‰åŠŸåŠŸç‡</div>
                                    <div class="metric-value">
                                        <span id="pcs-active-power">${(125 + Math.random() * 75).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">åŠŸç‡è¾“å‡ºç¨³å®š</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ— åŠŸåŠŸç‡</div>
                                    <div class="metric-value">
                                        <span id="pcs-reactive-power">${(Math.random() * 20 - 10).toFixed(1)}</span>
                                        <span class="metric-unit">kVar</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ— åŠŸè¡¥å¿</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">åŠŸç‡å› æ•°</div>
                                    <div class="metric-value">
                                        <span id="pcs-pf">${(0.95 + Math.random() * 0.04).toFixed(3)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é«˜åŠŸç‡å› æ•°</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">é¢‘ç‡</div>
                                    <div class="metric-value">
                                        <span id="pcs-frequency">${(49.95 + Math.random() * 0.1).toFixed(2)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é¢‘ç‡ç¨³å®š</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è®¾å¤‡è¿è¡Œå‚æ•° -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">è®¾å¤‡è¿è¡Œå‚æ•°</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">è½¬æ¢æ•ˆç‡</div>
                                    <div class="metric-value">
                                        <span id="pcs-efficiency">${(96.2 + Math.random() * 2.5).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é«˜æ•ˆè½¬æ¢</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å¼€å…³é¢‘ç‡</div>
                                    <div class="metric-value">
                                        <span id="pcs-switch-freq">${(8 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">kHz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">PWMè°ƒåˆ¶</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">IGBTæ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="pcs-igbt-temp">${(55 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæŠ—å™¨æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="pcs-reactor-temp">${(42 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">è¿è¡Œæ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å˜å‹å™¨æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="pcs-transformer-temp">${(48 + Math.random() * 12).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ•£çƒ­è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ€»è°æ³¢å¤±çœŸ</div>
                                    <div class="metric-value">
                                        <span id="pcs-thd">${(2.5 + Math.random() * 1.5).toFixed(2)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">THDä¼˜ç§€</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç»ç¼˜é˜»æŠ—</div>
                                    <div class="metric-value">
                                        <span id="pcs-insulation">${(15 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">MÎ©</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç»ç¼˜è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ§åˆ¶çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">è¿è¡Œ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸å·¥ä½œæ¨¡å¼</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¿æŠ¤ä¸æ•…éšœä¿¡æ¯ -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">ä¿æŠ¤ä¸æ•…éšœä¿¡æ¯</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡å‹ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æœªè§¦å‘</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡æµä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æœªè§¦å‘</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡æ¸©ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦åœ¨èŒƒå›´å†…</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ•…éšœè®¡æ•°</div>
                                    <div class="metric-value">
                                        <span id="pcs-fault-count">0</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æœ¬æœˆæ— æ•…éšœ</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç´¯è®¡è¿è¡Œæ—¶é—´</div>
                                    <div class="metric-value">
                                        <span id="pcs-runtime">${(15000 + Math.random() * 2000).toFixed(0)}</span>
                                        <span class="metric-unit">h</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">è®¾å¤‡å¯¿å‘½è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç»´æŠ¤çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">è‰¯å¥½</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">ä¸‹æ¬¡ç»´æŠ¤45å¤©å</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'bms':
                    realtimeData.innerHTML = generateBMSHTML();
                    break;
                case 'bms_old':
                    realtimeData.innerHTML = `
                        <!-- ç”µæ± ç»„ç®¡ç†å‚æ•° -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">ç”µæ± ç»„ç®¡ç†å‚æ•°</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">æ€»ç”µå‹</div>
                                    <div class="metric-value">
                                        <span id="bms-total-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç”µå‹æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ€»ç”µæµ</div>
                                    <div class="metric-value">
                                        <span id="bms-total-current">${(Math.random() > 0.5 ? '+' : '-')}${(120 + Math.random() * 80).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">${Math.random() > 0.5 ? 'å……ç”µç”µæµ' : 'æ”¾ç”µç”µæµ'}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å‰©ä½™å®¹é‡</div>
                                    <div class="metric-value">
                                        <span id="bms-remaining-capacity">${(450 + Math.random() * 100).toFixed(1)}</span>
                                        <span class="metric-unit">Ah</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">å¯ç”¨å®¹é‡</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å……æ”¾ç”µå¾ªç¯</div>
                                    <div class="metric-value">
                                        <span id="bms-cycles">${Math.floor(2800 + Math.random() * 500)}</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">å¾ªç¯å¯¿å‘½è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å†…é˜»</div>
                                    <div class="metric-value">
                                        <span id="bms-internal-resistance">${(45 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">mÎ©</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é˜»æŠ—æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç»ç¼˜é˜»æŠ—</div>
                                    <div class="metric-value">
                                        <span id="bms-insulation">${(850 + Math.random() * 300).toFixed(0)}</span>
                                        <span class="metric-unit">kÎ©</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç»ç¼˜è‰¯å¥½</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å•ä½“ç”µèŠ¯ç›‘æ§ -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">å•ä½“ç”µèŠ¯ç›‘æ§</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">æœ€é«˜å•ä½“ç”µå‹</div>
                                    <div class="metric-value">
                                        <span id="bms-max-cell-voltage">${(3.35 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">ç”µèŠ¯ç¼–å·: ${Math.floor(Math.random() * 280 + 1)}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æœ€ä½å•ä½“ç”µå‹</div>
                                    <div class="metric-value">
                                        <span id="bms-min-cell-voltage">${(3.32 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">ç”µèŠ¯ç¼–å·: ${Math.floor(Math.random() * 280 + 1)}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å•ä½“å‹å·®</div>
                                    <div class="metric-value">
                                        <span id="bms-voltage-diff">${(5 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">mV</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å‹å·®è‰¯å¥½</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µèŠ¯ä¸€è‡´æ€§</div>
                                    <div class="metric-value">
                                        <span id="bms-consistency">${(96.5 + Math.random() * 2.5).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ä¸€è‡´æ€§ä¼˜ç§€</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å¼‚å¸¸ç”µèŠ¯æ•°</div>
                                    <div class="metric-value">
                                        <span id="bms-abnormal-cells">0</span>
                                        <span class="metric-unit">ä¸ª</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å…¨éƒ¨æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å‡è¡¡çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">${Math.random() > 0.7 ? 'å‡è¡¡ä¸­' : 'æœªå‡è¡¡'}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">ä¸»åŠ¨å‡è¡¡ç­–ç•¥</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µèŠ¯æ€»æ•°</div>
                                    <div class="metric-value">
                                        <span>280</span>
                                        <span class="metric-unit">ä¸ª</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">14ä¸²20å¹¶ç»„åˆ</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">é‡‡æ ·ç²¾åº¦</div>
                                    <div class="metric-value">
                                        <span id="bms-sampling-accuracy">${(99.5 + Math.random() * 0.4).toFixed(2)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">é«˜ç²¾åº¦é‡‡æ ·</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å®‰å…¨ä¿æŠ¤å‚æ•° -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">å®‰å…¨ä¿æŠ¤å‚æ•°</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡å‹ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">é˜ˆå€¼: 3.65V</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ¬ å‹ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">é˜ˆå€¼: 2.8V</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡æµä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">é˜ˆå€¼: 300A</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡æ¸©ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">é˜ˆå€¼: 60Â°C</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">çŸ­è·¯ä¿æŠ¤</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æœªè§¦å‘</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">é€šä¿¡çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">åœ¨çº¿</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">CANé€šä¿¡æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ•…éšœä»£ç </div>
                                    <div class="metric-value">
                                        <span id="bms-fault-code">0x0000</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ— æ•…éšœ</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç¡¬ä»¶ç‰ˆæœ¬</div>
                                    <div class="metric-value">
                                        <span>V2.1.3</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">è½¯ä»¶ç‰ˆæœ¬V1.8.5</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'meter':
                    realtimeData.innerHTML = generateMeterHTML();
                    break;
                    
                case 'thermal':
                case 'cooling':
                    realtimeData.innerHTML = generateComponentHTML('thermal');
                    break;
                case 'thermal_old':
                case 'cooling_old':
                    realtimeData.innerHTML = `
                        <!-- æ ¸å¿ƒç›‘æ§å‚æ•° -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">æ ¸å¿ƒç›‘æ§å‚æ•°</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± åŒ…æœ€é«˜æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="battMaxTemp">${(26 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸èŒƒå›´</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± åŒ…æœ€ä½æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="battMinTemp">${(22 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸èŒƒå›´</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± åŒ…å¹³å‡æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="battAvgTemp">${(24 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ­£å¸¸èŒƒå›´</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± åŒ…æ¸©å·®</div>
                                    <div class="metric-value">
                                        <span id="battTempDiff">${(2 + Math.random() * 3).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦å‡åŒ€</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿›é£æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="inletTemp">${(20 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç¯å¢ƒæ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å‡ºé£æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="outletTemp">${(28 + Math.random() * 6).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ•£çƒ­æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç›¸å¯¹æ¹¿åº¦</div>
                                    <div class="metric-value">
                                        <span id="humidity">${(40 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">%RH</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¹¿åº¦é€‚å®œ</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å†·å´æ¶²æ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="coolantTemp">${(18 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å†·å´æ­£å¸¸</div>
                                </div>
                            </div>
                        </div>

                        <!-- ç³»ç»Ÿè¿è¡Œå‚æ•° -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">ç³»ç»Ÿè¿è¡Œå‚æ•°</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ä¸»é£æœºè½¬é€Ÿ</div>
                                    <div class="metric-value">
                                        <span id="mainFanSpeed">${(1800 + Math.random() * 400).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¾…åŠ©é£æœºè½¬é€Ÿ</div>
                                    <div class="metric-value">
                                        <span id="auxFanSpeed">${(1200 + Math.random() * 300).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å†·å´æ¶²æµé€Ÿ</div>
                                    <div class="metric-value">
                                        <span id="coolantFlow">${(15 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">L/min</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å‹ç¼©æœºåŠŸç‡</div>
                                    <div class="metric-value">
                                        <span id="compressorPower">${(3.2 + Math.random() * 1.8).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">çƒ­ç®¡ç†åŠŸè€—</div>
                                    <div class="metric-value">
                                        <span id="thermalPower">${(5.8 + Math.random() * 2.2).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ¸©å‡é€Ÿç‡</div>
                                    <div class="metric-value">
                                        <span id="tempRiseRate">${(0.05 + Math.random() * 0.25).toFixed(3)}</span>
                                        <span class="metric-unit">Â°C/min</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">åˆ¶å†·æ•ˆç‡</div>
                                    <div class="metric-value">
                                        <span id="coolingEff">${(88 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">COPç³»æ•°</div>
                                    <div class="metric-value">
                                        <span id="copValue">${(3.2 + Math.random() * 0.8).toFixed(2)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¿è¡ŒçŠ¶æ€ -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">è¿è¡ŒçŠ¶æ€</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">çƒ­ç®¡ç†çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">è‡ªåŠ¨è°ƒèŠ‚</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å†·å´æ¨¡å¼</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">ä¸»åŠ¨åˆ¶å†·</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ä»Šæ—¥è¿è¡Œæ—¶é—´</div>
                                    <div class="metric-value">
                                        <span id="thermalRuntime">${(18 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">å°æ—¶</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç»´æŠ¤çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">è‰¯å¥½</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å¯åœæ¬¡æ•°</div>
                                    <div class="metric-value">
                                        <span id="thermalCycles">${Math.floor(2 + Math.random() * 3)}</span>
                                        <span class="metric-unit">æ¬¡</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¿‡æ»¤å™¨çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ¸…æ´</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æŠ¥è­¦çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ— æŠ¥è­¦</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">èƒ½æ•ˆç­‰çº§</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">ä¸€çº§</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">èŠ‚èƒ½ä¼˜ç§€</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'fire':
                    realtimeData.innerHTML = generateComponentHTML('fire');
                    break;
                case 'fire_old':
                    realtimeData.innerHTML = `
                        <!-- ç­ç«ç³»ç»ŸçŠ¶æ€ -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">ç­ç«ç³»ç»ŸçŠ¶æ€</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ç³»ç»ŸçŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">å¾…å‘½</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç³»ç»Ÿå°±ç»ª</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ä¸ƒæ°Ÿä¸™çƒ·å‹åŠ›</div>
                                    <div class="metric-value">
                                        <span id="fire-pressure">${(4.2 + Math.random() * 0.6).toFixed(1)}</span>
                                        <span class="metric-unit">MPa</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å‹åŠ›æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç­ç«å‰‚ä½™é‡</div>
                                    <div class="metric-value">
                                        <span id="fire-agent-remaining">${(85 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å‚¨é‡å……è¶³</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å–·å˜´æ•°é‡</div>
                                    <div class="metric-value">
                                        <span>12</span>
                                        <span class="metric-unit">ä¸ª</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">å…¨éƒ¨æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç®¡è·¯å‹åŠ›</div>
                                    <div class="metric-value">
                                        <span id="fire-pipe-pressure">${(0.8 + Math.random() * 0.4).toFixed(2)}</span>
                                        <span class="metric-unit">MPa</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç®¡è·¯æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">å¯åŠ¨æ¨¡å¼</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">è‡ªåŠ¨</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">è‡ªåŠ¨+æ‰‹åŠ¨</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¢æµ‹ç³»ç»Ÿ -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">æ¢æµ‹ç³»ç»Ÿ</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">çƒŸé›¾æ¢æµ‹å™¨</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">4ä¸ªæ¢å¤´åœ¨çº¿</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ¸©åº¦æ¢æµ‹å™¨</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">6ä¸ªæ¢å¤´åœ¨çº¿</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ°”ä½“æ¢æµ‹å™¨</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">CO/CO2æ¢æµ‹</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç¯å¢ƒæ¸©åº¦</div>
                                    <div class="metric-value">
                                        <span id="fire-env-temp">${(25 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">çƒŸé›¾æµ“åº¦</div>
                                    <div class="metric-value">
                                        <span id="fire-smoke-density">${(0.01 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">%vol</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æµ“åº¦æ­£å¸¸</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">COæµ“åº¦</div>
                                    <div class="metric-value">
                                        <span id="fire-co-concentration">${(5 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">ppm</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æµ“åº¦å®‰å…¨</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æŠ¥è­¦é˜ˆå€¼</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #666;">60Â°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">æ¸©åº¦æŠ¥è­¦ç‚¹</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æœ€åæ£€æµ‹</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">2åˆ†é’Ÿå‰</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ£€æµ‹è®°å½• -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">æœ€è¿‘æ£€æµ‹è®°å½•</h4>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                    â€¢ 2024-01-28 10:00 - æœˆåº¦æ£€æŸ¥å®Œæˆ<br>
                                    â€¢ 2024-01-15 14:30 - å‹åŠ›æµ‹è¯•æ­£å¸¸<br>
                                    â€¢ 2023-12-28 09:00 - å¹´åº¦ç»´æŠ¤å®Œæˆ<br>
                                    â€¢ ä¸Šæ¬¡è§¦å‘ï¼šæ— 
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">é…ç”µæŸœ - å®æ—¶æ•°æ®</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>è¿”å›æ•´æœº
                            </button>
                        </div>
                        
                        <!-- ç”µæ°”å‚æ•° -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">ç”µæ°”å‚æ•°</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">Aç›¸ç”µå‹</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Bç›¸ç”µå‹</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">Cç›¸ç”µå‹</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">é¢‘ç‡</div>
                                    <div class="metric-value">
                                        <span>${(49.9 + Math.random() * 0.2).toFixed(2)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¼€å…³çŠ¶æ€ -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">å¼€å…³çŠ¶æ€</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ä¸»æ–­è·¯å™¨</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">åˆé—¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCSæ–­è·¯å™¨</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">åˆé—¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± æ–­è·¯å™¨</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">åˆé—¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¾…åŠ©ç”µæº</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                    
                case 'hv':
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">é«˜å‹ç®±å®æ—¶æ•°æ®</h3>
                            
                            <!-- ä¸»æ–­è·¯å™¨çŠ¶æ€ -->
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ä¸»æ–­è·¯å™¨</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">åˆé—¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">é˜²é›·å™¨çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç»ç¼˜ç”µé˜»</div>
                                    <div class="metric-value">
                                        <span>${(500 + Math.random() * 100).toFixed(0)}</span>
                                        <span class="metric-unit">MÎ©</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">ç›´æµæ¯çº¿ç”µå‹</div>
                                    <div class="metric-value">
                                        <span>${(750 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ”¯è·¯ä¿æŠ¤ -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">æ”¯è·¯ä¿æŠ¤çŠ¶æ€</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">ç”µæ± æ”¯è·¯</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCSæ”¯è·¯</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">è¾…åŠ©ç”µæº</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">æ­£å¸¸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">æ¥åœ°çŠ¶æ€</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">è‰¯å¥½</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    // é»˜è®¤æ˜¾ç¤ºæ•´ä½“æ•°æ®
                    updateComponentData('overall');
            }
        }
        
        // å½“å‰é€‰ä¸­çš„ç»„ä»¶
        let currentComponent = 'overall';
        
        // åˆ‡æ¢ç»„ä»¶æ ‡ç­¾é¡µ
        function switchComponent(component) {
            currentComponent = component;
            
            // æ›´æ–°ç»„ä»¶æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
                // æ ¹æ®æŒ‰é’®æ–‡æœ¬å†…å®¹åŒ¹é…å¯¹åº”çš„ç»„ä»¶
                const tabText = t.textContent.trim().toLowerCase();
                const componentText = getComponentTabName(component).toLowerCase();
                if (tabText === componentText || 
                    (component === 'pcs' && tabText === 'é€†å˜å™¨') ||
                    (component === 'thermal' && tabText === 'æ¸©åº¦') ||
                    (component === 'fire' && tabText === 'æ¶ˆé˜²') ||
                    (component === 'meter' && tabText === 'ç”µè¡¨') ||
                    (component === 'overall' && tabText === 'æ•´æœº')) {
                    t.classList.add('active');
                }
            });
            
            // é‡ç½®ä¸ºå®æ—¶æ•°æ®tab
            document.querySelectorAll('.data-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelector('[onclick="switchTab(\'realtime\')"]').classList.add('active');
            
            // æ˜¾ç¤ºå®æ—¶æ•°æ®ï¼Œéšè—å…¶ä»–tabå†…å®¹
            document.getElementById('realtimeData').style.display = 'block';
            document.getElementById('historyData').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'none';
            
            // æ›´æ–°æ•°æ®å†…å®¹
            updateComponentData(component);
        }
        
        // åˆ‡æ¢æ•°æ®æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.data-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tab === 'realtime') {
                document.getElementById('realtimeData').style.display = 'block';
                document.getElementById('historyData').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'none';
            } else if (tab === 'history') {
                document.getElementById('realtimeData').style.display = 'none';
                document.getElementById('historyData').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'none';
                initHistoryCharts();
            } else if (tab === 'control') {
                document.getElementById('realtimeData').style.display = 'none';
                document.getElementById('historyData').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'block';
                // åˆå§‹åŒ–æ—¶é—´è½´
                setTimeout(() => {
                    initTimeline();
                    // åˆå§‹åŒ–æ—¶ç¦ç”¨æ‰€æœ‰æ§ä»¶ï¼ˆåªä¿ç•™ç¼–è¾‘æŒ‰é’®å’Œæ•°æ®æ ‡ç­¾é¡µå¯ç”¨ï¼‰
                    const controlPanel = document.getElementById('controlPanel');
                    controlPanel.querySelectorAll('input, select, button').forEach(element => {
                        if (element.id !== 'editControlBtn' && 
                            !element.classList.contains('data-tab') && 
                            element.parentElement?.id !== 'controlButtons') {
                            element.disabled = true;
                            element.style.opacity = '0.6';
                            element.style.cursor = 'not-allowed';
                        }
                    });
                    // ä¿å­˜æ—¶é—´è½´å®¹å™¨å¼•ç”¨
                    window.timelineContainer = document.getElementById('timelineContainer');
                    if (window.timelineContainer) {
                        window.timelineContainer.style.pointerEvents = 'none';
                    }
                }, 100);
            }
        }
        
        
        // åˆå§‹åŒ–å†å²å›¾è¡¨
        function initHistoryCharts() {
            // æ ¹æ®å½“å‰é€‰ä¸­çš„ç»„ä»¶æ˜¾ç¤ºä¸åŒçš„å†å²æ•°æ®
            if (currentComponent === 'overall') {
                // æ•´æœºå†å²æ•°æ® - æ ¹æ®å­—æ®µè®¾ç½®åŠ¨æ€æ˜¾ç¤º
                let historyHtml = `
                    <!-- è®¾ç½®æŒ‰é’® -->
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                        <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-cog"></i>
                            <span>è®¾ç½®</span>
                        </button>
                    </div>
                    
                `;
                
                // ç§»é™¤ç´¯è®¡ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
                
                // è¿è¡Œè¶‹åŠ¿å›¾è¡¨éƒ¨åˆ†
                if (shouldShowField('overall', 'history', 'powerTrend')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div class="chart-title">åŠŸç‡ä¸SOCç»¼åˆåˆ†æ</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <input type="date" class="form-input" id="historyEndDatePicker" style="width: 140px; height: 32px; padding: 4px 8px; font-size: 13px;" onchange="updateHistoryChart()">
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="powerSocChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                if (shouldShowField('overall', 'history', 'efficiency')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div class="chart-title">æ”¶ç›Šåˆ†æ</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <select id="revenueTimeType" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px;" onchange="updateRevenueAnalysisChart()">
                                        <option value="day" selected>æ—¥</option>
                                        <option value="month">æœˆ</option>
                                        <option value="year">å¹´</option>
                                        <option value="total">æ€»</option>
                                    </select>
                                    <input type="date" id="revenueDatePicker" class="form-input" style="width: 140px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                    <select id="revenueMonthPicker" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                        <option value="2025-01">2025å¹´1æœˆ</option>
                                        <option value="2025-02">2025å¹´2æœˆ</option>
                                        <option value="2025-03">2025å¹´3æœˆ</option>
                                        <option value="2025-04">2025å¹´4æœˆ</option>
                                        <option value="2025-05">2025å¹´5æœˆ</option>
                                        <option value="2025-06">2025å¹´6æœˆ</option>
                                        <option value="2025-07" selected>2025å¹´7æœˆ</option>
                                        <option value="2025-08">2025å¹´8æœˆ</option>
                                        <option value="2025-09">2025å¹´9æœˆ</option>
                                        <option value="2025-10">2025å¹´10æœˆ</option>
                                        <option value="2025-11">2025å¹´11æœˆ</option>
                                        <option value="2025-12">2025å¹´12æœˆ</option>
                                    </select>
                                    <select id="revenueYearPicker" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                        <option value="2023">2023å¹´</option>
                                        <option value="2024">2024å¹´</option>
                                        <option value="2025" selected>2025å¹´</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="revenueAnalysisChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('historyData').innerHTML = historyHtml;
                
                // åˆå§‹åŒ–å›¾è¡¨
                setTimeout(() => {
                    initOverallHistoryCharts();
                }, 100);
                return;
            }
            
            // æ ¹æ®ç»„ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†å²æ•°æ®
            if (currentComponent === 'ems') {
                // EMSå†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('ems');
                
                // å»¶è¿Ÿåˆå§‹åŒ–EMSå›¾è¡¨
                setTimeout(() => {
                    initEMSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'pcs') {
                // PCSå†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('pcs');
                
                // å»¶è¿Ÿåˆå§‹åŒ–PCSå›¾è¡¨
                setTimeout(() => {
                    initPCSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'bms') {
                // BMSå†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('bms');
                
                setTimeout(() => { initBMSHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'meter') {
                // ç”µè¡¨å†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('meter');
                
                setTimeout(() => { initMeterHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'thermal') {
                // æ¸©åº¦å†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('thermal');
                
                setTimeout(() => { initThermalHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'fire') {
                // Fireå†å²æ•°æ® - ä½¿ç”¨åŠ¨æ€ç”Ÿæˆ
                document.getElementById('historyData').innerHTML = generateHistoryHTML('fire');
                
                setTimeout(() => { initFireHistoryCharts(); }, 100);
                return;
            }
            
            // å…¶ä»–ç»„ä»¶çš„å†å²æ•°æ®ä¿æŒåŸæ ·
            // åŠŸç‡å†å²
            const powerCtx = document.getElementById('powerHistoryChart').getContext('2d');
            new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'å……ç”µåŠŸç‡',
                        data: Array.from({length: 24}, (_, i) => {
                            // æ¨¡æ‹Ÿå…¸å‹å……æ”¾ç”µæ›²çº¿
                            if (i >= 10 && i <= 16) return Math.random() * 50 + 100;
                            if (i >= 6 && i <= 9) return -(Math.random() * 50 + 80);
                            if (i >= 18 && i <= 22) return -(Math.random() * 50 + 60);
                            return Math.random() * 20 - 10;
                        }),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return value > 0 ? `å……ç”µ: ${value.toFixed(1)} kW` : `æ”¾ç”µ: ${Math.abs(value).toFixed(1)} kW`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#666';
                                    }
                                    return 'rgba(0, 0, 0, 0.05)';
                                }
                            }
                        }
                    }
                }
            });
            
            // SOCå†å²
            const socCtx = document.getElementById('socHistoryChart').getContext('2d');
            new Chart(socCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'SOC',
                        data: Array.from({length: 24}, (_, i) => {
                            // æ¨¡æ‹ŸSOCå˜åŒ–
                            const base = 85;
                            if (i <= 6) return base - i * 2;
                            if (i <= 10) return 73 + (i - 6) * 5;
                            if (i <= 16) return 93 - (i - 10) * 2;
                            if (i <= 22) return 81 - (i - 16) * 3;
                            return 63 + (i - 22) * 11;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'å……æ”¾ç”µçŠ¶æ€',
                        data: Array.from({length: 24}, (_, i) => {
                            if (i >= 10 && i <= 16) return 1; // å……ç”µ
                            if (i >= 6 && i <= 9) return -1; // æ”¾ç”µ
                            if (i >= 18 && i <= 22) return -1; // æ”¾ç”µ
                            return 0; // å¾…æœº
                        }),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        stepped: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: -1.5,
                            max: 1.5,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === 1) return 'å……ç”µ';
                                    if (value === -1) return 'æ”¾ç”µ';
                                    if (value === 0) return 'å¾…æœº';
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
            
            // æ¸©åº¦åˆ†å¸ƒ
            const tempCtx = document.getElementById('tempHistoryChart').getContext('2d');
            new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'æœ€é«˜æ¸©åº¦',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 30),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'å¹³å‡æ¸©åº¦',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 27),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'æœ€ä½æ¸©åº¦',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 24),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // ç”µå‹ä¸€è‡´æ€§
            const voltageCtx = document.getElementById('voltageConsistencyChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'å•ä½“ç”µå‹åˆ†å¸ƒ',
                            data: Array.from({length: 100}, () => ({
                                x: Math.floor(Math.random() * 20) + 1,
                                y: 3.35 + (Math.random() - 0.5) * 0.01
                            })),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'ç”µæ± å•ä½“ç¼–å·'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'ç”µå‹ (V)'
                                },
                                min: 3.34,
                                max: 3.36
                            }
                        }
                    }
                });
            }
            
            // å……æ”¾ç”µæ•ˆç‡åˆ†æ
            const efficiencyCtx = document.getElementById('efficiencyChart');
            if (efficiencyCtx) {
                new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                        datasets: [{
                            label: 'å……ç”µæ•ˆç‡',
                            data: [96.2, 96.5, 96.3, 96.8, 96.4, 96.1, 95.8, 95.5, 96.0, 96.3, 96.4, 96.2],
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }, {
                            label: 'æ”¾ç”µæ•ˆç‡',
                            data: [95.8, 96.0, 95.9, 96.2, 96.0, 95.7, 95.4, 95.1, 95.6, 95.9, 96.0, 95.8],
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 97,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // å³°è°·å¥—åˆ©åˆ†æ
            const arbitrageCtx = document.getElementById('arbitrageChart');
            if (arbitrageCtx) {
                new Chart(arbitrageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['00:00', '02:00', '04:00', '06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'],
                        datasets: [{
                            label: 'ç”µä»·',
                            data: [0.3, 0.3, 0.3, 0.4, 0.8, 1.2, 1.5, 1.5, 1.2, 1.5, 1.2, 0.6],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: 'åŠŸç‡',
                            data: [150, 180, 200, 150, -100, -150, -180, -200, -150, -180, -100, 100],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'ç”µä»· (å…ƒ/kWh)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'åŠŸç‡ (kW)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // å¥åº·åº¦è¶‹åŠ¿
            const sohTrendCtx = document.getElementById('sohTrendChart');
            if (sohTrendCtx) {
                new Chart(sohTrendCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['2023-01', '2023-03', '2023-05', '2023-07', '2023-09', '2023-11', '2024-01'],
                        datasets: [{
                            label: 'SOH',
                            data: [100, 99.5, 99.1, 98.5, 97.8, 97.2, 96.8],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }, {
                            label: 'é¢„æµ‹è¶‹åŠ¿',
                            data: [null, null, null, null, null, null, 96.8, 96.2, 95.5, 94.8],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 95,
                                        yMax: 95,
                                        borderColor: 'rgb(255, 99, 132)',
                                        borderWidth: 2,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // ç”Ÿæˆå†å²æ¯æ—¥æ•°æ®
        function generateHistoryDailyData(timeRange, endDate) {
            const end = new Date(endDate);
            const days = parseInt(timeRange);
            const labels = [];
            const powerData = [];
            const socData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(end);
                date.setDate(date.getDate() - i);
                
                // æ ¼å¼åŒ–æ—¥æœŸæ ‡ç­¾
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                labels.push(label);
                
                // ç”Ÿæˆæ¨¡æ‹ŸåŠŸç‡æ•°æ®ï¼ˆæ­£æ•°å……ç”µï¼Œè´Ÿæ•°æ”¾ç”µï¼‰
                const basePower = 1000 + Math.sin(i * 0.5) * 800;
                const powerVariation = (Math.random() - 0.5) * 600;
                powerData.push(Math.round(basePower + powerVariation));
                
                // ç”Ÿæˆæ¨¡æ‹ŸSOCæ•°æ®
                const baseSOC = 75 + Math.sin(i * 0.3) * 15;
                const socVariation = (Math.random() - 0.5) * 10;
                socData.push(Math.max(20, Math.min(95, Math.round(baseSOC + socVariation))));
            }
            
            return { labels, powerData, socData };
        }
        
        // æ›´æ–°å†å²å›¾è¡¨
        function updateHistoryChart() {
            const endDate = document.getElementById('historyEndDatePicker').value;
            initOverallHistoryCharts('30d', endDate);
        }
        
        // åˆå§‹åŒ–æ”¶ç›Šåˆ†æå›¾è¡¨
        function initRevenueChart(timeFilter = 'day', selectedTime = null) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueData(timeFilter, selectedTime);
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å……ç”µé‡ (kWh)',
                        data: chargingData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'æ”¾ç”µé‡ (kWh)',
                        data: dischargingData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'å‡€æ”¶ç›Š (Â¥)',
                        data: revenueData,
                        type: 'line',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderColor: '#f59e0b',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('æ”¶ç›Š')) {
                                        return context.dataset.label + ': Â¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' kWh';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ç”µé‡ (kWh)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æ”¶ç›Š (Â¥)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // ç”Ÿæˆæ”¶ç›Šåˆ†ææ•°æ®
        function generateRevenueData(timeFilter, selectedTime = null) {
            let labels = [];
            let dataPoints = 0;
            
            switch(timeFilter) {
                case 'day':
                    // é€‰æ‹©å…·ä½“æ—¥æœŸå½“å¤©çš„24å°æ—¶æ—¶é—´ç‚¹
                    dataPoints = 24;
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                    }
                    break;
                case 'month':
                    // é€‰æ‹©å…·ä½“æœˆä»½çš„æ¯ä¸€å¤©
                    if (selectedTime) {
                        const [year, month] = selectedTime.split('-');
                        const daysInMonth = new Date(year, month, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}æ—¥`);
                        }
                    } else {
                        // é»˜è®¤æ˜¾ç¤ºå½“å‰æœˆ
                        const now = new Date();
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}æ—¥`);
                        }
                    }
                    break;
                case 'year':
                    // é€‰æ‹©å…·ä½“å¹´ä»½çš„12ä¸ªæœˆ
                    dataPoints = 12;
                    const selectedYear = selectedTime || new Date().getFullYear();
                    const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    for (let i = 0; i < 12; i++) {
                        labels.push(monthNames[i]);
                    }
                    break;
                case 'total':
                    // æ€»è®¡æŒ‰å¹´æ˜¾ç¤º
                    dataPoints = 5;
                    const currentYear = new Date().getFullYear();
                    for (let i = 4; i >= 0; i--) {
                        labels.push(`${currentYear - i}å¹´`);
                    }
                    break;
            }
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            const chargingData = [];
            const dischargingData = [];
            const revenueData = [];
            
            for (let i = 0; i < dataPoints; i++) {
                // å……ç”µé‡æ•°æ®
                const baseCharging = timeFilter === 'day' ? 2000 + Math.random() * 1000 : 
                                   timeFilter === 'month' ? 50000 + Math.random() * 25000 :
                                   timeFilter === 'year' ? 600000 + Math.random() * 200000 :
                                   150000 + Math.random() * 50000;
                chargingData.push(Math.round(baseCharging));
                
                // æ”¾ç”µé‡æ•°æ®
                const baseDischarging = baseCharging * (0.85 + Math.random() * 0.1); // 85-95%æ•ˆç‡
                dischargingData.push(Math.round(baseDischarging));
                
                // æ”¶ç›Šæ•°æ®ï¼ˆæ”¾ç”µæ”¶å…¥ - å……ç”µæˆæœ¬ï¼‰
                const chargingCost = chargingData[i] * 0.4; // å……ç”µæˆæœ¬0.4å…ƒ/kWh
                const dischargingRevenue = dischargingData[i] * 0.7; // æ”¾ç”µæ”¶å…¥0.7å…ƒ/kWh
                const netRevenue = dischargingRevenue - chargingCost;
                revenueData.push(Math.round(netRevenue));
            }
            
            return { labels, chargingData, dischargingData, revenueData };
        }
        
        // åˆå§‹åŒ–æ”¶ç›Šæ—¶é—´é€‰æ‹©å™¨
        function initRevenueTimePickers() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            document.getElementById('revenueDayPicker').value = today.toISOString().split('T')[0];
            
            // è®¾ç½®é»˜è®¤æœˆä»½ä¸ºå½“å‰æœˆ
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('revenueMonthPicker').value = currentMonth;
            
            // è®¾ç½®é»˜è®¤å¹´ä»½ä¸ºå½“å‰å¹´
            document.getElementById('revenueYearPicker').value = today.getFullYear().toString();
        }
        
        // åˆ‡æ¢æ”¶ç›Šæ—¶é—´é€‰æ‹©å™¨æ˜¾ç¤º
        function toggleRevenueTimePicker() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            const dayPicker = document.getElementById('revenueDayPicker');
            const monthPicker = document.getElementById('revenueMonthPicker');
            const yearPicker = document.getElementById('revenueYearPicker');
            
            // éšè—æ‰€æœ‰é€‰æ‹©å™¨
            dayPicker.style.display = 'none';
            monthPicker.style.display = 'none';
            yearPicker.style.display = 'none';
            
            // æ ¹æ®æ—¶é—´ç±»å‹æ˜¾ç¤ºå¯¹åº”é€‰æ‹©å™¨
            switch(timeFilter) {
                case 'day':
                    dayPicker.style.display = 'block';
                    break;
                case 'month':
                    monthPicker.style.display = 'block';
                    break;
                case 'year':
                    yearPicker.style.display = 'block';
                    break;
                case 'total':
                    // æ€»è®¡ä¸æ˜¾ç¤ºæ—¶é—´é€‰æ‹©å™¨
                    break;
            }
            
            // æ›´æ–°å›¾è¡¨
            updateRevenueChart();
        }
        
        // æ›´æ–°æ”¶ç›Šåˆ†æå›¾è¡¨
        function updateRevenueChart() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            let selectedTime = null;
            
            // è·å–é€‰ä¸­çš„æ—¶é—´
            switch(timeFilter) {
                case 'day':
                    selectedTime = document.getElementById('revenueDayPicker').value;
                    break;
                case 'month':
                    selectedTime = document.getElementById('revenueMonthPicker').value;
                    break;
                case 'year':
                    selectedTime = document.getElementById('revenueYearPicker').value;
                    break;
                case 'total':
                    selectedTime = null;
                    break;
            }
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            const canvas = document.getElementById('revenueChart');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            initRevenueChart(timeFilter, selectedTime);
        }
        
        // æ›´æ–°ç´¯è®¡æŒ‡æ ‡
        function updateCumulativeMetrics() {
            // æ¨¡æ‹Ÿç´¯è®¡æ•°æ®æ›´æ–°
            // ç§»é™¤ç´¯è®¡æ•°æ®æ›´æ–°é€»è¾‘
        }
        
        // åˆå§‹åŒ–EMSå†å²æ•°æ®å›¾è¡¨
        function initEMSHistoryCharts() {
            // EMSç­–ç•¥æ‰§è¡Œå†å²
            const strategyCtx = document.getElementById('emsStrategyChart');
            if (strategyCtx) {
                new Chart(strategyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'è°ƒåº¦æ¬¡æ•°',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 5) + 1),
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }, {
                            label: 'æ‰§è¡ŒæˆåŠŸç‡',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 90),
                            type: 'line',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'è°ƒåº¦æ¬¡æ•°' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'æˆåŠŸç‡ (%)' },
                                min: 80,
                                max: 100,
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // è°ƒåº¦å“åº”æ—¶é—´
            const responseCtx = document.getElementById('emsResponseChart');
            if (responseCtx) {
                new Chart(responseCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'å¹³å‡å“åº”æ—¶é—´',
                            data: Array.from({length: 24}, () => Math.random() * 30 + 20),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'æœ€å¤§å“åº”æ—¶é—´',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 40),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'å“åº”æ—¶é—´ (ms)' }
                            }
                        }
                    }
                });
            }
        }
        
        // åˆå§‹åŒ–PCSå†å²æ•°æ®å›¾è¡¨
        function initPCSHistoryCharts() {
            // PCSåŠŸç‡è½¬æ¢å†å²
            const powerCtx = document.getElementById('pcsPowerChart');
            if (powerCtx) {
                pcsChartInstances['pcs-power'] = new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'ACåŠŸç‡è¾“å‡º',
                            data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'DCåŠŸç‡è¾“å…¥',
                            data: Array.from({length: 24}, () => Math.random() * 110 + 55),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'åŠŸç‡ (kW)' }
                            }
                        }
                    }
                });
            }
            
            // ç”µå‹ç”µæµè¶‹åŠ¿
            const voltageCtx = document.getElementById('pcsVoltageChart');
            if (voltageCtx) {
                pcsChartInstances['pcs-voltage'] = new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'DCç”µå‹',
                            data: Array.from({length: 24}, () => Math.random() * 20 + 750),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'DCç”µæµ',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                position: 'left',
                                title: { display: true, text: 'ç”µå‹ (V)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'ç”µæµ (A)' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // è½¬æ¢æ•ˆç‡ç»Ÿè®¡
            const efficiencyCtx = document.getElementById('pcsEfficiencyChart');
            if (efficiencyCtx) {
                pcsChartInstances['pcs-efficiency'] = new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'è½¬æ¢æ•ˆç‡',
                            data: Array.from({length: 24}, () => Math.random() * 5 + 93),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 90,
                                max: 100,
                                title: { display: true, text: 'æ•ˆç‡ (%)' }
                            }
                        }
                    }
                });
            }
        }
        
        // å¤„ç†BMSå›¾è¡¨çš„æ—¥æœŸé€‰æ‹©
        function changeBMSChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            // è¿™é‡Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„æ—¥æœŸé‡æ–°åŠ è½½å¯¹åº”çš„å›¾è¡¨æ•°æ®
            // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ç›¸åº”çš„æ•°æ®æ›´æ–°å‡½æ•°æ¥è·å–ç‰¹å®šæ—¥æœŸçš„æ•°æ®
        }

        // å­˜å‚¨ç”µè¡¨å›¾è¡¨å®ä¾‹
        let meterChartInstances = {};

        // å­˜å‚¨æ¸©åº¦å›¾è¡¨å®ä¾‹
        let thermalChartInstances = {};
        
        // å­˜å‚¨æ¶ˆé˜²å›¾è¡¨å®ä¾‹
        let fireChartInstances = {};
        
        // å­˜å‚¨PCSå›¾è¡¨å®ä¾‹
        let pcsChartInstances = {};

        // å¤„ç†ç”µè¡¨å›¾è¡¨çš„æ—¥æœŸé€‰æ‹©
        function changeMeterChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // æ ¹æ®é€‰æ‹©çš„æ—¥æœŸç”Ÿæˆå¯¹åº”çš„æ•°æ®
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // ä½¿ç”¨æ—¥æœŸä½œä¸ºéšæœºæ•°ç§å­ï¼Œç¡®ä¿åŒä¸€å¤©çš„æ•°æ®ä¿æŒä¸€è‡´
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = (seed + i * 37) % 100 / 100;
                    return base + pseudoRandom * variation;
                });
            };

            const chartInstance = meterChartInstances[chartId];
            if (!chartInstance) return;

            switch(chartId) {
                case 'meter-power-trend':
                    chartInstance.data.datasets[0].data = generateData(184.4, 40);
                    chartInstance.data.datasets[1].data = generateData(31.9, 15);
                    chartInstance.data.datasets[2].data = generateData(255.4, 50);
                    break;
                    
                case 'meter-energy-stats':
                    chartInstance.data.datasets[0].data = generateData(52.1, 25);
                    chartInstance.data.datasets[1].data = generateData(7.8, 8);
                    break;
                    
                case 'meter-voltage-quality':
                    chartInstance.data.datasets[0].data = generateData(382.5, 6);
                    chartInstance.data.datasets[1].data = generateData(383.1, 6);
                    chartInstance.data.datasets[2].data = generateData(381.8, 6);
                    break;
                    
                case 'meter-harmonic':
                    const harmonicBaseData = [2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2];
                    const harmonicData = harmonicBaseData.map((base, i) => {
                        const pseudoRandom = (seed + i * 53) % 100 / 100;
                        return Math.max(0.1, base + (pseudoRandom - 0.5) * base * 0.3);
                    });
                    chartInstance.data.datasets[0].data = harmonicData;
                    break;
            }
            
            chartInstance.update();
        }

        // å¤„ç†æ¸©åº¦å›¾è¡¨çš„æ—¥æœŸé€‰æ‹©
        function changeThermalChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // æ ¹æ®é€‰æ‹©çš„æ—¥æœŸç”Ÿæˆå¯¹åº”çš„æ•°æ®
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // ä½¿ç”¨æ—¥æœŸä½œä¸ºéšæœºæ•°ç§å­ï¼Œç¡®ä¿åŒä¸€å¤©çš„æ•°æ®ä¿æŒä¸€è‡´
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = (seed + i * 41) % 100 / 100;
                    return base + pseudoRandom * variation;
                });
            };

            const chartInstance = thermalChartInstances[chartId];
            if (!chartInstance) return;

            switch(chartId) {
                case 'thermal-temp':
                    chartInstance.data.datasets[0].data = generateData(39.9, 5);
                    chartInstance.data.datasets[1].data = generateData(25.5, 3);
                    chartInstance.data.datasets[2].data = generateData(32.8, 4);
                    break;
                    
                case 'thermal-cooling':
                    chartInstance.data.datasets[0].data = generateData(1241, 200);
                    chartInstance.data.datasets[1].data = generateData(1115, 150);
                    chartInstance.data.datasets[2].data = generateData(5.8, 1.2);
                    break;
                    
                case 'thermal-heatmap':
                    // æ¸©åº¦çƒ­åŠ›å›¾ä½¿ç”¨ç‰¹æ®Šçš„ç½‘æ ¼æ•°æ®æ ¼å¼
                    const heatmapData = [];
                    for (let x = 0; x < 10; x++) {
                        for (let y = 0; y < 8; y++) {
                            const temp = 25 + (seed + x * 7 + y * 3) % 20;
                            heatmapData.push({x, y, v: temp});
                        }
                    }
                    chartInstance.data.datasets[0].data = heatmapData;
                    break;
            }
            
            chartInstance.update();
        }
        
        // æ¶ˆé˜²å›¾è¡¨æ—¥æœŸå˜æ›´å‡½æ•°
        function changeFireChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // æ ¹æ®é€‰æ‹©çš„æ—¥æœŸç”Ÿæˆå¯¹åº”çš„æ•°æ®
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // ä½¿ç”¨æ—¥æœŸä½œä¸ºéšæœºæ•°ç§å­ï¼Œç¡®ä¿åŒä¸€å¤©çš„æ•°æ®ä¿æŒä¸€è‡´
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = Math.sin(seed * 9.7 + i * 2.3) * 0.5 + 0.5;
                    return (base + (pseudoRandom - 0.5) * variation).toFixed(1);
                });
            };
            
            // è·å–å›¾è¡¨å®ä¾‹å¹¶æ›´æ–°æ•°æ®
            const chartInstance = fireChartInstances[chartId];
            if (!chartInstance) return;
            
            switch (chartId) {
                case 'fire-system':
                    // ç³»ç»ŸçŠ¶æ€å†å² - çŠ¶æ€åˆ†å¸ƒå›¾
                    chartInstance.data.datasets[0].data = [75, 20, 3, 2]; // æ­£å¸¸ã€è­¦å‘Šã€æ•…éšœã€ç»´æŠ¤
                    break;
                case 'fire-gas':
                    // æ°”ä½“æµ“åº¦ç›‘æµ‹
                    chartInstance.data.datasets[0].data = generateData(0.01, 0.02); // COæµ“åº¦
                    chartInstance.data.datasets[1].data = generateData(0.003, 0.005); // çƒŸé›¾æµ“åº¦
                    break;
                case 'fire-alarm':
                    // å‘Šè­¦è®°å½•åˆ†æ - å‘Šè­¦æ¬¡æ•°
                    chartInstance.data.datasets[0].data = Array.from({length: 24}, (_, i) => {
                        const pseudoRandom = Math.sin(seed * 7.1 + i * 1.8) * 0.5 + 0.5;
                        return Math.floor(pseudoRandom * 3); // 0-2æ¬¡å‘Šè­¦
                    });
                    break;
            }
            
            chartInstance.update();
        }
        
        // PCSå›¾è¡¨æ—¥æœŸå˜æ›´å‡½æ•°
        function changePCSChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // æ ¹æ®é€‰æ‹©çš„æ—¥æœŸç”Ÿæˆå¯¹åº”çš„æ•°æ®
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // ä½¿ç”¨æ—¥æœŸä½œä¸ºéšæœºæ•°ç§å­ï¼Œç¡®ä¿åŒä¸€å¤©çš„æ•°æ®ä¿æŒä¸€è‡´
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = Math.sin(seed * 8.3 + i * 1.9) * 0.5 + 0.5;
                    return (base + (pseudoRandom - 0.5) * variation).toFixed(1);
                });
            };
            
            // è·å–å›¾è¡¨å®ä¾‹å¹¶æ›´æ–°æ•°æ®
            const chartInstance = pcsChartInstances[chartId];
            if (!chartInstance) return;
            
            switch (chartId) {
                case 'pcs-power':
                    // PCSåŠŸç‡è½¬æ¢å†å²
                    chartInstance.data.datasets[0].data = generateData(125, 30); // å……ç”µåŠŸç‡
                    chartInstance.data.datasets[1].data = generateData(-98, 25); // æ”¾ç”µåŠŸç‡
                    break;
                case 'pcs-voltage':
                    // ç”µå‹ç”µæµè¶‹åŠ¿
                    chartInstance.data.datasets[0].data = generateData(385, 10); // ç”µå‹
                    chartInstance.data.datasets[1].data = generateData(95, 15); // ç”µæµ
                    break;
                case 'pcs-efficiency':
                    // è½¬æ¢æ•ˆç‡åˆ†æ
                    chartInstance.data.datasets[0].data = generateData(96.5, 2); // è½¬æ¢æ•ˆç‡
                    chartInstance.data.datasets[1].data = generateData(3.8, 1.5); // æŸè€—åŠŸç‡
                    break;
            }
            
            chartInstance.update();
        }
        
        // åˆå§‹åŒ–BMSå†å²æ•°æ®å›¾è¡¨
        function initBMSHistoryCharts() {
            // ç”µæ± SOCè¶‹åŠ¿
            const socCtx = document.getElementById('bms-soc-chart');
            if (socCtx) {
                new Chart(socCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'SOC',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 85),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' },
                            title: { display: false }
                        },
                        scales: {
                            y: { 
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'SOC (%)' } 
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
            
            // ç”µæ± ç”µå‹å†å² - æ˜¾ç¤ºæœ€é«˜ã€å¹³å‡ã€æœ€ä½ç”µå‹
            const voltageCtx = document.getElementById('bms-voltage-chart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'æœ€é«˜ç”µå‹',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 770),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'å¹³å‡ç”µå‹',
                            data: Array.from({length: 24}, () => Math.random() * 8 + 755),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'æœ€ä½ç”µå‹',
                            data: Array.from({length: 24}, () => Math.random() * 8 + 740),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' },
                            title: { display: false }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'ç”µå‹ (V)' },
                                min: 730,
                                max: 790
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
            
            // æ¸©åº¦åˆ†å¸ƒåˆ†æ
            const tempCtx = document.getElementById('bms-temp-chart');
            if (tempCtx) {
                new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'æœ€é«˜æ¸©åº¦',
                            data: Array.from({length: 24}, () => Math.random() * 5 + 35),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'å¹³å‡æ¸©åº¦',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 30),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'æœ€ä½æ¸©åº¦',
                            data: Array.from({length: 24}, () => Math.random() * 3 + 25),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { 
                                title: { display: true, text: 'æ¸©åº¦ (Â°C)' },
                                min: 20,
                                max: 45
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
        }
        
        // åˆå§‹åŒ–ç”µè¡¨å†å²æ•°æ®å›¾è¡¨
        function initMeterHistoryCharts() {
            // åŠŸç‡è¶‹åŠ¿åˆ†æ
            if (shouldShowField('meter', 'history', 'powerTrendAnalysis')) {
                const powerTrendCtx = document.getElementById('meter-power-trend-chart');
                if (powerTrendCtx) {
                    meterChartInstances['meter-power-trend'] = new Chart(powerTrendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'æœ‰åŠŸåŠŸç‡',
                                data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'æ— åŠŸåŠŸç‡',
                                data: Array.from({length: 24}, () => Math.random() * 20 + 20),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'è§†åœ¨åŠŸç‡',
                                data: Array.from({length: 24}, () => Math.random() * 60 + 200),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: 'åŠŸç‡ (kW/kVar/kVA)' },
                                    beginAtZero: true
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
            
            // ç”µé‡æ¶ˆè€—ç»Ÿè®¡
            if (shouldShowField('meter', 'history', 'energyConsumptionStats')) {
                const energyStatsCtx = document.getElementById('meter-energy-stats-chart');
                if (energyStatsCtx) {
                    meterChartInstances['meter-energy-stats'] = new Chart(energyStatsCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'æœ‰åŠŸç”µé‡',
                                data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            }, {
                                label: 'æ— åŠŸç”µé‡',
                                data: Array.from({length: 24}, () => Math.random() * 20 + 10),
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: '#f59e0b',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: 'ç”µé‡ (kWh/kVarh)' },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
            
            // ç”µå‹è´¨é‡ç›‘æµ‹
            if (shouldShowField('meter', 'history', 'voltageQualityMonitoring')) {
                const voltageQualityCtx = document.getElementById('meter-voltage-quality-chart');
                if (voltageQualityCtx) {
                    meterChartInstances['meter-voltage-quality'] = new Chart(voltageQualityCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'Aç›¸ç”µå‹',
                                data: Array.from({length: 24}, () => Math.random() * 10 + 375),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Bç›¸ç”µå‹',
                                data: Array.from({length: 24}, () => Math.random() * 10 + 380),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'Cç›¸ç”µå‹',
                                data: Array.from({length: 24}, () => Math.random() * 10 + 370),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: 'ç”µå‹ (V)' },
                                    min: 350,
                                    max: 400
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
            
            // è°æ³¢åˆ†æ
            if (shouldShowField('meter', 'history', 'harmonicAnalysis')) {
                const harmonicCtx = document.getElementById('meter-harmonic-chart');
                if (harmonicCtx) {
                    meterChartInstances['meter-harmonic'] = new Chart(harmonicCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['åŸºæ³¢', '2æ¬¡', '3æ¬¡', '4æ¬¡', '5æ¬¡', '6æ¬¡', '7æ¬¡', '8æ¬¡', '9æ¬¡', '10æ¬¡', '11æ¬¡', '12æ¬¡'],
                            datasets: [{
                                label: 'è°æ³¢å«é‡',
                                data: [2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',   // åŸºæ³¢ - è“è‰²
                                    'rgba(239, 68, 68, 0.8)',    // 2æ¬¡ - çº¢è‰²
                                    'rgba(245, 158, 11, 0.8)',   // 3æ¬¡ - æ©™è‰²
                                    'rgba(16, 185, 129, 0.8)',   // 5æ¬¡ - ç»¿è‰²
                                    'rgba(139, 69, 19, 0.8)',    // 7æ¬¡ - æ£•è‰²
                                    'rgba(147, 51, 234, 0.8)',   // 9æ¬¡ - ç´«è‰²
                                    'rgba(236, 72, 153, 0.8)',   // 11æ¬¡ - ç²‰è‰²
                                    'rgba(14, 165, 233, 0.8)',   // 13æ¬¡ - å¤©è“è‰²
                                    'rgba(34, 197, 94, 0.8)',    // 15æ¬¡ - æµ…ç»¿è‰²
                                    'rgba(251, 191, 36, 0.8)',   // 17æ¬¡ - é»„è‰²
                                    'rgba(168, 85, 247, 0.8)',   // 19æ¬¡ - æµ…ç´«è‰²
                                    'rgba(244, 63, 94, 0.8)'     // 21æ¬¡ - ç«çº¢è‰²
                                ],
                                borderColor: [
                                    '#3b82f6', '#ef4444', '#f59e0b', '#10b981',
                                    '#8b4513', '#9333ea', '#ec4899', '#0ea5e9',
                                    '#22c55e', '#fbbf24', '#a855f7', '#f43f5e'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: 'è°æ³¢å«é‡ (%)' },
                                    beginAtZero: true
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
        }
        
        // åˆå§‹åŒ–æ¸©åº¦å†å²æ•°æ®å›¾è¡¨
        function initThermalHistoryCharts() {
            // æ¸©åº¦åˆ†å¸ƒå†å²
            if (shouldShowField('thermal', 'history', 'tempDistribution')) {
                const tempCtx = document.getElementById('thermalTempChart');
                if (tempCtx) {
                    thermalChartInstances['thermal-temp'] = new Chart(tempCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'ç”µæ± åŒ…æœ€é«˜æ¸©åº¦',
                                data: Array.from({length: 24}, () => (39.9 + (Math.random() - 0.5) * 5).toFixed(1)),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'ç”µæ± åŒ…æœ€ä½æ¸©åº¦',
                                data: Array.from({length: 24}, () => (25.5 + (Math.random() - 0.5) * 3).toFixed(1)),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: 'ç”µæ± åŒ…å¹³å‡æ¸©åº¦',
                                data: Array.from({length: 24}, () => (32.8 + (Math.random() - 0.5) * 4).toFixed(1)),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    title: { display: true, text: 'æ¸©åº¦ (Â°C)' },
                                    min: 20,
                                    max: 50
                                }
                            }
                        }
                    });
                }
            }
            
            // å†·å´ç³»ç»Ÿè¿è¡Œ
            if (shouldShowField('thermal', 'history', 'coolingSystem')) {
                const coolingCtx = document.getElementById('thermalCoolingChart');
                if (coolingCtx) {
                    thermalChartInstances['thermal-cooling'] = new Chart(coolingCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'è¿›é£æ¸©åº¦',
                                data: Array.from({length: 24}, () => (28.5 + (Math.random() - 0.5) * 3).toFixed(1)),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y'
                            }, {
                                label: 'å‡ºé£æ¸©åº¦',
                                data: Array.from({length: 24}, () => (22.8 + (Math.random() - 0.5) * 2.5).toFixed(1)),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y'
                            }, {
                                label: 'ç›¸å¯¹æ¹¿åº¦',
                                data: Array.from({length: 24}, () => (65.2 + (Math.random() - 0.5) * 8).toFixed(1)),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'æ¸©åº¦ (Â°C)' },
                                    min: 18,
                                    max: 35
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'ç›¸å¯¹æ¹¿åº¦ (%)' },
                                    min: 50,
                                    max: 80,
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }
            }
            
            // ä¸»é£æœºè½¬é€Ÿå’Œåˆ¶å†·åŠŸè€—
            if (shouldShowField('thermal', 'history', 'heatMap')) {
                const heatMapCtx = document.getElementById('thermalHeatMapChart');
                if (heatMapCtx) {
                    thermalChartInstances['thermal-heatmap'] = new Chart(heatMapCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'ä¸»é£æœºè½¬é€Ÿ',
                                data: Array.from({length: 24}, () => (1241 + (Math.random() - 0.5) * 200).toFixed(0)),
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                yAxisID: 'y'
                            }, {
                                label: 'åˆ¶å†·åŠŸè€—',
                                data: Array.from({length: 24}, () => (5.8 + (Math.random() - 0.5) * 1.2).toFixed(1)),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                type: 'line',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'è½¬é€Ÿ (rpm)' },
                                    min: 800,
                                    max: 1600
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'åŠŸè€— (kW)' },
                                    min: 3,
                                    max: 8,
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // æ›´æ–°æ¸©åº¦å†å²å›¾è¡¨
        function updateThermalHistoryCharts() {
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨
            initThermalHistoryCharts();
        }
        
        // åˆå§‹åŒ–æ¶ˆé˜²å†å²æ•°æ®å›¾è¡¨
        function initFireHistoryCharts() {
            // ç³»ç»ŸçŠ¶æ€å†å²
            if (shouldShowField('fire', 'history', 'systemStatus')) {
                const systemCtx = document.getElementById('fireSystemChart');
                if (systemCtx) {
                    fireChartInstances['fire-system'] = new Chart(systemCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['æ­£å¸¸', 'é¢„è­¦', 'å‘Šè­¦'],
                            datasets: [{
                                data: [95, 4, 1],
                                backgroundColor: ['#10b981', '#f59e0b', '#dc2626'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
            }
            
            // æ°”ä½“æµ“åº¦ç›‘æµ‹
            if (shouldShowField('fire', 'history', 'gasConcentration')) {
                const gasCtx = document.getElementById('fireGasChart');
                if (gasCtx) {
                    fireChartInstances['fire-gas'] = new Chart(gasCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: 'COæµ“åº¦',
                                data: Array.from({length: 24}, () => Math.random() * 10 + 5),
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                borderWidth: 2,
                                tension: 0.4
                            }, {
                                label: 'çƒŸé›¾æµ“åº¦',
                                data: Array.from({length: 24}, () => Math.random() * 8 + 3),
                                borderColor: '#6b7280',
                                backgroundColor: 'rgba(107, 114, 128, 0.1)',
                                borderWidth: 2,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: 'æµ“åº¦ (ppm)' } } }
                        }
                    });
                }
            }
            
            // å‘Šè­¦è®°å½•åˆ†æ
            if (shouldShowField('fire', 'history', 'alarmHistory')) {
                const alarmCtx = document.getElementById('fireAlarmChart');
                if (alarmCtx) {
                    fireChartInstances['fire-alarm'] = new Chart(alarmCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'],
                            datasets: [{
                                label: 'çƒŸé›¾å‘Šè­¦',
                                data: [2, 1, 0, 1, 0, 1],
                                backgroundColor: 'rgba(107, 114, 128, 0.8)',
                                borderColor: '#6b7280',
                                borderWidth: 1
                            }, {
                                label: 'æ¸©åº¦å‘Šè­¦',
                                data: [1, 0, 2, 0, 1, 0],
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: '#f59e0b',
                                borderWidth: 1
                            }, {
                                label: 'æ°”ä½“å‘Šè­¦',
                                data: [0, 1, 1, 0, 0, 1],
                                backgroundColor: 'rgba(220, 38, 38, 0.8)',
                                borderColor: '#dc2626',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += context.parsed.y + ' æ¬¡';
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    title: { display: true, text: 'å‘Šè­¦æ¬¡æ•°' },
                                    ticks: {
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    stacked: true
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // æ”¶ç›Šåˆ†æå›¾è¡¨ç›¸å…³å‡½æ•°
        let revenueAnalysisChartInstance = null;
        
        // åˆå§‹åŒ–æ”¶ç›Šåˆ†æå›¾è¡¨
        function initRevenueAnalysisChart() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('revenueDatePicker').value = todayStr;
            
            updateRevenueAnalysisChart();
        }
        
        // æ›´æ–°æ”¶ç›Šåˆ†æå›¾è¡¨
        function updateRevenueAnalysisChart() {
            const timeType = document.getElementById('revenueTimeType').value;
            
            // æ§åˆ¶æ—¶é—´é€‰æ‹©å™¨çš„æ˜¾ç¤º
            document.getElementById('revenueDatePicker').style.display = timeType === 'day' ? 'block' : 'none';
            document.getElementById('revenueMonthPicker').style.display = timeType === 'month' ? 'block' : 'none';
            document.getElementById('revenueYearPicker').style.display = timeType === 'year' ? 'block' : 'none';
            
            // å¦‚æœæ˜¯æ—¥é€‰é¡¹ä½†æ²¡æœ‰è®¾ç½®æ—¥æœŸï¼Œè®¾ç½®ä¸ºä»Šå¤©
            if (timeType === 'day' && !document.getElementById('revenueDatePicker').value) {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                document.getElementById('revenueDatePicker').value = todayStr;
            }
            
            // ç”Ÿæˆå›¾è¡¨æ•°æ®
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueAnalysisData(timeType);
            
            const ctx = document.getElementById('revenueAnalysisChart');
            if (!ctx) return;
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (revenueAnalysisChartInstance) {
                revenueAnalysisChartInstance.destroy();
            }
            
            // åˆ›å»ºæ··åˆå›¾è¡¨
            revenueAnalysisChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å……ç”µé‡',
                        data: chargingData,
                        backgroundColor: '#10b981',
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'æ”¾ç”µé‡',
                        data: dischargingData,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'æ”¶ç›Š',
                        data: revenueData,
                        type: 'line',
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y1',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ç”µé‡ (kWh)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æ”¶ç›Š (å…ƒ)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'å…ƒ';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ç”Ÿæˆæ”¶ç›Šåˆ†ææ•°æ®
        function generateRevenueAnalysisData(timeType) {
            let labels = [];
            let chargingData = [];
            let dischargingData = [];
            let revenueData = [];
            
            const today = new Date();
            
            switch(timeType) {
                case 'day':
                    // 24å°æ—¶æ•°æ®
                    for (let i = 0; i < 24; i++) {
                        labels.push(i + ':00');
                        chargingData.push(Math.random() * 100 + 50);
                        dischargingData.push(Math.random() * 80 + 40);
                        revenueData.push(Math.random() * 500 + 200);
                    }
                    break;
                case 'month':
                    // ä¸€ä¸ªæœˆ31å¤©çš„æ•°æ®
                    for (let i = 1; i <= 31; i++) {
                        labels.push(i + 'æ—¥');
                        chargingData.push(Math.random() * 2000 + 1000);
                        dischargingData.push(Math.random() * 1800 + 900);
                        revenueData.push(Math.random() * 8000 + 4000);
                    }
                    break;
                case 'year':
                    // 12ä¸ªæœˆæ•°æ®
                    const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    months.forEach(month => {
                        labels.push(month);
                        chargingData.push(Math.random() * 50000 + 25000);
                        dischargingData.push(Math.random() * 45000 + 22000);
                        revenueData.push(Math.random() * 200000 + 100000);
                    });
                    break;
                case 'total':
                default:
                    // æ€»è§ˆ - æŒ‰å¹´æ˜¾ç¤º
                    const years = ['2021å¹´', '2022å¹´', '2023å¹´', '2024å¹´', '2025å¹´'];
                    years.forEach(year => {
                        labels.push(year);
                        chargingData.push(Math.random() * 600000 + 300000);
                        dischargingData.push(Math.random() * 550000 + 280000);
                        revenueData.push(Math.random() * 2500000 + 1200000);
                    });
                    break;
            }
            
            return { labels, chargingData, dischargingData, revenueData };
        }
        
        // åˆå§‹åŒ–æ•´æœºå†å²æ•°æ®å›¾è¡¨
        function initOverallHistoryCharts(timeRange = '30d', endDate = null) {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            if (!endDate) {
                const today = new Date();
                document.getElementById('historyEndDatePicker').value = today.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            // ç”Ÿæˆæ¯æ—¥æ•°æ®
            const { labels, powerData, socData } = generateHistoryDailyData(timeRange, endDate);
            
            // åŠŸç‡ä¸SOCç»¼åˆåˆ†æ
            const powerSocCtx = document.getElementById('powerSocChart');
            if (powerSocCtx) {
                new Chart(powerSocCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'åŠŸç‡',
                            data: powerData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        }, {
                            label: 'SOC',
                            data: socData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'åŠŸç‡ (kW)'
                                },
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 0) {
                                            return '#666';
                                        }
                                        return 'rgba(0, 0, 0, 0.05)';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'SOC (%)'
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // æ”¶ç›Šåˆ†æå›¾è¡¨åˆå§‹åŒ–
            initRevenueAnalysisChart();
        }
        
        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - onMouseClick
        function onMouseClick(event) {
            // onMouseClick 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - onMouseMove
        function onMouseMove(event) {
            // onMouseMove 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // çª—å£å¤§å°è°ƒæ•´
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - onWindowResize
        function onWindowResize() {
            // onWindowResize 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // åŠ¨ç”»å¾ªç¯
        // 3Dç›¸å…³å‡½æ•°å·²åˆ é™¤ - animate
        function animate() {
            // animate 3Då‡½æ•°å·²åˆ é™¤
        }
        
        // æ›´æ–°å®æ—¶æ•°æ®å€¼
        function updateRealtimeValues() {
            // æ›´æ–°æ ¸å¿ƒè¿è¡Œå‚æ•°
            const power = 100 + Math.random() * 50;
            
            const powerElement = document.getElementById('power');
            const random = Math.random();
            let isCharging = false;
            let isDischarging = false;
            let operationStatus = '';
            let statusIcon = '';
            let statusColor = '';
            
            if (random < 0.4) {
                // å……ç”µçŠ¶æ€
                isCharging = true;
                powerElement.textContent = '+' + power.toFixed(1);
                powerElement.style.color = '#10b981';
                operationStatus = 'å……ç”µä¸­';
                statusIcon = 'fa-bolt';
                statusColor = '#10b981';
            } else if (random < 0.7) {
                // æ”¾ç”µçŠ¶æ€
                isDischarging = true;
                powerElement.textContent = '-' + power.toFixed(1);
                powerElement.style.color = '#f59e0b';
                operationStatus = 'æ”¾ç”µä¸­';
                statusIcon = 'fa-battery-three-quarters';
                statusColor = '#f59e0b';
            } else {
                // å¾…æœºçŠ¶æ€
                powerElement.textContent = '0.0';
                powerElement.style.color = '#6b7280';
                operationStatus = 'å¾…æœº';
                statusIcon = 'fa-pause-circle';
                statusColor = '#6b7280';
            }
            
            // æ›´æ–°è¿è¡ŒçŠ¶æ€æ˜¾ç¤º
            const operationStatusElement = document.getElementById('operationStatusTop');
            operationStatusElement.innerHTML = `<i class="fas ${statusIcon}" style="color: ${statusColor};"></i> ${operationStatus}`;
            
            // éšæœºæ›´æ–°è®¾å¤‡çŠ¶æ€ï¼ˆåœ¨çº¿/ç¦»çº¿/æ•…éšœï¼‰
            const statusRandom = Math.random();
            const statusDot = document.getElementById('statusDotTop');
            const statusText = document.getElementById('statusTextTop');
            
            if (statusRandom < 0.85) {
                // 85% åœ¨çº¿
                statusDot.className = 'status-dot online';
                statusText.textContent = 'åœ¨çº¿';
            } else if (statusRandom < 0.95) {
                // 10% ç¦»çº¿
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ç¦»çº¿';
            } else {
                // 5% æ•…éšœ
                statusDot.className = 'status-dot fault';
                statusText.textContent = 'æ•…éšœ';
            }
            
            
            // SOCç¼“æ…¢å˜åŒ–
            const currentSOC = parseFloat(document.getElementById('soc').textContent);
            const socChange = isCharging ? 0.3 : (isDischarging ? -0.2 : 0);
            const newSOC = Math.max(0, Math.min(100, currentSOC + socChange));
            document.getElementById('soc').textContent = newSOC.toFixed(1);
            
            // æ›´æ–°SOCçŠ¶æ€æ–‡å­—
            const socStatusElement = document.getElementById('socStatus');
            if (newSOC >= 80) {
                socStatusElement.textContent = 'ç”µé‡å……è¶³';
                socStatusElement.className = 'metric-status good';
            } else if (newSOC >= 50) {
                socStatusElement.textContent = 'ç”µé‡é€‚ä¸­';
                socStatusElement.className = 'metric-status good';
            } else if (newSOC >= 20) {
                socStatusElement.textContent = 'ç”µé‡åä½';
                socStatusElement.className = 'metric-status warning';
            } else {
                socStatusElement.textContent = 'ç”µé‡ä¸è¶³';
                socStatusElement.className = 'metric-status critical';
            }
            
            // æ¸©åº¦æ›´æ–°ï¼ˆæ ¸å¿ƒè¿è¡Œå‚æ•°ä¸­çš„æ¸©åº¦ï¼‰
            const temperature = 25 + Math.random() * 8;
            document.getElementById('temperature').textContent = temperature.toFixed(1);
            
            // æ›´æ–°æ¸©åº¦çŠ¶æ€æ–‡å­—
            const tempStatusElement = document.getElementById('tempStatus');
            if (temperature <= 35) {
                tempStatusElement.textContent = 'æ¸©åº¦æ­£å¸¸';
                tempStatusElement.className = 'metric-status good';
            } else if (temperature <= 40) {
                tempStatusElement.textContent = 'æ¸©åº¦åé«˜';
                tempStatusElement.className = 'metric-status warning';
            } else {
                tempStatusElement.textContent = 'æ¸©åº¦è¿‡é«˜';
                tempStatusElement.className = 'metric-status critical';
            }
            
            // SOHç¼“æ…¢å˜åŒ–ï¼ˆå¥åº·åº¦åŸºæœ¬ç¨³å®šï¼‰
            const currentSOH = parseFloat(document.getElementById('soh').textContent);
            const sohChange = (Math.random() - 0.5) * 0.01; // å¾ˆå°çš„å˜åŒ–
            const newSOH = Math.max(90, Math.min(100, currentSOH + sohChange));
            document.getElementById('soh').textContent = newSOH.toFixed(1);
            
            // æ›´æ–°SOHçŠ¶æ€æ–‡å­—
            const sohStatusElement = document.getElementById('sohStatus');
            if (newSOH >= 95) {
                sohStatusElement.textContent = 'å¥åº·çŠ¶æ€è‰¯å¥½';
                sohStatusElement.className = 'metric-status good';
            } else if (newSOH >= 90) {
                sohStatusElement.textContent = 'å¥åº·çŠ¶æ€æ­£å¸¸';
                sohStatusElement.className = 'metric-status good';
            } else if (newSOH >= 80) {
                sohStatusElement.textContent = 'è½»åº¦è€åŒ–';
                sohStatusElement.className = 'metric-status warning';
            } else {
                sohStatusElement.textContent = 'éœ€è¦ç»´æŠ¤';
                sohStatusElement.className = 'metric-status critical';
            }
            
            // æ›´æ–°åŠŸç‡çŠ¶æ€æ–‡å­—
            const powerStatusElement = document.getElementById('powerStatus');
            if (isCharging) {
                powerStatusElement.textContent = 'å……ç”µä¸­';
                powerStatusElement.className = 'metric-status good';
            } else if (isDischarging) {
                powerStatusElement.textContent = 'æ”¾ç”µä¸­';
                powerStatusElement.className = 'metric-status warning';
            } else {
                powerStatusElement.textContent = 'å¾…æœº';
                powerStatusElement.className = 'metric-status';
            }
            
            // æ›´æ–°å……ç”µæˆæœ¬å’Œæ”¾ç”µæ”¶ç›Šï¼ˆåŸºäºä»Šæ—¥å……æ”¾ç”µé‡ï¼‰
            const todayCharge = parseFloat(document.getElementById('todayCharge').textContent);
            const todayDischarge = parseFloat(document.getElementById('todayDischarge').textContent);
            
            // å‡è®¾ä½è°·ç”µä»·0.8å…ƒ/kWhï¼Œé«˜å³°ç”µä»·1.5å…ƒ/kWh
            const chargingCost = todayCharge * 0.8;
            const dischargingRevenue = todayDischarge * 1.5;
            
            document.getElementById('chargingCost').textContent = 'Â¥' + chargingCost.toFixed(1);
            document.getElementById('dischargingRevenue').textContent = 'Â¥' + dischargingRevenue.toFixed(1);
            
            // ç¼“æ…¢æ›´æ–°ä»Šæ—¥å……æ”¾ç”µé‡
            if (isCharging) {
                document.getElementById('todayCharge').textContent = (todayCharge + 0.5).toFixed(1);
            } else if (isDischarging) {
                document.getElementById('todayDischarge').textContent = (todayDischarge + 0.4).toFixed(1);
            }
            
            // æ›´æ–°è®¾å¤‡çŠ¶æ€
            updateDeviceStatuses();
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        function updateDeviceStatuses() {
            const devices = [
                { id: 'ems', element: 'emsMarkerStatus', labelId: 'emsMarkerLabel' },
                { id: 'pcs', element: 'pcsMarkerStatus', labelId: 'pcsMarkerLabel' },
                { id: 'bms', element: 'bmsMarkerStatus', labelId: 'bmsMarkerLabel' },
                { id: 'meter', element: 'meterMarkerStatus', labelId: 'meterMarkerLabel' },
                { id: 'thermal', element: 'thermalMarkerStatus', labelId: 'thermalMarkerLabel' },
                { id: 'fire', element: 'fireMarkerStatus', labelId: 'fireMarkerLabel' }
            ];
            
            devices.forEach(device => {
                const random = Math.random();
                const dotElement = document.getElementById(device.element + 'Dot');
                const textElement = document.getElementById(device.element + 'Text');
                const labelElement = document.getElementById(device.labelId);
                
                if (!dotElement || !textElement) return;
                
                let borderColor = '';
                
                if (random < 0.7) {
                    // 70% åœ¨çº¿
                    dotElement.className = 'status-dot online';
                    textElement.textContent = 'åœ¨çº¿';
                    textElement.style.color = '#10b981';
                    borderColor = '#10b981';
                } else if (random < 0.85) {
                    // 15% ç¦»çº¿
                    dotElement.className = 'status-dot offline';
                    textElement.textContent = 'ç¦»çº¿';
                    textElement.style.color = '#f59e0b';
                    borderColor = '#f59e0b';
                } else {
                    // 15% å¼‚å¸¸
                    dotElement.className = 'status-dot fault';
                    textElement.textContent = 'å¼‚å¸¸';
                    textElement.style.color = '#ef4444';
                    borderColor = '#ef4444';
                }
                
                // æ›´æ–°æ ‡ç­¾è¾¹æ¡†é¢œè‰²
                if (labelElement) {
                    labelElement.style.borderColor = borderColor;
                }
            });
        }
        
        // å¯åŠ¨å®æ—¶æ•°æ®æ›´æ–°
        let realtimeInterval;
        function startRealtimeUpdates() {
            updateRealtimeValues();
            realtimeInterval = setInterval(updateRealtimeValues, 2000);
        }
        
        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
            }
        }
        
        // å­—æ®µè®¾ç½®ç›¸å…³åŠŸèƒ½
        const fieldConfigs = {
            overall: {
                realtime: [
                    { 
                        category: 'ç­–ç•¥è°ƒåº¦å‚æ•°',
                        fields: [
                            { id: 'currentStrategy', name: 'å½“å‰ç­–ç•¥', checked: true },
                            { id: 'dispatchCommand', name: 'è°ƒåº¦æŒ‡ä»¤', checked: true },
                            { id: 'targetSOC', name: 'ç›®æ ‡SOC', checked: true },
                            { id: 'maxPower', name: 'æœ€å¤§åŠŸç‡', checked: true }
                        ]
                    },
                    {
                        category: 'æ ¸å¿ƒè¿è¡Œå‚æ•°',
                        fields: [
                            { id: 'soc', name: 'SOC', checked: true },
                            { id: 'soh', name: 'SOH', checked: true },
                            { id: 'temperature', name: 'æ¸©åº¦', checked: true },
                            { id: 'power', name: 'å……æ”¾ç”µåŠŸç‡', checked: true },
                            { id: 'current', name: 'ç”µæ± ç”µæµ', checked: true },
                            { id: 'voltage', name: 'ç”µæ± ç”µå‹', checked: true }
                        ]
                    },
                    {
                        category: 'è¿è¡Œç»Ÿè®¡',
                        fields: [
                            { id: 'todayCharge', name: 'ä»Šæ—¥å……ç”µé‡', checked: true },
                            { id: 'todayDischarge', name: 'ä»Šæ—¥æ”¾ç”µé‡', checked: true },
                            { id: 'totalCharge', name: 'ç´¯è®¡å……ç”µé‡', checked: true },
                            { id: 'totalDischarge', name: 'ç´¯è®¡æ”¾ç”µé‡', checked: true }
                        ]
                    },
                    {
                        category: 'å…¶ä»–å‚æ•°',
                        fields: [
                            { id: 'cycles', name: 'å¾ªç¯æ¬¡æ•°', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'powerTrend', name: 'åŠŸç‡ä¸SOCç»¼åˆåˆ†æ', checked: true },
                            { id: 'efficiency', name: 'æ”¶ç›Šåˆ†æ', checked: true }
                        ]
                    }
                ]
            },
            ems: {
                realtime: [
                    {
                        category: 'CPUçŠ¶æ€',
                        fields: [
                            { id: 'cpuUsage', name: 'ä½¿ç”¨ç‡', checked: true },
                            { id: 'cpuTemp', name: 'æ¸©åº¦', checked: true }
                        ]
                    },
                    {
                        category: 'å†…å­˜çŠ¶æ€',
                        fields: [
                            { id: 'memoryUsage', name: 'å ç”¨ç‡', checked: true }
                        ]
                    },
                    {
                        category: 'ç£ç›˜çŠ¶æ€',
                        fields: [
                            { id: 'diskUsage', name: 'ç©ºé—´ä½¿ç”¨ç‡', checked: true }
                        ]
                    },
                    {
                        category: 'å¼€å‘æ¿æ¸©åº¦',
                        fields: [
                            { id: 'boardTemp', name: 'å½“å‰æ¸©åº¦', checked: true }
                        ]
                    },
                    {
                        category: '4Gç½‘ç»œçŠ¶æ€',
                        fields: [
                            { id: 'signal4G', name: 'ä¿¡å·å¼ºåº¦', checked: true },
                            { id: 'simStatus', name: 'SIMå¡çŠ¶æ€', checked: true },
                            { id: 'networkInterface', name: 'ç½‘ç»œæ¥å£', checked: true }
                        ]
                    },
                    {
                        category: 'WiFiçŠ¶æ€',
                        fields: [
                            { id: 'wifiSignal', name: 'ä¿¡å·å¼ºåº¦', checked: true },
                            { id: 'wifiInterface', name: 'WiFiç½‘ç»œæ¥å£', checked: true }
                        ]
                    },
                    {
                        category: 'ç³»ç»Ÿä¿¡æ¯',
                        fields: [
                            { id: 'uptime', name: 'ç³»ç»Ÿè¿è¡Œæ—¶é•¿', checked: true },
                            { id: 'systemTime', name: 'å½“å‰ç³»ç»Ÿæ—¶é—´', checked: true },
                            { id: 'hardwareTime', name: 'å½“å‰ç¡¬ä»¶æ—¶é—´', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'strategyHistory', name: 'EMSç­–ç•¥æ‰§è¡Œå†å²', checked: true },
                            { id: 'responseTime', name: 'è°ƒåº¦å“åº”æ—¶é—´åˆ†æ', checked: true }
                        ]
                    }
                ]
            },
            pcs: {
                realtime: [
                    {
                        category: 'PCSç”µç½‘ä¾§å‚æ•°',
                        fields: [
                            { id: 'gridVoltage', name: 'PCSç”µç½‘ä¾§ç”µå‹', checked: true },
                            { id: 'gridCurrent', name: 'PCSç”µç½‘ä¾§ç”µæµ', checked: true },
                            { id: 'gridPower', name: 'PCSç”µç½‘ä¾§åŠŸç‡', checked: true }
                        ]
                    },
                    {
                        category: 'PCSæ¸©åº¦',
                        fields: [
                            { id: 'pcsTemp', name: 'PCSæ¸©åº¦', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'powerConversion', name: 'åŠŸç‡è½¬æ¢å†å²', checked: true },
                            { id: 'voltageCurrent', name: 'ç”µå‹ç”µæµè¶‹åŠ¿', checked: true },
                            { id: 'efficiency', name: 'è½¬æ¢æ•ˆç‡åˆ†æ', checked: true }
                        ]
                    }
                ]
            },
            bms: {
                realtime: [
                    {
                        category: 'ç”µæ± ç»„ç®¡ç†å‚æ•°',
                        fields: [
                            { id: 'totalVoltage', name: 'æ€»ç”µå‹', checked: true },
                            { id: 'totalCurrent', name: 'æ€»ç”µæµ', checked: true },
                            { id: 'remainingCapacity', name: 'å‰©ä½™å®¹é‡', checked: true },
                            { id: 'cycles', name: 'å……æ”¾ç”µå¾ªç¯', checked: true },
                            { id: 'internalResistance', name: 'å†…é˜»', checked: true },
                            { id: 'insulation', name: 'ç»ç¼˜é˜»æŠ—', checked: true }
                        ]
                    },
                    {
                        category: 'å•ä½“ç”µèŠ¯ç›‘æ§',
                        fields: [
                            { id: 'maxCellVoltage', name: 'æœ€é«˜å•ä½“ç”µå‹', checked: true },
                            { id: 'minCellVoltage', name: 'æœ€ä½å•ä½“ç”µå‹', checked: true },
                            { id: 'voltageDiff', name: 'å•ä½“å‹å·®', checked: true },
                            { id: 'consistency', name: 'ç”µèŠ¯ä¸€è‡´æ€§', checked: true },
                            { id: 'abnormalCells', name: 'å¼‚å¸¸ç”µèŠ¯æ•°', checked: true },
                            { id: 'balanceStatus', name: 'å‡è¡¡çŠ¶æ€', checked: true },
                            { id: 'totalCells', name: 'ç”µèŠ¯æ€»æ•°', checked: true },
                            { id: 'samplingAccuracy', name: 'é‡‡æ ·ç²¾åº¦', checked: true }
                        ]
                    },
                    {
                        category: 'å®‰å…¨ä¿æŠ¤å‚æ•°',
                        fields: [
                            { id: 'overvoltageProtection', name: 'è¿‡å‹ä¿æŠ¤', checked: true },
                            { id: 'undervoltageProtection', name: 'æ¬ å‹ä¿æŠ¤', checked: true },
                            { id: 'overcurrentProtection', name: 'è¿‡æµä¿æŠ¤', checked: true },
                            { id: 'overtemperatureProtection', name: 'è¿‡æ¸©ä¿æŠ¤', checked: true },
                            { id: 'shortcircuitProtection', name: 'çŸ­è·¯ä¿æŠ¤', checked: true },
                            { id: 'communicationStatus', name: 'é€šä¿¡çŠ¶æ€', checked: true },
                            { id: 'faultCode', name: 'æ•…éšœä»£ç ', checked: true },
                            { id: 'hardwareVersion', name: 'ç¡¬ä»¶ç‰ˆæœ¬', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'voltageHistory', name: 'ç”µæ± ç”µå‹å†å²', checked: true },
                            { id: 'socBalance', name: 'SOCå‡è¡¡ç®¡ç†', checked: true },
                            { id: 'tempDistribution', name: 'æ¸©åº¦åˆ†å¸ƒåˆ†æ', checked: true }
                        ]
                    }
                ]
            },
            meter: {
                realtime: [
                    {
                        category: 'ç”µèƒ½è®¡é‡å‚æ•°',
                        fields: [
                            { id: 'totalActivePower', name: 'æ€»æœ‰åŠŸåŠŸç‡', checked: true },
                            { id: 'totalReactivePower', name: 'æ€»æ— åŠŸåŠŸç‡', checked: true },
                            { id: 'frequency', name: 'é¢‘ç‡', checked: true },
                            { id: 'powerFactor', name: 'åŠŸç‡å› æ•°', checked: true }
                        ]
                    },
                    {
                        category: 'ä¸‰ç›¸ç”µå‹',
                        fields: [
                            { id: 'phaseAVoltage', name: 'Aç›¸ç”µå‹', checked: true },
                            { id: 'phaseBVoltage', name: 'Bç›¸ç”µå‹', checked: true },
                            { id: 'phaseCVoltage', name: 'Cç›¸ç”µå‹', checked: true }
                        ]
                    },
                    {
                        category: 'ä¸‰ç›¸ç”µæµ',
                        fields: [
                            { id: 'phaseACurrent', name: 'Aç›¸ç”µæµ', checked: true },
                            { id: 'phaseBCurrent', name: 'Bç›¸ç”µæµ', checked: true },
                            { id: 'phaseCCurrent', name: 'Cç›¸ç”µæµ', checked: true }
                        ]
                    },
                    {
                        category: 'ç”µèƒ½ç»Ÿè®¡',
                        fields: [
                            { id: 'dailyActiveEnergy', name: 'æ—¥æœ‰åŠŸç”µé‡', checked: true },
                            { id: 'dailyReactiveEnergy', name: 'æ—¥æ— åŠŸç”µé‡', checked: true },
                            { id: 'totalActiveEnergy', name: 'ç´¯è®¡æœ‰åŠŸç”µé‡', checked: true },
                            { id: 'totalReactiveEnergy', name: 'ç´¯è®¡æ— åŠŸç”µé‡', checked: true },
                            { id: 'totalApparentPower', name: 'æ€»è§†åœ¨åŠŸç‡', checked: true },
                            { id: 'meterStatus', name: 'ç”µè¡¨çŠ¶æ€', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'powerTrendAnalysis', name: 'åŠŸç‡è¶‹åŠ¿åˆ†æ', checked: true },
                            { id: 'energyConsumptionStats', name: 'ç”µé‡æ¶ˆè€—ç»Ÿè®¡', checked: true },
                            { id: 'voltageQualityMonitoring', name: 'ç”µå‹è´¨é‡ç›‘æµ‹', checked: true },
                            { id: 'harmonicAnalysis', name: 'è°æ³¢åˆ†æ', checked: true }
                        ]
                    }
                ]
            },
            thermal: {
                realtime: [
                    {
                        category: 'è¿è¡ŒçŠ¶æ€',
                        fields: [
                            { id: 'cabinetTemp', name: 'å‚¨èƒ½æŸœæ¸©åº¦', checked: true },
                            { id: 'runningMode', name: 'è¿è¡Œæ¨¡å¼', checked: true },
                            { id: 'humidity', name: 'ç›¸å¯¹æ¹¿åº¦', checked: true }
                        ]
                    },
                    {
                        category: 'æ ¸å¿ƒç›‘æ§å‚æ•°',
                        fields: [
                            { id: 'battMaxTemp', name: 'ç”µæ± åŒ…æœ€é«˜æ¸©åº¦', checked: true },
                            { id: 'battMinTemp', name: 'ç”µæ± åŒ…æœ€ä½æ¸©åº¦', checked: true },
                            { id: 'battAvgTemp', name: 'ç”µæ± åŒ…å¹³å‡æ¸©åº¦', checked: true },
                            { id: 'battTempDiff', name: 'ç”µæ± åŒ…æ¸©å·®', checked: true },
                            { id: 'inletTemp', name: 'è¿›é£æ¸©åº¦', checked: true },
                            { id: 'outletTemp', name: 'å‡ºé£æ¸©åº¦', checked: true },
                            { id: 'coolantTemp', name: 'å†·å´æ¶²æ¸©åº¦', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'tempDistribution', name: 'æ¸©åº¦åˆ†å¸ƒå†å²', checked: true },
                            { id: 'coolingSystem', name: 'å†·å´ç³»ç»Ÿè¿è¡Œ', checked: true },
                            { id: 'heatMap', name: 'ä¸»é£æœºè½¬é€Ÿä¸åˆ¶å†·åŠŸè€—', checked: true }
                        ]
                    }
                ]
            },
            fire: {
                realtime: [
                    {
                        category: 'ç«ç¾æ¢æµ‹',
                        fields: [
                            { id: 'smokeDetector', name: 'çƒŸæ„Ÿæ¢æµ‹å™¨', checked: true },
                            { id: 'fireAlarmStatus', name: 'ç«è­¦çŠ¶æ€', checked: true }
                        ]
                    },
                    {
                        category: 'æ¶ˆé˜²è”åŠ¨',
                        fields: [
                            { id: 'extinguisherStatus', name: 'ç­ç«å™¨çŠ¶æ€', checked: true },
                            { id: 'emergencyShutdown', name: 'ç´§æ€¥åœæœº', checked: true },
                            { id: 'alarmDevice', name: 'å£°å…‰æŠ¥è­¦å™¨', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        category: 'å›¾è¡¨',
                        fields: [
                            { id: 'systemStatus', name: 'ç³»ç»ŸçŠ¶æ€å†å²', checked: true },
                            { id: 'gasConcentration', name: 'æ°”ä½“æµ“åº¦ç›‘æµ‹', checked: true },
                            { id: 'alarmHistory', name: 'å‘Šè­¦è®°å½•åˆ†æ', checked: true }
                        ]
                    }
                ]
            }
        };
        
        // ä¿å­˜ç”¨æˆ·çš„å­—æ®µè®¾ç½®
        let userFieldSettings = JSON.parse(localStorage.getItem('fieldSettings') || '{}');
        
        // ç”Ÿæˆå›¾è¡¨é¢„è§ˆ
        function getChartPreview(fieldId) {
            // å®šä¹‰ç½‘æ ¼æ ·å¼
            const gridDefs = `
                <defs>
                    <pattern id="grid" width="20" height="16" patternUnits="userSpaceOnUse">
                        <path d="M 20 0 L 0 0 0 16" fill="none" stroke="var(--border-color)" stroke-width="0.5" opacity="0.3"/>
                    </pattern>
                </defs>
            `;
            
            switch(fieldId) {
                // æ•´æœºç»„ä»¶å›¾è¡¨
                case 'powerTrend':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,50 Q30,30 50,35 T90,40 Q110,25 130,30 T170,35 Q190,45 190,40" 
                                  fill="none" stroke="#10b981" stroke-width="2" opacity="0.8"/>
                            <path d="M10,50 Q30,30 50,35 T90,40 Q110,25 130,30 T170,35 Q190,45 190,40 L190,70 L10,70 Z" 
                                  fill="#10b981" opacity="0.1"/>
                            <path d="M10,60 Q30,65 50,62 T90,58 Q110,55 130,52 T170,48 Q190,50 190,45" 
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">åŠŸç‡ & SOC</text>
                        </svg>
                    `;
                case 'efficiency':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="40" width="12" height="25" fill="#10b981" opacity="0.8"/>
                            <rect x="40" y="35" width="12" height="30" fill="#10b981" opacity="0.8"/>
                            <rect x="60" y="45" width="12" height="20" fill="#10b981" opacity="0.8"/>
                            <rect x="32" y="42" width="12" height="23" fill="#3b82f6" opacity="0.8"/>
                            <rect x="52" y="37" width="12" height="28" fill="#3b82f6" opacity="0.8"/>
                            <rect x="72" y="47" width="12" height="18" fill="#3b82f6" opacity="0.8"/>
                            <path d="M25,55 Q45,45 65,40 T105,35 Q125,30 145,25 T185,20" 
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.9"/>
                            <circle cx="25" cy="55" r="2" fill="#f59e0b"/>
                            <circle cx="65" cy="40" r="2" fill="#f59e0b"/>
                            <circle cx="105" cy="35" r="2" fill="#f59e0b"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">å……æ”¾ç”µ & æ”¶ç›Š</text>
                        </svg>
                    `;
                
                // EMSç»„ä»¶å›¾è¡¨
                case 'strategyHistory':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="15" y="45" width="25" height="20" fill="#10b981" opacity="0.7"/>
                            <rect x="50" y="35" width="30" height="30" fill="#3b82f6" opacity="0.7"/>
                            <rect x="90" y="40" width="35" height="25" fill="#f59e0b" opacity="0.7"/>
                            <rect x="135" y="30" width="25" height="35" fill="#8b5cf6" opacity="0.7"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">ç­–ç•¥æ‰§è¡Œ</text>
                        </svg>
                    `;
                case 'responseTime':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 L30,45 L50,50 L70,35 L90,40 L110,30 L130,45 L150,35 L170,40 L190,30" 
                                  fill="none" stroke="#ef4444" stroke-width="2" opacity="0.8"/>
                            <circle cx="30" cy="45" r="2" fill="#ef4444"/>
                            <circle cx="70" cy="35" r="2" fill="#ef4444"/>
                            <circle cx="110" cy="30" r="2" fill="#ef4444"/>
                            <circle cx="150" cy="35" r="2" fill="#ef4444"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">å“åº”æ—¶é—´</text>
                        </svg>
                    `;
                
                // PCSç»„ä»¶å›¾è¡¨
                case 'powerConversion':
                case 'voltageCurrent':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,40 Q30,25 50,30 T90,35 Q110,20 130,25 T170,30 Q190,40 190,35" 
                                  fill="none" stroke="#10b981" stroke-width="2" opacity="0.8"/>
                            <path d="M10,55 Q30,50 50,45 T90,50 Q110,45 130,40 T170,45 Q190,55 190,50" 
                                  fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">åŠŸç‡è½¬æ¢</text>
                        </svg>
                    `;
                
                // BMSç»„ä»¶å›¾è¡¨
                case 'voltageHistory':
                case 'socBalance':
                case 'tempDistribution':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="50" width="8" height="15" fill="#10b981" opacity="0.8"/>
                            <rect x="35" y="45" width="8" height="20" fill="#10b981" opacity="0.8"/>
                            <rect x="50" y="55" width="8" height="10" fill="#10b981" opacity="0.8"/>
                            <rect x="65" y="40" width="8" height="25" fill="#10b981" opacity="0.8"/>
                            <rect x="80" y="48" width="8" height="17" fill="#10b981" opacity="0.8"/>
                            <path d="M15,35 Q40,30 65,25 T115,20 Q140,15 165,20 T190,25" 
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">ç”µæ± ç®¡ç†</text>
                        </svg>
                    `;
                
                // ç”µæ± ç»„ä»¶å›¾è¡¨
                case 'performance':
                case 'cycles':
                case 'capacity':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,35 T170,30 Q190,25 190,30" 
                                  fill="none" stroke="#8b5cf6" stroke-width="2" opacity="0.8"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,35 T170,30 Q190,25 190,30 L190,70 L10,70 Z" 
                                  fill="#8b5cf6" opacity="0.1"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">ç”µæ± æ€§èƒ½</text>
                        </svg>
                    `;
                
                // æ¸©åº¦ç»„ä»¶å›¾è¡¨
                case 'tempDistribution':
                case 'coolingSystem':
                case 'heatMap':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="30" width="15" height="15" fill="#ef4444" opacity="0.6"/>
                            <rect x="40" y="35" width="15" height="15" fill="#f59e0b" opacity="0.6"/>
                            <rect x="60" y="40" width="15" height="15" fill="#10b981" opacity="0.6"/>
                            <rect x="80" y="35" width="15" height="15" fill="#3b82f6" opacity="0.6"/>
                            <rect x="100" y="30" width="15" height="15" fill="#8b5cf6" opacity="0.6"/>
                            <path d="M10,60 Q50,55 90,50 T150,45 Q170,40 190,35" 
                                  fill="none" stroke="#ef4444" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">æ¸©åº¦åˆ†æ</text>
                        </svg>
                    `;
                
                // æ¶ˆé˜²ç»„ä»¶å›¾è¡¨
                case 'systemStatus':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <circle cx="50" cy="40" r="35" fill="none" stroke="#10b981" stroke-width="3" opacity="0.8"/>
                            <circle cx="50" cy="40" r="25" fill="#10b981" opacity="0.6"/>
                            <circle cx="50" cy="40" r="15" fill="#f59e0b" opacity="0.3"/>
                            <circle cx="50" cy="40" r="8" fill="#ef4444" opacity="0.4"/>
                            <text x="110" y="20" font-size="8" fill="#10b981">æ­£å¸¸ 95%</text>
                            <text x="110" y="35" font-size="8" fill="#f59e0b">é¢„è­¦ 4%</text>
                            <text x="110" y="50" font-size="8" fill="#ef4444">å‘Šè­¦ 1%</text>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">ç³»ç»ŸçŠ¶æ€</text>
                        </svg>
                    `;
                case 'gasConcentration':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,42 T170,45 Q190,50 190,48" 
                                  fill="none" stroke="#dc2626" stroke-width="2" opacity="0.8"/>
                            <path d="M10,65 Q30,62 50,58 T90,55 Q110,52 130,54 T170,56 Q190,60 190,58" 
                                  fill="none" stroke="#6b7280" stroke-width="2" opacity="0.6"/>
                            <circle cx="50" cy="50" r="2" fill="#dc2626"/>
                            <circle cx="90" cy="45" r="2" fill="#dc2626"/>
                            <circle cx="130" cy="42" r="2" fill="#dc2626"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">æ°”ä½“æµ“åº¦</text>
                        </svg>
                    `;
                case 'alarmHistory':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="45" width="15" height="20" fill="#6b7280" opacity="0.8"/>
                            <rect x="40" y="50" width="15" height="15" fill="#f59e0b" opacity="0.8"/>
                            <rect x="60" y="40" width="15" height="25" fill="#dc2626" opacity="0.8"/>
                            <rect x="80" y="55" width="15" height="10" fill="#6b7280" opacity="0.8"/>
                            <rect x="100" y="48" width="15" height="17" fill="#f59e0b" opacity="0.8"/>
                            <rect x="120" y="52" width="15" height="13" fill="#dc2626" opacity="0.8"/>
                            <rect x="140" y="58" width="15" height="7" fill="#6b7280" opacity="0.8"/>
                            <rect x="160" y="46" width="15" height="19" fill="#f59e0b" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">å‘Šè­¦è®°å½•</text>
                        </svg>
                    `;
                
                default:
                    return `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 12px;">
                            å›¾è¡¨é¢„è§ˆ
                        </div>
                    `;
            }
        }
        
        // æ‰“å¼€å­—æ®µè®¾ç½®
        function openFieldSettings() {
            try {
                console.log('å¼€å§‹æ‰“å¼€å­—æ®µè®¾ç½®, å½“å‰ç»„ä»¶:', currentComponent);
                
                const modal = document.getElementById('fieldSettingsModal');
                const content = document.getElementById('fieldSettingsContent');
                const modalTitle = document.getElementById('modalTitle');
                
                if (!modal || !content || !modalTitle) {
                    console.error('å­—æ®µè®¾ç½®æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                const currentTab = document.querySelector('.data-tab.active').textContent;
                const dataType = currentTab === 'å®æ—¶æ•°æ®' ? 'realtime' : 'history';
                
                console.log('å½“å‰æ ‡ç­¾é¡µ:', currentTab, 'æ•°æ®ç±»å‹:', dataType);
                
                // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
                const titleText = `${currentTab} - ${getComponentName(currentComponent)}`;
                modalTitle.textContent = titleText;
            
                // è·å–å½“å‰ç»„ä»¶çš„å­—æ®µé…ç½®
                const categories = fieldConfigs[currentComponent]?.[dataType];
                if (!categories) {
                    console.error('æœªæ‰¾åˆ°å­—æ®µé…ç½®:', currentComponent, dataType);
                    alert(`æœªæ‰¾åˆ°${getComponentName(currentComponent)}çš„å­—æ®µé…ç½®`);
                    return;
                }
                
                const savedSettings = userFieldSettings[currentComponent]?.[dataType] || {};
                
                // ç”Ÿæˆå­—æ®µåˆ—è¡¨HTML
                let html = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--text-secondary);">é€‰æ‹©è¦æ˜¾ç¤ºçš„æ•°æ®å­—æ®µï¼š</p>
                    </div>
                `;
                
                // æŒ‰åˆ†ç±»æ˜¾ç¤ºå­—æ®µ
                categories.forEach((category, index) => {
                    html += `
                    <div style="margin-bottom: 20px; ${index > 0 ? 'margin-top: 24px;' : ''}">
                        <h5 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                            ${category.category}
                        </h5>
                        <div style="display: grid; gap: 10px;">
                `;
                
                category.fields.forEach(field => {
                    const checked = savedSettings[field.id] !== undefined ? savedSettings[field.id] : field.checked;
                    
                    // å¦‚æœæ˜¯å›¾è¡¨åˆ†ç±»ï¼Œæ˜¾ç¤ºä¸ºå›¾è¡¨é¢„è§ˆ  
                    if (category.category === 'å›¾è¡¨') {
                        html += `
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; background: var(--bg-secondary);">
                                <input type="checkbox" id="field_${field.id}" value="${field.id}" ${checked ? 'checked' : ''} 
                                       style="width: 16px; height: 16px; cursor: pointer; margin-top: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">${field.name}</div>
                                    <div style="width: 100%; height: 80px; background: var(--bg-primary); border-radius: 4px; position: relative; overflow: hidden;">
                                        ${getChartPreview(field.id)}
                                    </div>
                                </div>
                            </label>
                        `;
                    } else {
                        // å…¶ä»–åˆ†ç±»ä¿æŒåŸæœ‰æ ·å¼
                        html += `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 0;">
                                <input type="checkbox" id="field_${field.id}" value="${field.id}" ${checked ? 'checked' : ''} 
                                       style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-size: 14px;">${field.name}</span>
                            </label>
                        `;
                    }
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = html;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.style.display = 'flex';
                
                console.log('å­—æ®µè®¾ç½®æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
            } catch (error) {
                console.error('æ‰“å¼€å­—æ®µè®¾ç½®æ—¶å‡ºé”™:', error);
                alert('æ‰“å¼€è®¾ç½®æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // å…³é—­å­—æ®µè®¾ç½®
        function closeFieldSettings() {
            document.getElementById('fieldSettingsModal').style.display = 'none';
        }
        
        // ä¿å­˜å­—æ®µè®¾ç½®
        function saveFieldSettings() {
            const currentTab = document.querySelector('.data-tab.active').textContent;
            const dataType = currentTab === 'å®æ—¶æ•°æ®' ? 'realtime' : 'history';
            const categories = fieldConfigs[currentComponent][dataType];
            
            // åˆå§‹åŒ–è®¾ç½®å¯¹è±¡
            if (!userFieldSettings[currentComponent]) {
                userFieldSettings[currentComponent] = {};
            }
            if (!userFieldSettings[currentComponent][dataType]) {
                userFieldSettings[currentComponent][dataType] = {};
            }
            
            // ä¿å­˜æ¯ä¸ªå­—æ®µçš„çŠ¶æ€
            categories.forEach(category => {
                category.fields.forEach(field => {
                    const checkbox = document.getElementById(`field_${field.id}`);
                    if (checkbox) {
                        userFieldSettings[currentComponent][dataType][field.id] = checkbox.checked;
                    }
                });
            });
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('fieldSettings', JSON.stringify(userFieldSettings));
            
            // å…³é—­æ¨¡æ€æ¡†
            closeFieldSettings();
            
            // åˆ·æ–°å½“å‰è§†å›¾
            if (dataType === 'realtime') {
                updateComponentData(currentComponent);
            } else {
                initHistoryCharts();
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
        function resetFieldSettings() {
            const currentTab = document.querySelector('.data-tab.active').textContent;
            const dataType = currentTab === 'å®æ—¶æ•°æ®' ? 'realtime' : 'history';
            const categories = fieldConfigs[currentComponent][dataType];
            
            // æ¢å¤é»˜è®¤é€‰ä¸­çŠ¶æ€
            categories.forEach(category => {
                category.fields.forEach(field => {
                    const checkbox = document.getElementById(`field_${field.id}`);
                    if (checkbox) {
                        checkbox.checked = field.checked;
                    }
                });
            });
        }
        
        // è·å–ç»„ä»¶åç§°
        function getComponentName(component) {
            const names = {
                overall: 'æ•´æœº',
                ems: 'EMS',
                pcs: 'é€†å˜å™¨',
                bms: 'BMS',
                meter: 'ç”µè¡¨',
                thermal: 'æ¸©åº¦',
                fire: 'æ¶ˆé˜²'
            };
            return names[component] || component;
        }
        
        // æ£€æŸ¥å­—æ®µæ˜¯å¦åº”è¯¥æ˜¾ç¤º
        function shouldShowField(component, dataType, fieldId) {
            const settings = userFieldSettings[component]?.[dataType];
            if (settings && settings[fieldId] !== undefined) {
                return settings[fieldId];
            }
            // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
            const categories = fieldConfigs[component][dataType];
            for (let category of categories) {
                const field = category.fields.find(f => f.id === fieldId);
                if (field) {
                    return field.checked;
                }
            }
            return true;
        }

        // ç”ŸæˆPCSä¸“ç”¨HTML - ä¸‰ç›¸æ•°æ®åˆå¹¶æ˜¾ç¤º
        function generatePCSHTML() {
            // è·å–PCSæ•°æ®
            const pcsData = {
                gridVoltageA: getFieldData('pcs', 'gridVoltageA') || { value: '<span>385.5</span>' },
                gridVoltageB: getFieldData('pcs', 'gridVoltageB') || { value: '<span>386.2</span>' },
                gridVoltageC: getFieldData('pcs', 'gridVoltageC') || { value: '<span>384.3</span>' },
                gridCurrentA: getFieldData('pcs', 'gridCurrentA') || { value: '<span>96.5</span>' },
                gridCurrentB: getFieldData('pcs', 'gridCurrentB') || { value: '<span>89.9</span>' },
                gridCurrentC: getFieldData('pcs', 'gridCurrentC') || { value: '<span>85.2</span>' },
                gridPowerA: getFieldData('pcs', 'gridPowerA') || { value: '<span>58.5</span>' },
                gridPowerB: getFieldData('pcs', 'gridPowerB') || { value: '<span>55.7</span>' },
                gridPowerC: getFieldData('pcs', 'gridPowerC') || { value: '<span>58.8</span>' },
                pcsTemp: getFieldData('pcs', 'pcsTemp') || { value: '<span>57.3</span>' }
            };
            
            let html = '';
            
            // PCSç”µç½‘ä¾§å‚æ•° section
            const showVoltage = shouldShowField('pcs', 'realtime', 'gridVoltage');
            const showCurrent = shouldShowField('pcs', 'realtime', 'gridCurrent');
            const showPower = shouldShowField('pcs', 'realtime', 'gridPower');
            
            if (showVoltage || showCurrent || showPower) {
                html += `
                    <!-- PCSç”µç½‘ä¾§å‚æ•° -->
                    <div class="metrics-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">PCSç”µç½‘ä¾§å‚æ•°</h3>
                            <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                <i class="fas fa-cog"></i>
                                <span>è®¾ç½®</span>
                            </button>
                        </div>
                        <div class="metrics-grid">
                `;
                
                // PCSç”µç½‘ä¾§ç”µå‹
                if (showVoltage) {
                    html += `
                        <!-- PCSç”µç½‘ä¾§ç”µå‹ - ä¸‰ç›¸åˆå¹¶ -->
                        <div class="metric-card">
                            <div class="metric-label">PCSç”µç½‘ä¾§ç”µå‹</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Aç›¸</span>
                                    <span class="metric-value">${pcsData.gridVoltageA.value} <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Bç›¸</span>
                                    <span class="metric-value">${pcsData.gridVoltageB.value} <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Cç›¸</span>
                                    <span class="metric-value">${pcsData.gridVoltageC.value} <span class="metric-unit">V</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // PCSç”µç½‘ä¾§ç”µæµ
                if (showCurrent) {
                    html += `
                        <!-- PCSç”µç½‘ä¾§ç”µæµ - ä¸‰ç›¸åˆå¹¶ -->
                        <div class="metric-card">
                            <div class="metric-label">PCSç”µç½‘ä¾§ç”µæµ</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Aç›¸</span>
                                    <span class="metric-value">${pcsData.gridCurrentA.value} <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Bç›¸</span>
                                    <span class="metric-value">${pcsData.gridCurrentB.value} <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Cç›¸</span>
                                    <span class="metric-value">${pcsData.gridCurrentC.value} <span class="metric-unit">A</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // PCSç”µç½‘ä¾§åŠŸç‡
                if (showPower) {
                    html += `
                        <!-- PCSç”µç½‘ä¾§åŠŸç‡ - ä¸‰ç›¸åˆå¹¶ -->
                        <div class="metric-card">
                            <div class="metric-label">PCSç”µç½‘ä¾§åŠŸç‡</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Aç›¸</span>
                                    <span class="metric-value">${pcsData.gridPowerA.value} <span class="metric-unit">kW</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Bç›¸</span>
                                    <span class="metric-value">${pcsData.gridPowerB.value} <span class="metric-unit">kW</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Cç›¸</span>
                                    <span class="metric-value">${pcsData.gridPowerC.value} <span class="metric-unit">kW</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // PCSæ¸©åº¦ - ç‹¬ç«‹æ¨¡å—
            if (shouldShowField('pcs', 'realtime', 'pcsTemp')) {
                html += `
                    <!-- PCSæ¸©åº¦ - ç‹¬ç«‹æ¨¡å— -->
                    <div class="metrics-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">PCSæ¸©åº¦</h3>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">PCSæ¸©åº¦</div>
                                <div class="metric-value">
                                    ${pcsData.pcsTemp.value}
                                    <span class="metric-unit">Â°C</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">æ¸©åº¦æ­£å¸¸</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // ç”ŸæˆBMSä¸“ç”¨HTML
        function generateBMSHTML() {
            return `
                <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">æ ¸å¿ƒæŒ‡æ ‡</h3>
                        <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-cog"></i>
                            <span>è®¾ç½®</span>
                        </button>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">ç”µæ± æ€»ç”µæµ</div>
                            <div class="metric-value">173.0 <span class="metric-unit">A</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">ç”µæµç¨³å®š</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ç”µæ± åŠŸç‡</div>
                            <div class="metric-value">141.6 <span class="metric-unit">kW</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">åŠŸç‡ç¨³å®š</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">SOC</div>
                            <div class="metric-value">100.0 <span class="metric-unit">%</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">SOH</div>
                            <div class="metric-value">98.1 <span class="metric-unit">%</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">SOHè‰¯å¥½</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Pack</div>
                            <div class="metric-value">4 <span class="metric-unit">ä¸ª</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">å¾ªç¯æ¬¡æ•°</div>
                            <div class="metric-value">2786 <span class="metric-unit">æ¬¡</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">å¯¿å‘½æ­£å¸¸</div>
                        </div>
                    </div>
                </div>
                
                <!-- è¿è¡Œç»Ÿè®¡ -->
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">è¿è¡Œç»Ÿè®¡</h3>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">æ—¥å……ç”µé‡</div>
                            <div class="metric-value">335.9 <span class="metric-unit">kWh</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">æ—¥æ”¾ç”µé‡</div>
                            <div class="metric-value">261.9 <span class="metric-unit">kWh</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ç´¯è®¡å……ç”µé‡</div>
                            <div class="metric-value">1262 <span class="metric-unit">MWh</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">ç´¯è®¡æ”¾ç”µé‡</div>
                            <div class="metric-value">1197 <span class="metric-unit">MWh</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Packç”µæ± ç°‡ä¿¡æ¯ -->
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">Packç”µæ± ç°‡ä¿¡æ¯</h3>
                    </div>
                    <div class="metrics-grid">
                        <!-- Pack1 -->
                        <div class="metric-card">
                            <div class="metric-label">Pack1</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ­£å¸¸</span>
                                    <span style="padding: 2px 8px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 12px;">æ­£å¸¸</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µå‹</span>
                                    <span class="metric-value">192.1 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µæµ</span>
                                    <span class="metric-value">43.1 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOC</span>
                                    <span class="metric-value">88.1 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOH</span>
                                    <span class="metric-value">97.2 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ¸©åº¦</span>
                                    <span class="metric-value">32.0 <span class="metric-unit">Â°C</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pack2 -->
                        <div class="metric-card">
                            <div class="metric-label">Pack2</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ­£å¸¸</span>
                                    <span style="padding: 2px 8px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 12px;">æ­£å¸¸</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µå‹</span>
                                    <span class="metric-value">190.6 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µæµ</span>
                                    <span class="metric-value">44.5 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOC</span>
                                    <span class="metric-value">87.0 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOH</span>
                                    <span class="metric-value">97.9 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ¸©åº¦</span>
                                    <span class="metric-value">31.3 <span class="metric-unit">Â°C</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pack3 -->
                        <div class="metric-card">
                            <div class="metric-label">Pack3</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ­£å¸¸</span>
                                    <span style="padding: 2px 8px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 12px;">æ­£å¸¸</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µå‹</span>
                                    <span class="metric-value">190.1 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µæµ</span>
                                    <span class="metric-value">46.0 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOC</span>
                                    <span class="metric-value">91.5 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOH</span>
                                    <span class="metric-value">98.3 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ¸©åº¦</span>
                                    <span class="metric-value">30.5 <span class="metric-unit">Â°C</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pack4 -->
                        <div class="metric-card">
                            <div class="metric-label">Pack4</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ­£å¸¸</span>
                                    <span style="padding: 2px 8px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 12px;">æ­£å¸¸</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µå‹</span>
                                    <span class="metric-value">193.2 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">ç”µæµ</span>
                                    <span class="metric-value">39.9 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOC</span>
                                    <span class="metric-value">92.6 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">SOH</span>
                                    <span class="metric-value">96.7 <span class="metric-unit">%</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">æ¸©åº¦</span>
                                    <span class="metric-value">29.0 <span class="metric-unit">Â°C</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ç”Ÿæˆç”µè¡¨HTMLçš„ä¸“ç”¨å‡½æ•°
        function generateMeterHTML() {
            let html = `
                <!-- åŠŸç‡å‚æ•° -->
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="section-title">åŠŸç‡å‚æ•°</div>
                        <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-cog"></i>
                            <span>è®¾ç½®</span>
                        </button>
                    </div>
                    <div class="metrics-grid">
            `;
            
            // æ€»æœ‰åŠŸåŠŸç‡
            if (shouldShowField('meter', 'realtime', 'totalActivePower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label">æ€»æœ‰åŠŸåŠŸç‡</div>
                        <div class="metric-value">
                            <span id="meter-total-active-power">184.4</span>
                            <span class="metric-unit">kW</span>
                        </div>
                    </div>
                `;
            }
            
            // æ€»æ— åŠŸåŠŸç‡
            if (shouldShowField('meter', 'realtime', 'totalReactivePower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label">æ€»æ— åŠŸåŠŸç‡</div>
                        <div class="metric-value">
                            <span id="meter-total-reactive-power">31.9</span>
                            <span class="metric-unit">kVar</span>
                        </div>
                    </div>
                `;
            }
            
            // æ€»è§†åœ¨åŠŸç‡
            if (shouldShowField('meter', 'realtime', 'totalApparentPower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label">æ€»è§†åœ¨åŠŸç‡</div>
                        <div class="metric-value">
                            <span id="meter-total-apparent-power">255.4</span>
                            <span class="metric-unit">kVA</span>
                        </div>
                    </div>
                `;
            }
            
            // é¢‘ç‡
            if (shouldShowField('meter', 'realtime', 'frequency')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label">é¢‘ç‡</div>
                        <div class="metric-value">
                            <span id="meter-frequency">50.0</span>
                            <span class="metric-unit">Hz</span>
                        </div>
                        <div class="metric-status good">é¢‘ç‡ç¨³å®š</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç”µå‹ç”µæµéƒ¨åˆ†
            const showVoltage = shouldShowField('meter', 'realtime', 'phaseAVoltage') || 
                               shouldShowField('meter', 'realtime', 'phaseBVoltage') || 
                               shouldShowField('meter', 'realtime', 'phaseCVoltage');
            const showCurrent = shouldShowField('meter', 'realtime', 'phaseACurrent') || 
                               shouldShowField('meter', 'realtime', 'phaseBCurrent') || 
                               shouldShowField('meter', 'realtime', 'phaseCCurrent');
            
            if (showVoltage || showCurrent) {
                html += `
                    <!-- ç”µå‹ç”µæµ -->
                    <div class="metrics-section" style="margin-top: 20px;">
                        <div class="section-title">ç”µå‹ç”µæµ</div>
                        <div class="metrics-grid">
                `;
                
                // ç”µè¡¨ç”µå‹
                if (showVoltage) {
                    html += `
                        <!-- ç”µè¡¨ç”µå‹ - ä¸‰ç›¸åˆå¹¶ -->
                        <div class="metric-card">
                            <div class="metric-label">ç”µè¡¨ç”µå‹</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Aç›¸</span>
                                    <span class="metric-value">385.0 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Bç›¸</span>
                                    <span class="metric-value">388.7 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Cç›¸</span>
                                    <span class="metric-value">380.0 <span class="metric-unit">V</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // ç”µè¡¨ç”µæµ
                if (showCurrent) {
                    html += `
                        <!-- ç”µè¡¨ç”µæµ - ä¸‰ç›¸åˆå¹¶ -->
                        <div class="metric-card">
                            <div class="metric-label">ç”µè¡¨ç”µæµ</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Aç›¸</span>
                                    <span class="metric-value">163.7 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Bç›¸</span>
                                    <span class="metric-value">174.2 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);">Cç›¸</span>
                                    <span class="metric-value">163.0 <span class="metric-unit">A</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // ç¬¬ä¸‰ä¸ªå¡ç‰‡ä½ç½®é¢„ç•™ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
                if ((showVoltage && showCurrent) || (!showVoltage && !showCurrent)) {
                    html += `
                        <!-- ç¬¬ä¸‰ä¸ªå¡ç‰‡ä½ç½®é¢„ç•™ -->
                        <div class="metric-card" style="visibility: hidden;">
                            <!-- å ä½ç¬¦ï¼Œä¿æŒç½‘æ ¼å¸ƒå±€ -->
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç”µèƒ½ç»Ÿè®¡éƒ¨åˆ†
            const showEnergy = shouldShowField('meter', 'realtime', 'dailyActiveEnergy') || 
                              shouldShowField('meter', 'realtime', 'totalActiveEnergy');
            
            if (showEnergy) {
                html += `
                    <!-- ç”µèƒ½ç»Ÿè®¡ -->
                    <div class="metrics-section" style="margin-top: 20px;">
                        <div class="section-title">ç”µèƒ½ç»Ÿè®¡</div>
                        <div class="metrics-grid">
                `;
                
                // æ—¥æœ‰åŠŸç”µé‡
                if (shouldShowField('meter', 'realtime', 'dailyActiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label">æ—¥æœ‰åŠŸç”µé‡</div>
                            <div class="metric-value">
                                <span id="meter-daily-active-energy">1529.2</span>
                                <span class="metric-unit">kWh</span>
                            </div>
                        </div>
                    `;
                }
                
                // æ—¥æ— åŠŸç”µé‡ (å¦‚æœæœ‰é…ç½®çš„è¯)
                if (shouldShowField('meter', 'realtime', 'dailyReactiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label">æ—¥æ— åŠŸç”µé‡</div>
                            <div class="metric-value">
                                <span id="meter-daily-reactive-energy">211.5</span>
                                <span class="metric-unit">kVarh</span>
                            </div>
                        </div>
                    `;
                }
                
                // ç´¯è®¡æœ‰åŠŸç”µé‡
                if (shouldShowField('meter', 'realtime', 'totalActiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label">ç´¯è®¡æœ‰åŠŸç”µé‡</div>
                            <div class="metric-value">
                                <span id="meter-total-active-energy">43</span>
                                <span class="metric-unit">MWh</span>
                            </div>
                        </div>
                    `;
                }
                
                // ç´¯è®¡æ— åŠŸç”µé‡ (å¦‚æœæœ‰é…ç½®çš„è¯)
                if (shouldShowField('meter', 'realtime', 'totalReactiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label">ç´¯è®¡æ— åŠŸç”µé‡</div>
                            <div class="metric-value">
                                <span id="meter-total-reactive-energy">7.7</span>
                                <span class="metric-unit">MVarh</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // ç”ŸæˆåŠ¨æ€HTMLçš„é€šç”¨å‡½æ•°
        function generateComponentHTML(componentName) {
            // PCSç»„ä»¶ç‰¹æ®Šå¤„ç†ï¼šä¸‰ç›¸æ•°æ®åˆå¹¶æ˜¾ç¤º
            if (componentName === 'pcs') {
                return generatePCSHTML();
            }
            
            // BMSç»„ä»¶ç‰¹æ®Šå¤„ç†
            if (componentName === 'bms') {
                return generateBMSHTML();
            }
            
            const categories = fieldConfigs[componentName]?.realtime;
            if (!categories) return '';
            
            let html = '';
            
            categories.forEach((category, categoryIndex) => {
                // æ£€æŸ¥è¯¥åˆ†ç±»æ˜¯å¦æœ‰ä»»ä½•å­—æ®µéœ€è¦æ˜¾ç¤º
                const visibleFields = category.fields.filter(field => shouldShowField(componentName, 'realtime', field.id));
                if (visibleFields.length === 0) return;
                
                // ä¸ºç³»ç»Ÿä¿¡æ¯åˆ†ç±»æ·»åŠ ç‰¹æ®Šç±»å
                const sectionClass = category.category === 'ç³»ç»Ÿä¿¡æ¯' ? 'metrics-section system-info' : 'metrics-section';
                
                html += `
                    <div class="${sectionClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">${category.category}</h3>
                            ${categoryIndex === 0 ? `
                                <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span>è®¾ç½®</span>
                                </button>
                            ` : ''}
                        </div>
                        <div class="metrics-grid">
                `;
                
                // ä¸ºæ¯ä¸ªå­—æ®µç”ŸæˆHTML
                visibleFields.forEach(field => {
                    html += getFieldHTML(componentName, field.id);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // æ ¹æ®ç»„ä»¶å’Œå­—æ®µIDè·å–å­—æ®µHTML
        function getFieldHTML(component, fieldId) {
            const fieldData = getFieldData(component, fieldId);
            if (!fieldData) return '';
            
            return `
                <div class="metric-card">
                    <div class="metric-label">${fieldData.label}</div>
                    <div class="metric-value">
                        ${fieldData.value}
                        ${fieldData.unit ? `<span class="metric-unit">${fieldData.unit}</span>` : ''}
                    </div>
                    ${fieldData.status ? `<div style="font-size: 12px; color: ${fieldData.statusColor || '#666'}; margin-top: 4px;">${fieldData.status}</div>` : ''}
                </div>
            `;
        }

        // ç”Ÿæˆç»„ä»¶å†å²æ•°æ®HTMLçš„é€šç”¨å‡½æ•°
        function generateHistoryHTML(componentName) {
            // EMSç»„ä»¶ç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºå¼€å‘ä¸­ä¿¡æ¯
            if (componentName === 'ems') {
                return `
                    <div style="display: flex; justify-content: center; align-items: center; height: 300px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-code" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <div style="font-size: 18px; margin-bottom: 8px;">æ›´å¤šæ•°æ®å¼€å‘ä¸­...</div>
                            <div style="font-size: 14px; opacity: 0.7;">EMSå†å²æ•°æ®åˆ†æåŠŸèƒ½æ­£åœ¨å®Œå–„</div>
                        </div>
                    </div>
                `;
            }
            
            // BMSç»„ä»¶ç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºä¸‰ä¸ªå›¾è¡¨
            if (componentName === 'bms') {
                return `
                    <!-- ç”µæ± SOCè¶‹åŠ¿ -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title">ç”µæ± SOCè¶‹åŠ¿</div>
                            <input type="date" 
                                   id="bms-soc-date" 
                                   value="2025-08-11" 
                                   onchange="changeBMSChartDate('bms-soc', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-soc-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- ç”µæ± ç”µå‹å†å² -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title">ç”µæ± ç”µå‹å†å²</div>
                            <input type="date" 
                                   id="bms-voltage-date" 
                                   value="2025-08-11" 
                                   onchange="changeBMSChartDate('bms-voltage', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-voltage-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- æ¸©åº¦åˆ†å¸ƒåˆ†æ -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title">æ¸©åº¦åˆ†å¸ƒåˆ†æ</div>
                            <input type="date" 
                                   id="bms-temp-date" 
                                   value="2025-08-11" 
                                   onchange="changeBMSChartDate('bms-temp', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-temp-chart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            const categories = fieldConfigs[componentName]?.history;
            if (!categories) return '';
            
            let html = `
                <!-- è®¾ç½®æŒ‰é’® -->
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                    <button class="settings-btn" onclick="openFieldSettings()" title="å­—æ®µè®¾ç½®" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                        <i class="fas fa-cog"></i>
                        <span>è®¾ç½®</span>
                    </button>
                </div>
            `;
            
            categories.forEach((category, categoryIndex) => {
                // æ£€æŸ¥è¯¥åˆ†ç±»æ˜¯å¦æœ‰ä»»ä½•å­—æ®µéœ€è¦æ˜¾ç¤º
                const visibleFields = category.fields.filter(field => shouldShowField(componentName, 'history', field.id));
                if (visibleFields.length === 0) return;
                
                // å›¾è¡¨åˆ†ç±»çš„å¤„ç†
                if (category.category === 'å›¾è¡¨') {
                    visibleFields.forEach(field => {
                        html += getHistoryFieldHTML(componentName, field.id);
                    });
                }
            });
            
            return html;
        }

        // æ ¹æ®ç»„ä»¶å’Œå­—æ®µIDè·å–å†å²æ•°æ®å­—æ®µHTML
        function getHistoryFieldHTML(component, fieldId) {
            const fieldData = getHistoryFieldData(component, fieldId);
            if (!fieldData) return '';
            
            return `
                <div class="chart-container">
                    <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="chart-title">${fieldData.title}</div>
                        ${fieldData.controls || ''}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="${fieldData.canvasId}"></canvas>
                    </div>
                </div>
            `;
        }

        // è·å–å†å²æ•°æ®å­—æ®µé…ç½®
        function getHistoryFieldData(component, fieldId) {
            const historyFieldDataMap = {
                'ems': {
                    'strategyHistory': { title: 'EMSç­–ç•¥æ‰§è¡Œå†å²', canvasId: 'emsStrategyChart' },
                    'responseTime': { title: 'è°ƒåº¦å“åº”æ—¶é—´åˆ†æ', canvasId: 'emsResponseChart' }
                },
                'pcs': {
                    'powerConversion': { 
                        title: 'PCSåŠŸç‡è½¬æ¢å†å²', 
                        canvasId: 'pcsPowerChart',
                        controls: `<input type="date" 
                                          id="pcs-power-date" 
                                          value="2025-08-11" 
                                          onchange="changePCSChartDate('pcs-power', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'voltageCurrent': { 
                        title: 'ç”µå‹ç”µæµè¶‹åŠ¿', 
                        canvasId: 'pcsVoltageChart',
                        controls: `<input type="date" 
                                          id="pcs-voltage-date" 
                                          value="2025-08-11" 
                                          onchange="changePCSChartDate('pcs-voltage', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'efficiency': { 
                        title: 'è½¬æ¢æ•ˆç‡åˆ†æ', 
                        canvasId: 'pcsEfficiencyChart',
                        controls: `<input type="date" 
                                          id="pcs-efficiency-date" 
                                          value="2025-08-11" 
                                          onchange="changePCSChartDate('pcs-efficiency', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'meter': {
                    'powerTrendAnalysis': { 
                        title: 'åŠŸç‡è¶‹åŠ¿åˆ†æ', 
                        canvasId: 'meter-power-trend-chart',
                        controls: `<input type="date" 
                                          id="meter-power-trend-date" 
                                          value="2025-08-11" 
                                          onchange="changeMeterChartDate('meter-power-trend', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'energyConsumptionStats': { 
                        title: 'ç”µé‡æ¶ˆè€—ç»Ÿè®¡', 
                        canvasId: 'meter-energy-stats-chart',
                        controls: `<input type="date" 
                                          id="meter-energy-stats-date" 
                                          value="2025-08-11" 
                                          onchange="changeMeterChartDate('meter-energy-stats', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'voltageQualityMonitoring': { 
                        title: 'ç”µå‹è´¨é‡ç›‘æµ‹', 
                        canvasId: 'meter-voltage-quality-chart',
                        controls: `<input type="date" 
                                          id="meter-voltage-quality-date" 
                                          value="2025-08-11" 
                                          onchange="changeMeterChartDate('meter-voltage-quality', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'harmonicAnalysis': { 
                        title: 'è°æ³¢åˆ†æ', 
                        canvasId: 'meter-harmonic-chart',
                        controls: `<input type="date" 
                                          id="meter-harmonic-date" 
                                          value="2025-08-11" 
                                          onchange="changeMeterChartDate('meter-harmonic', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'bms': {
                    'voltageHistory': { title: 'ç”µæ± ç”µå‹å†å²', canvasId: 'bmsVoltageChart' },
                    'socBalance': { title: 'SOCå‡è¡¡ç®¡ç†', canvasId: 'bmsBalanceChart' },
                    'tempDistribution': { title: 'æ¸©åº¦åˆ†å¸ƒåˆ†æ', canvasId: 'bmsTempChart' }
                },
                'thermal': {
                    'tempDistribution': { 
                        title: 'æ¸©åº¦åˆ†å¸ƒå†å²', 
                        canvasId: 'thermalTempChart',
                        controls: `<input type="date" 
                                          id="thermal-temp-date" 
                                          value="2025-08-11" 
                                          onchange="changeThermalChartDate('thermal-temp', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'coolingSystem': { 
                        title: 'å†·å´ç³»ç»Ÿè¿è¡Œ', 
                        canvasId: 'thermalCoolingChart',
                        controls: `<input type="date" 
                                          id="thermal-cooling-date" 
                                          value="2025-08-11" 
                                          onchange="changeThermalChartDate('thermal-cooling', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'heatMap': { 
                        title: 'ä¸»é£æœºè½¬é€Ÿä¸åˆ¶å†·åŠŸè€—', 
                        canvasId: 'thermalHeatMapChart',
                        controls: `<input type="date" 
                                          id="thermal-heatmap-date" 
                                          value="2025-08-11" 
                                          onchange="changeThermalChartDate('thermal-heatmap', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'fire': {
                    'systemStatus': { 
                        title: 'ç³»ç»ŸçŠ¶æ€å†å²', 
                        canvasId: 'fireSystemChart',
                        controls: `<input type="date" 
                                          id="fire-system-date" 
                                          value="2025-08-11" 
                                          onchange="changeFireChartDate('fire-system', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'gasConcentration': { 
                        title: 'æ°”ä½“æµ“åº¦ç›‘æµ‹', 
                        canvasId: 'fireGasChart',
                        controls: `<input type="date" 
                                          id="fire-gas-date" 
                                          value="2025-08-11" 
                                          onchange="changeFireChartDate('fire-gas', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'alarmHistory': { 
                        title: 'å‘Šè­¦è®°å½•åˆ†æ', 
                        canvasId: 'fireAlarmChart',
                        controls: `<input type="date" 
                                          id="fire-alarm-date" 
                                          value="2025-08-11" 
                                          onchange="changeFireChartDate('fire-alarm', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                }
            };
            
            return historyFieldDataMap[component]?.[fieldId];
        }

        // è·å–å­—æ®µæ•°æ®çš„å‡½æ•°
        function getFieldData(component, fieldId) {
            const fieldDataMap = {
                'overall': {
                    // ç­–ç•¥è°ƒåº¦å‚æ•°
                    'currentStrategy': { label: 'å½“å‰ç­–ç•¥', value: '<span style="font-size: 16px; color: #2563eb;">å³°è°·å¥—åˆ©</span>', status: 'è‡ªåŠ¨æ‰§è¡Œä¸­', statusColor: '#666' },
                    'dispatchCommand': { label: 'è°ƒåº¦æŒ‡ä»¤', value: '<span style="font-size: 16px; color: #10b981;">å……ç”µ</span>', status: 'ç›®æ ‡åŠŸç‡125kW', statusColor: '#10b981' },
                    'targetSOC': { label: 'ç›®æ ‡SOC', value: '<span id="overall-target-soc">91.0</span>', unit: '%', status: '', statusColor: '#666' },
                    'maxPower': { label: 'æœ€å¤§åŠŸç‡', value: '<span id="overall-max-power">284.0</span>', unit: 'kW', status: '', statusColor: '#666' },
                    
                    // æ ¸å¿ƒè¿è¡Œå‚æ•°
                    'soc': { label: 'SOC', value: '<span id="overall-soc">73.2</span>', unit: '%', status: '', statusColor: '#666' },
                    'soh': { label: 'SOH', value: '<span id="overall-soh">100.0</span>', unit: '%', status: 'SOHè‰¯å¥½', statusColor: '#10b981' },
                    'temperature': { label: 'æ¸©åº¦', value: '<span id="overall-temperature">24.1</span>', unit: 'Â°C', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'power': { label: 'å……æ”¾ç”µåŠŸç‡', value: '<span id="overall-power">-119.3</span>', unit: 'kW', status: 'å……ç”µä¸­', statusColor: '#10b981' },
                    'current': { label: 'ç”µæ± ç”µæµ', value: '<span id="overall-current">179.7</span>', unit: 'A', status: 'ç”µæµæ­£å¸¸', statusColor: '#10b981' },
                    'voltage': { label: 'ç”µæ± ç”µå‹', value: '<span id="overall-voltage">740.4</span>', unit: 'V', status: 'ç”µå‹ç¨³å®š', statusColor: '#10b981' },
                    
                    // è¿è¡Œç»Ÿè®¡
                    'todayCharge': { label: 'ä»Šæ—¥å……ç”µé‡', value: '<span id="overall-today-charge">720.9</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'todayDischarge': { label: 'ä»Šæ—¥æ”¾ç”µé‡', value: '<span id="overall-today-discharge">515.9</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'totalCharge': { label: 'ç´¯è®¡å……ç”µé‡', value: '<span id="overall-total-charge">1808</span>', unit: 'MWh', status: '', statusColor: '#666' },
                    'totalDischarge': { label: 'ç´¯è®¡æ”¾ç”µé‡', value: '<span id="overall-total-discharge">946</span>', unit: 'MWh', status: '', statusColor: '#666' },
                    
                    // å…¶ä»–å‚æ•°
                    'cycles': { label: 'å¾ªç¯æ¬¡æ•°', value: '<span id="overall-cycles">3769</span>', unit: 'æ¬¡', status: 'å¯¿å‘½æ­£å¸¸', statusColor: '#10b981' }
                },
                'ems': {
                    'cpuUsage': { label: 'CPUä½¿ç”¨ç‡', value: '<span id="cpu-usage">35.3</span>', unit: '%', status: 'CPUçŠ¶æ€' },
                    'cpuTemp': { label: 'CPUæ¸©åº¦', value: '<span id="cpu-temp">45.0</span>', unit: 'Â°C', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'memoryUsage': { label: 'å†…å­˜å ç”¨ç‡', value: '<span id="memory-usage">66.5</span>', unit: '%', status: '' },
                    'diskUsage': { label: 'ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡', value: '<span id="disk-usage">36.8</span>', unit: '%', status: '' },
                    'boardTemp': { label: 'å¼€å‘æ¿æ¸©åº¦', value: '<span id="board-temp">36.7</span>', unit: 'Â°C', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'signal4G': { label: '4Gä¿¡å·å¼ºåº¦', value: '<span id="signal-4g">-63</span>', unit: 'dBm', status: 'ä¿¡å·è‰¯å¥½', statusColor: '#10b981' },
                    'simStatus': { label: 'SIMå¡çŠ¶æ€', value: '<span style="color: #10b981;">å·²æ’å…¥</span>', status: '' },
                    'networkInterface': { label: 'ç½‘ç»œæ¥å£', value: '<span style="color: #10b981;">å¼€</span>', status: '' },
                    'wifiSignal': { label: 'WiFiä¿¡å·å¼ºåº¦', value: '<span id="wifi-signal">-78</span>', unit: 'dBm', status: 'ä¿¡å·è‰¯å¥½', statusColor: '#10b981' },
                    'wifiInterface': { label: 'WiFiç½‘ç»œæ¥å£', value: '<span style="color: #666;">å…³</span>', status: '' },
                    'uptime': { label: 'ç³»ç»Ÿè¿è¡Œæ—¶é•¿', value: '<span id="system-uptime">15å¤© 8å°æ—¶ 32åˆ†</span>', unit: '', status: '' },
                    'systemTime': { label: 'å½“å‰ç³»ç»Ÿæ—¶é—´', value: '<span id="system-time">2025-07-11 09:42</span>', unit: '', status: '' },
                    'hardwareTime': { label: 'å½“å‰ç¡¬ä»¶æ—¶é—´', value: '<span id="hardware-time">2025-07-11 09:42</span>', unit: '', status: '' }
                },
                'pcs': {
                    // PCSç”µç½‘ä¾§ç”µå‹
                    'gridVoltageA': { label: 'PCSç”µç½‘ä¾§ç”µå‹ Aç›¸', value: '<span id="pcs-grid-voltage-a">385.5</span>', unit: 'V', status: '' },
                    'gridVoltageB': { label: 'PCSç”µç½‘ä¾§ç”µå‹ Bç›¸', value: '<span id="pcs-grid-voltage-b">386.2</span>', unit: 'V', status: '' },
                    'gridVoltageC': { label: 'PCSç”µç½‘ä¾§ç”µå‹ Cç›¸', value: '<span id="pcs-grid-voltage-c">384.3</span>', unit: 'V', status: '' },
                    // PCSç”µç½‘ä¾§ç”µæµ
                    'gridCurrentA': { label: 'PCSç”µç½‘ä¾§ç”µæµ Aç›¸', value: '<span id="pcs-grid-current-a">96.5</span>', unit: 'A', status: '' },
                    'gridCurrentB': { label: 'PCSç”µç½‘ä¾§ç”µæµ Bç›¸', value: '<span id="pcs-grid-current-b">89.9</span>', unit: 'A', status: '' },
                    'gridCurrentC': { label: 'PCSç”µç½‘ä¾§ç”µæµ Cç›¸', value: '<span id="pcs-grid-current-c">85.2</span>', unit: 'A', status: '' },
                    // PCSç”µç½‘ä¾§åŠŸç‡
                    'gridPowerA': { label: 'PCSç”µç½‘ä¾§åŠŸç‡ Aç›¸', value: '<span id="pcs-grid-power-a">58.5</span>', unit: 'kW', status: '' },
                    'gridPowerB': { label: 'PCSç”µç½‘ä¾§åŠŸç‡ Bç›¸', value: '<span id="pcs-grid-power-b">55.7</span>', unit: 'kW', status: '' },
                    'gridPowerC': { label: 'PCSç”µç½‘ä¾§åŠŸç‡ Cç›¸', value: '<span id="pcs-grid-power-c">58.8</span>', unit: 'kW', status: '' },
                    // PCSæ¸©åº¦
                    'pcsTemp': { label: 'PCSæ¸©åº¦', value: '<span id="pcs-temp">57.3</span>', unit: 'Â°C', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' }
                },
                'bms': {
                    'totalVoltage': { label: 'æ€»ç”µå‹', value: `<span id="bms-total-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>`, unit: 'V', status: 'ç”µå‹æ­£å¸¸', statusColor: '#10b981' },
                    'totalCurrent': { label: 'æ€»ç”µæµ', value: `<span id="bms-total-current">${(Math.random() > 0.5 ? '+' : '-')}${(120 + Math.random() * 80).toFixed(1)}</span>`, unit: 'A', status: 'å……ç”µç”µæµ', statusColor: '#10b981' },
                    'remainingCapacity': { label: 'å‰©ä½™å®¹é‡', value: `<span id="bms-remaining-capacity">${(450 + Math.random() * 100).toFixed(1)}</span>`, unit: 'Ah', status: 'å¯ç”¨å®¹é‡' },
                    'cycles': { label: 'å……æ”¾ç”µå¾ªç¯', value: `<span id="bms-cycles">${Math.floor(2800 + Math.random() * 500)}</span>`, unit: 'æ¬¡', status: 'å¾ªç¯å¯¿å‘½è‰¯å¥½' },
                    'internalResistance': { label: 'å†…é˜»', value: `<span id="bms-internal-resistance">${(45 + Math.random() * 15).toFixed(1)}</span>`, unit: 'mÎ©', status: 'é˜»æŠ—æ­£å¸¸', statusColor: '#10b981' },
                    'insulation': { label: 'ç»ç¼˜é˜»æŠ—', value: `<span id="bms-insulation">${(850 + Math.random() * 300).toFixed(0)}</span>`, unit: 'kÎ©', status: 'ç»ç¼˜è‰¯å¥½', statusColor: '#10b981' },
                    'maxCellVoltage': { label: 'æœ€é«˜å•ä½“ç”µå‹', value: `<span id="bms-max-cell-voltage">${(3.35 + Math.random() * 0.02).toFixed(3)}</span>`, unit: 'V', status: `ç”µèŠ¯ç¼–å·: ${Math.floor(Math.random() * 280 + 1)}` },
                    'minCellVoltage': { label: 'æœ€ä½å•ä½“ç”µå‹', value: `<span id="bms-min-cell-voltage">${(3.32 + Math.random() * 0.02).toFixed(3)}</span>`, unit: 'V', status: `ç”µèŠ¯ç¼–å·: ${Math.floor(Math.random() * 280 + 1)}` },
                    'voltageDiff': { label: 'å•ä½“å‹å·®', value: `<span id="bms-voltage-diff">${(5 + Math.random() * 15).toFixed(1)}</span>`, unit: 'mV', status: 'å‹å·®è‰¯å¥½', statusColor: '#10b981' },
                    'consistency': { label: 'ç”µèŠ¯ä¸€è‡´æ€§', value: `<span id="bms-consistency">${(96.5 + Math.random() * 2.5).toFixed(1)}</span>`, unit: '%', status: 'ä¸€è‡´æ€§ä¼˜ç§€', statusColor: '#10b981' },
                    'abnormalCells': { label: 'å¼‚å¸¸ç”µèŠ¯æ•°', value: '<span id="bms-abnormal-cells">0</span>', unit: 'ä¸ª', status: 'å…¨éƒ¨æ­£å¸¸', statusColor: '#10b981' },
                    'balanceStatus': { label: 'å‡è¡¡çŠ¶æ€', value: `<span style="font-size: 16px; color: #10b981;">${Math.random() > 0.7 ? 'å‡è¡¡ä¸­' : 'æœªå‡è¡¡'}</span>`, status: 'ä¸»åŠ¨å‡è¡¡ç­–ç•¥' },
                    'totalCells': { label: 'ç”µèŠ¯æ€»æ•°', value: '<span>280</span>', unit: 'ä¸ª', status: '14ä¸²20å¹¶ç»„åˆ' },
                    'samplingAccuracy': { label: 'é‡‡æ ·ç²¾åº¦', value: `<span id="bms-sampling-accuracy">${(99.5 + Math.random() * 0.4).toFixed(2)}</span>`, unit: '%', status: 'é«˜ç²¾åº¦é‡‡æ ·', statusColor: '#10b981' },
                    'overvoltageProtection': { label: 'è¿‡å‹ä¿æŠ¤', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: 'é˜ˆå€¼: 3.65V' },
                    'undervoltageProtection': { label: 'æ¬ å‹ä¿æŠ¤', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: 'é˜ˆå€¼: 2.8V' },
                    'overcurrentProtection': { label: 'è¿‡æµä¿æŠ¤', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: 'é˜ˆå€¼: 300A' },
                    'overtemperatureProtection': { label: 'è¿‡æ¸©ä¿æŠ¤', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: 'é˜ˆå€¼: 60Â°C' },
                    'shortcircuitProtection': { label: 'çŸ­è·¯ä¿æŠ¤', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: 'æœªè§¦å‘', statusColor: '#10b981' },
                    'communicationStatus': { label: 'é€šä¿¡çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">åœ¨çº¿</span>', status: 'CANé€šä¿¡æ­£å¸¸', statusColor: '#10b981' },
                    'faultCode': { label: 'æ•…éšœä»£ç ', value: '<span id="bms-fault-code">0x0000</span>', unit: '', status: 'æ— æ•…éšœ', statusColor: '#10b981' },
                    'hardwareVersion': { label: 'ç¡¬ä»¶ç‰ˆæœ¬', value: '<span>V2.1.3</span>', unit: '', status: 'è½¯ä»¶ç‰ˆæœ¬V1.8.5' }
                },
                'thermal': {
                    // è¿è¡ŒçŠ¶æ€
                    'cabinetTemp': { label: 'å‚¨èƒ½æŸœæ¸©åº¦', value: '<span id="cabinetTemp">30.9</span>', unit: 'Â°C', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'runningMode': { label: 'è¿è¡Œæ¨¡å¼', value: '<span style="font-size: 16px; color: #2563eb;">åˆ¶å†·</span>', status: '', statusColor: '#2563eb' },
                    'humidity': { label: 'ç›¸å¯¹æ¹¿åº¦', value: '<span id="humidity">51.4</span>', unit: '%', status: 'æ¹¿åº¦æ­£å¸¸', statusColor: '#10b981' },
                    
                    // æ ¸å¿ƒç›‘æ§å‚æ•°  
                    'battMaxTemp': { label: 'ç”µæ± åŒ…æœ€é«˜æ¸©åº¦', value: '<span id="battMaxTemp">39.9</span>', unit: 'â„ƒ', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'battMinTemp': { label: 'ç”µæ± åŒ…æœ€ä½æ¸©åº¦', value: '<span id="battMinTemp">25.5</span>', unit: 'â„ƒ', status: 'æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'battAvgTemp': { label: 'ç”µæ± åŒ…å¹³å‡æ¸©åº¦', value: '<span id="battAvgTemp">32.8</span>', unit: 'â„ƒ', status: 'å¹³å‡æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'battTempDiff': { label: 'ç”µæ± åŒ…æ¸©å·®', value: '<span id="battTempDiff">6.0</span>', unit: 'â„ƒ', status: 'æ¸©å·®æ­£å¸¸', statusColor: '#10b981' },
                    'inletTemp': { label: 'è¿›é£æ¸©åº¦', value: '<span id="inletTemp">31.4</span>', unit: 'â„ƒ', status: 'è¿›é£æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'outletTemp': { label: 'å‡ºé£æ¸©åº¦', value: '<span id="outletTemp">26.2</span>', unit: 'â„ƒ', status: 'å‡ºé£æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    'coolantTemp': { label: 'å†·å´æ¶²æ¸©åº¦', value: '<span id="coolantTemp">24.2</span>', unit: 'â„ƒ', status: 'å†·å´æ¶²æ¸©åº¦æ­£å¸¸', statusColor: '#10b981' },
                    // ç³»ç»Ÿè¿è¡Œå‚æ•°
                    'mainFanSpeed': { label: 'ä¸»é£æœºè½¬é€Ÿ', value: '<span id="mainFanSpeed">1241</span>', unit: 'rpm', status: '', statusColor: '#10b981' },
                    'auxFanSpeed': { label: 'è¾…åŠ©é£æœºè½¬é€Ÿ', value: '<span id="auxFanSpeed">1115</span>', unit: 'rpm', status: '', statusColor: '#10b981' },
                    'coolantFlow': { label: 'å†·å´æ¶²æµé€Ÿ', value: '<span id="coolantFlow">12.7</span>', unit: 'L/min', status: '', statusColor: '#10b981' },
                    'compressorPower': { label: 'å‹ç¼©æœºåŠŸç‡', value: '<span id="compressorPower">3.5</span>', unit: 'kW', status: '', statusColor: '#10b981' },
                    'thermalPower': { label: 'çƒ­ç®¡ç†åŠŸè€—', value: '<span id="thermalPower">5.8</span>', unit: 'kW', status: '', statusColor: '#10b981' },
                    'tempRiseRate': { label: 'æ¸©å‡é€Ÿç‡', value: '<span id="tempRiseRate">0.78</span>', unit: 'Â°C/min', status: '', statusColor: '#10b981' },
                    'coolingEff': { label: 'åˆ¶å†·æ•ˆç‡', value: '<span id="coolingEff">85.9</span>', unit: '%', status: '', statusColor: '#10b981' },
                    'copValue': { label: 'COPç³»æ•°', value: '<span id="copValue">3.7</span>', unit: '', status: '', statusColor: '#10b981' },
                    'thermalManagementStatus': { label: 'çƒ­ç®¡ç†çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">åˆ¶å†·æ¨¡å¼</span>', status: '', statusColor: '#10b981' },
                    'coolingMode': { label: 'å†·å´æ¨¡å¼', value: '<span style="font-size: 16px; color: #2563eb;">å¼ºåˆ¶å†·å´</span>', status: '', statusColor: '#2563eb' },
                    'thermalRuntime': { label: 'ä»Šæ—¥è¿è¡Œæ—¶é—´', value: '<span id="thermalRuntime">7.2</span>', unit: 'å°æ—¶', status: '', statusColor: '#666' },
                    'maintenanceStatus': { label: 'ç»´æŠ¤çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">æ­£å¸¸</span>', status: '', statusColor: '#10b981' },
                    'thermalCycles': { label: 'å¯åœæ¬¡æ•°', value: '<span id="thermalCycles">15</span>', unit: 'æ¬¡', status: '', statusColor: '#666' },
                    'filterStatus': { label: 'è¿‡æ»¤å™¨çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">è‰¯å¥½</span>', status: '', statusColor: '#10b981' },
                    'alarmStatus': { label: 'æŠ¥è­¦çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">æ— æŠ¥è­¦</span>', status: '', statusColor: '#10b981' }
                },
                'fire': {
                    'smokeDetector': { label: 'çƒŸæ„Ÿæ¢æµ‹å™¨', value: '<span style="font-size: 16px; color: #10b981;">æ¢æµ‹å™¨æ­£å¸¸</span>', status: '', statusColor: '#10b981' },
                    'fireAlarmStatus': { label: 'ç«è­¦çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">ç«è­¦çŠ¶æ€æ­£å¸¸</span>', status: '', statusColor: '#10b981' },
                    'extinguisherStatus': { label: 'ç­ç«å™¨çŠ¶æ€', value: '<span style="font-size: 16px; color: #10b981;">ç­ç«å™¨å°±ç»ª</span>', status: '', statusColor: '#10b981' },
                    'emergencyShutdown': { label: 'ç´§æ€¥åœæœº', value: '<span style="font-size: 16px; color: #10b981;">æœªè§¦å‘</span>', status: '', statusColor: '#10b981' },
                    'alarmDevice': { label: 'å£°å…‰æŠ¥è­¦å™¨', value: '<span style="font-size: 16px; color: #10b981;">è­¦æŠ¥æ­£å¸¸</span>', status: '', statusColor: '#10b981' }
                },
                'meter': {
                    'totalActivePower': { label: 'æ€»æœ‰åŠŸåŠŸç‡', value: '<span id="meter-total-active-power">184.4</span>', unit: 'kW', status: 'æ­£å¸¸', statusColor: '#10b981' },
                    'totalReactivePower': { label: 'æ€»æ— åŠŸåŠŸç‡', value: '<span id="meter-total-reactive-power">31.9</span>', unit: 'kVar', status: 'æ­£å¸¸', statusColor: '#10b981' },
                    'totalApparentPower': { label: 'æ€»è§†åœ¨åŠŸç‡', value: '<span id="meter-total-apparent-power">255.4</span>', unit: 'kVA', status: 'æ­£å¸¸', statusColor: '#10b981' },
                    'frequency': { label: 'é¢‘ç‡', value: '<span id="meter-frequency">50.0</span>', unit: 'Hz', status: 'é¢‘ç‡ç¨³å®š', statusColor: '#10b981' },
                    'meterVoltage': { label: 'ç”µè¡¨ç”µå‹', value: 'Aç›¸:385.0V Bç›¸:388.7V Cç›¸:380.0V', unit: '', status: 'æ­£å¸¸', statusColor: '#10b981' },
                    'meterCurrent': { label: 'ç”µè¡¨ç”µæµ', value: 'Aç›¸:163.7A Bç›¸:174.2A Cç›¸:163.0A', unit: '', status: 'æ­£å¸¸', statusColor: '#10b981' },
                    'dailyActiveEnergy': { label: 'æ—¥æœ‰åŠŸç”µé‡', value: '<span id="meter-daily-active-energy">1529.2</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'dailyReactiveEnergy': { label: 'æ—¥æ— åŠŸç”µé‡', value: '<span id="meter-daily-reactive-energy">211.5</span>', unit: 'kVarh', status: '', statusColor: '#666' },
                    'totalActiveEnergy': { label: 'ç´¯è®¡æœ‰åŠŸç”µé‡', value: '<span id="meter-total-active-energy">43</span>', unit: 'MWh', status: '', statusColor: '#666' },
                    'totalReactiveEnergy': { label: 'ç´¯è®¡æ— åŠŸç”µé‡', value: '<span id="meter-total-reactive-energy">7.7</span>', unit: 'MVarh', status: '', statusColor: '#666' }
                }
            };
            
            return fieldDataMap[component]?.[fieldId];
        }
        
        // åˆ‡æ¢æ§åˆ¶æ¨¡å¼
        function changeMode(mode) {
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹
            if (!isControlEditMode) {
                // æ¢å¤åŸæ¥çš„é€‰ä¸­çŠ¶æ€
                const currentMode = document.getElementById('autoControl').style.display !== 'none' ? 'auto' : 'manual';
                const radios = document.querySelectorAll('input[name="mode"]');
                radios.forEach(radio => {
                    radio.checked = radio.value === currentMode;
                });
                return; // éç¼–è¾‘æ¨¡å¼ä¸‹ä¸å…è®¸æ“ä½œ
            }
            
            if (mode === 'manual') {
                document.getElementById('manualControl').style.display = 'block';
                document.getElementById('autoControl').style.display = 'none';
            } else {
                document.getElementById('manualControl').style.display = 'none';
                document.getElementById('autoControl').style.display = 'block';
            }
        }
        
        // åœæ­¢æ‰‹åŠ¨æ¨¡å¼
        function stopManualMode() {
            // æ˜¾ç¤ºæŒ‰é’®ï¼Œéšè—çŠ¶æ€
            const manualButtons = document.getElementById('manualButtons');
            const manualStatus = document.getElementById('manualStatus');
            
            manualButtons.style.display = 'block';
            manualStatus.style.display = 'none';
            
            // é‡ç½®æ‰‹åŠ¨æ¨¡å¼çŠ¶æ€
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
                btn.style.color = 'var(--text-primary)';
            });
            
            currentManualMode = null;
            
            // æ˜¾ç¤ºåœæ­¢æˆåŠŸæç¤º
            showToast('æ‰‹åŠ¨æ¨¡å¼å·²åœæ­¢', '#ef4444');
        }
        
        // é€‰æ‹©æ‰‹åŠ¨æ¨¡å¼æ“ä½œ
        let currentManualMode = null;
        function selectManualMode(mode) {
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹
            if (!isControlEditMode) {
                return; // éç¼–è¾‘æ¨¡å¼ä¸‹ä¸å…è®¸æ“ä½œ
            }
            
            currentManualMode = mode;
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
                btn.style.color = 'var(--text-primary)';
            });
            
            // è®¾ç½®é€‰ä¸­çš„æŒ‰é’®æ ·å¼
            const selectedBtn = document.querySelector(`[data-mode="${mode}"]`);
            if (selectedBtn) {
                // æ ¹æ®ä¸åŒæ¨¡å¼è®¾ç½®ä¸åŒçš„é¢œè‰²
                if (mode === 'charge') {
                    selectedBtn.style.background = '#dbeafe';
                    selectedBtn.style.borderColor = '#3b82f6';
                    selectedBtn.style.color = '#1e40af';
                } else if (mode === 'discharge') {
                    selectedBtn.style.background = '#fef3c7';
                    selectedBtn.style.borderColor = '#f59e0b';
                    selectedBtn.style.color = '#d97706';
                }
            }
        }
        
        
        // åˆå§‹åŒ–æ—¶é—´è½´
        function initTimeline() {
            const container = document.getElementById('timelineContainer');
            if (!container) return;
            
            // åˆå§‹åŒ–æ—¶é—´æ®µæ•°æ®: 0=å¹³ä»·, 1=å³°å€¼, 2=è°·å€¼
            const timeSlots = new Array(24).fill(0);
            // è®¾ç½®é»˜è®¤å³°å€¼æ—¶æ®µ 10-14ç‚¹
            for (let i = 10; i <= 14; i++) {
                timeSlots[i] = 1;
            }
            // è®¾ç½®é»˜è®¤è°·å€¼æ—¶æ®µ 23ç‚¹å’Œ0-6ç‚¹
            timeSlots[23] = 2;
            for (let i = 0; i <= 6; i++) {
                timeSlots[i] = 2;
            }
            
            // åˆ›å»ºæ—¶é—´å—
            container.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const block = document.createElement('div');
                block.style.cssText = `
                    flex: 1;
                    height: 100%;
                    border-right: 1px solid #e5e7eb;
                    cursor: pointer;
                    transition: background 0.2s;
                    position: relative;
                `;
                block.dataset.hour = i;
                updateTimeBlock(block, timeSlots[i]);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                block.addEventListener('click', function() {
                    // åªæœ‰åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ‰èƒ½ç‚¹å‡»
                    if (!isControlEditMode) return;
                    
                    // å¾ªç¯åˆ‡æ¢: å¹³ä»·->å³°å€¼->è°·å€¼->å¹³ä»·
                    const currentType = parseInt(this.dataset.type || 0);
                    const newType = (currentType + 1) % 3;
                    
                    // æ›´æ–°æ•°æ®
                    timeSlots[i] = newType;
                    updateTimeBlock(this, newType);
                });
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                block.addEventListener('mouseenter', function() {
                    this.style.opacity = '0.8';
                });
                block.addEventListener('mouseleave', function() {
                    this.style.opacity = '1';
                });
                
                container.appendChild(block);
            }
            
            // å­˜å‚¨æ—¶é—´è½´æ•°æ®
            window.timeSlots = timeSlots;
        }
        
        // æ›´æ–°æ—¶é—´å—æ˜¾ç¤º
        function updateTimeBlock(block, type) {
            const colors = ['#e5e7eb', '#ef4444', '#3b82f6']; // å¹³ä»·, å³°å€¼, è°·å€¼
            block.style.background = colors[type];
            block.dataset.type = type;
            
            // æ·»åŠ æç¤ºæ–‡å­—
            const tooltips = ['å¹³ä»·æ—¶æ®µ', 'å³°å€¼æ—¶æ®µ', 'è°·å€¼æ—¶æ®µ'];
            block.title = `${block.dataset.hour}:00-${parseInt(block.dataset.hour) + 1}:00 (${tooltips[type]})`;
        }
        
        // åˆ‡æ¢æ§åˆ¶é¢æ¿ç¼–è¾‘æ¨¡å¼
        let isControlEditMode = false;
        function toggleControlEdit() {
            isControlEditMode = !isControlEditMode;
            const editBtn = document.getElementById('editControlBtn');
            const controlPanel = document.getElementById('controlPanel');
            const controlButtons = document.getElementById('controlButtons');
            
            if (isControlEditMode) {
                // éšè—ç¼–è¾‘æŒ‰é’®
                editBtn.style.display = 'none';
                
                // æ˜¾ç¤ºåº•éƒ¨æŒ‰é’®
                controlButtons.style.display = 'block';
                
                // å¯ç”¨æ‰€æœ‰æ§ä»¶
                controlPanel.querySelectorAll('input, select, button').forEach(element => {
                    // æ’é™¤ç¼–è¾‘æŒ‰é’®æœ¬èº«ã€æ ‡ç­¾é¡µåˆ‡æ¢æŒ‰é’®å’Œåº•éƒ¨æŒ‰é’®
                    if (element.id !== 'editControlBtn' && 
                        !element.classList.contains('data-tab') && 
                        element.parentElement?.id !== 'controlButtons') {
                        element.disabled = false;
                        element.style.opacity = '1';
                        element.style.cursor = 'auto';
                    }
                });
                
                // å¯ç”¨æ—¶é—´è½´ç‚¹å‡»
                if (window.timelineContainer) {
                    window.timelineContainer.style.pointerEvents = 'auto';
                }
            } else {
                // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                editBtn.style.display = 'flex';
                editBtn.style.background = '#3562E3';
                editBtn.innerHTML = '<i class="fas fa-edit" style="font-size: 14px;"></i>ç¼–è¾‘';
                
                // éšè—åº•éƒ¨æŒ‰é’®
                controlButtons.style.display = 'none';
                
                // ç¦ç”¨æ‰€æœ‰æ§ä»¶
                controlPanel.querySelectorAll('input, select, button').forEach(element => {
                    // æ’é™¤ç¼–è¾‘æŒ‰é’®æœ¬èº«ã€æ ‡ç­¾é¡µåˆ‡æ¢æŒ‰é’®å’Œåº•éƒ¨æŒ‰é’®
                    if (element.id !== 'editControlBtn' && 
                        !element.classList.contains('data-tab') && 
                        element.parentElement?.id !== 'controlButtons') {
                        element.disabled = true;
                        element.style.opacity = '0.6';
                        element.style.cursor = 'not-allowed';
                    }
                });
                
                // ç¦ç”¨æ—¶é—´è½´ç‚¹å‡»
                if (window.timelineContainer) {
                    window.timelineContainer.style.pointerEvents = 'none';
                }
            }
        }
        
        // å–æ¶ˆæ§åˆ¶ç¼–è¾‘
        function cancelControlEdit() {
            if (isControlEditMode) {
                // é‡ç½®æ‰‹åŠ¨æ¨¡å¼é€‰æ‹©çŠ¶æ€
                currentManualMode = null;
                // é‡ç½®æ‰‹åŠ¨æ¨¡å¼æŒ‰é’®æ ·å¼
                document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                    btn.style.background = 'var(--bg-primary)';
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.color = 'var(--text-primary)';
                });
                
                toggleControlEdit(); // è¿™ä¼šè‡ªåŠ¨åˆ‡æ¢isControlEditModeçš„çŠ¶æ€
            }
        }
        
        // ä¿å­˜æ§åˆ¶è®¾ç½®
        function saveControlSettings() {
            if (isControlEditMode) {
                // æ”¶é›†æ‰€æœ‰è®¾ç½®æ•°æ®ï¼ˆè¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘ï¼‰
                const settings = {
                    mode: document.querySelector('input[name="mode"]:checked').value,
                    manualMode: currentManualMode,
                    // å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–è®¾ç½®é¡¹çš„æ”¶é›†
                };
                
                console.log('ä¿å­˜çš„è®¾ç½®:', settings);
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ä¸”æœ‰é€‰æ‹©ï¼Œåº”ç”¨æ‰‹åŠ¨æ¨¡å¼è¿è¡ŒçŠ¶æ€
                if (settings.mode === 'manual' && currentManualMode) {
                    applyManualModeSettings(currentManualMode);
                }
                
                toggleControlEdit(); // é€€å‡ºç¼–è¾‘æ¨¡å¼
                showToast('æ§åˆ¶è®¾ç½®å·²æˆåŠŸä¿å­˜ï¼');
            }
        }
        
        // åº”ç”¨æ‰‹åŠ¨æ¨¡å¼è®¾ç½®ï¼Œæ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
        function applyManualModeSettings(mode) {
            const manualStatus = document.getElementById('manualStatus');
            const statusContent = document.getElementById('statusContent');
            const manualButtons = document.getElementById('manualButtons');
            
            // éšè—æŒ‰é’®åŒºåŸŸï¼Œæ˜¾ç¤ºçŠ¶æ€
            manualButtons.style.display = 'none';
            manualStatus.style.display = 'block';
            
            if (mode === 'charge') {
                statusContent.innerHTML = `
                    <i class="fas fa-battery-three-quarters" style="color: #3b82f6; font-size: 20px;"></i>
                    <div style="text-align: left;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">å……ç”µä¸­</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">å……ç”µåŠŸç‡: 250kW</div>
                    </div>
                    <button onclick="stopManualMode()" style="padding: 8px 16px; background: #ef4444; color: white; 
                            border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; 
                            margin-left: auto;">
                        <i class="fas fa-stop" style="margin-right: 6px;"></i>åœæ­¢
                    </button>
                `;
            } else if (mode === 'discharge') {
                statusContent.innerHTML = `
                    <i class="fas fa-bolt" style="color: #f59e0b; font-size: 20px;"></i>
                    <div style="text-align: left;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">æ”¾ç”µä¸­</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">æ”¾ç”µåŠŸç‡: 250kW</div>
                    </div>
                    <button onclick="stopManualMode()" style="padding: 8px 16px; background: #ef4444; color: white; 
                            border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; 
                            margin-left: auto;">
                        <i class="fas fa-stop" style="margin-right: 6px;"></i>åœæ­¢
                    </button>
                `;
            }
        }
        
        // é‡ç½®æ§åˆ¶è®¾ç½®
        function resetControlSettings() {
            // é‡ç½®æ—¶é—´è½´ä¸ºé»˜è®¤å€¼
            if (window.timeSlots) {
                // é‡ç½®ä¸ºé»˜è®¤å€¼
                for (let i = 0; i < 24; i++) {
                    if ((i >= 10 && i <= 14)) {
                        window.timeSlots[i] = 1; // å³°å€¼
                    } else if (i === 23 || (i >= 0 && i <= 6)) {
                        window.timeSlots[i] = 2; // è°·å€¼
                    } else {
                        window.timeSlots[i] = 0; // å¹³ä»·
                    }
                }
                // é‡æ–°æ¸²æŸ“æ—¶é—´è½´
                initTimeline();
            }
            
            // é‡ç½®æ‰€æœ‰è¾“å…¥æ¡†ä¸ºé»˜è®¤å€¼
            document.getElementById('controlPanel').querySelectorAll('input[type="number"]').forEach(input => {
                // æ ¹æ®ä¸åŒè¾“å…¥æ¡†è®¾ç½®é»˜è®¤å€¼
                if (input.value) {
                    const currentValue = input.value;
                    input.value = input.defaultValue || currentValue;
                }
            });
            
            // é‡ç½®æ‰€æœ‰ä¸‹æ‹‰æ¡†ä¸ºç¬¬ä¸€ä¸ªé€‰é¡¹
            document.getElementById('controlPanel').querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            showToast('è®¾ç½®å·²é‡ç½®ï¼', '#ef4444');
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, color = '#10b981') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 2000;
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // init3DScene(); // 3Dæ¨¡å‹å·²åˆ é™¤
            startRealtimeUpdates();
            
            // åˆå§‹åŒ–æ˜¾ç¤ºæ•´æœºæ•°æ®
            updateComponentData('overall');
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopRealtimeUpdates();
        });
    </script>
</body>
</html>