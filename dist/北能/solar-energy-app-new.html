<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北能智能光伏管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1d1d1f;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }
        
        /* iPhone 13 手机外壳 */
        .phone-container {
            width: 390px;
            height: 844px;
            background: #ffffff;
            border-radius: 47px;
            position: relative;
            overflow: hidden;
            /* 手机外壳边框 */
            border: 4px solid #1d1d1f;
            /* 3D立体效果阴影 */
            box-shadow: 
                /* 主要阴影 */
                0 30px 80px rgba(0, 0, 0, 0.25),
                0 15px 40px rgba(0, 0, 0, 0.15),
                /* 边框内阴影 */
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1),
                /* 侧边高光 */
                -2px 0 0 rgba(255, 255, 255, 0.05),
                2px 0 0 rgba(0, 0, 0, 0.1);
            /* 3D变换 */
            transform: perspective(1000px) rotateX(-5deg) rotateY(2deg);
            transition: all 0.3s ease;
        }
        
        .phone-container:hover {
            transform: perspective(1000px) rotateX(-2deg) rotateY(1deg) scale(1.02);
            box-shadow: 
                0 40px 100px rgba(0, 0, 0, 0.3),
                0 20px 50px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(0, 0, 0, 0.15),
                -3px 0 0 rgba(255, 255, 255, 0.08),
                3px 0 0 rgba(0, 0, 0, 0.15);
        }
        
        /* 手机外壳材质纹理 */
        .phone-container::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(135deg, 
                #2c3e50 0%,
                #34495e 25%,
                #2c3e50 50%,
                #1a252f 75%,
                #0f1419 100%);
            border-radius: 51px;
            z-index: -1;
            /* 金属质感 */
            background-image: 
                linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%),
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.05) 0%, transparent 50%);
        }
        
        /* 侧边按钮 */
        .phone-container::after {
            content: '';
            position: absolute;
            left: -6px;
            top: 180px;
            width: 6px;
            height: 60px;
            background: linear-gradient(180deg, #34495e, #2c3e50, #1a252f);
            border-radius: 3px 0 0 3px;
            box-shadow: inset 1px 0 0 rgba(255,255,255,0.1);
        }
        
        /* 状态栏 */
        .status-bar {
            height: 47px;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
            background: transparent;
            padding-bottom: 6px;
            position: relative;
            z-index: 10;
        }
        
        /* 刘海设计 */
        .notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 210px;
            height: 30px;
            background: #000000;
            border-radius: 0 0 20px 20px;
            z-index: 100;
        }
        
        .status-icons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .battery {
            width: 24px;
            height: 12px;
            border: 1px solid #1f2937;
            border-radius: 2px;
            position: relative;
        }
        
        .battery::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 3px;
            width: 2px;
            height: 6px;
            background: #1f2937;
            border-radius: 0 1px 1px 0;
        }
        
        .battery-level {
            width: 70%;
            height: 8px;
            background: #1f2937;
            border-radius: 1px;
            margin: 1px;
        }
        
        /* 主内容区 */
        .main-content {
            height: calc(100% - 47px - 88px);
            padding: 0 24px 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 5;
        }
        
        /* 页面头部 - 苹果风格 */
        .page-header {
            margin-bottom: 24px;
            flex-shrink: 0;
        }
        
        .page-title {
            font-size: 40px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 4px;
            letter-spacing: -1px;
            line-height: 1.05;
        }
        
        .page-subtitle {
            font-size: 19px;
            color: #86868b;
            font-weight: 400;
            margin-bottom: 0;
        }
        
        /* 能源卡片 - 极简苹果风格 */
        .energy-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 24px;
            flex-shrink: 0;
        }
        
        .energy-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            padding: 20px 16px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .energy-card:active {
            transform: scale(0.97);
            background: rgba(255, 255, 255, 0.6);
        }
        
        .energy-value {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }
        
        .energy-unit {
            font-size: 14px;
            color: #86868b;
            font-weight: 500;
        }
        
        .energy-label {
            font-size: 13px;
            color: #86868b;
            margin-top: 8px;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        /* 状态卡片 - 极简苹果风格 */
        .status-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 24px;
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            padding: 28px 24px;
            margin-bottom: 24px;
            flex-shrink: 0;
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-title {
            font-size: 22px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.2px;
        }
        
        .status-mode {
            font-size: 15px;
            color: #30d158;
            font-weight: 600;
        }
        
        .current-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 16px 0;
        }
        
        .status-icon {
            font-size: 44px;
            margin-right: 16px;
            opacity: 0.9;
        }
        
        .status-info {
            flex: 1;
        }
        
        .power-reading {
            font-size: 36px;
            font-weight: 700;
            color: #1d1d1f;
            font-variant-numeric: tabular-nums;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        
        .power-label {
            font-size: 17px;
            color: #86868b;
            font-weight: 500;
        }
        
        /* 极简数据网格 */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            flex: 1;
        }
        
        .summary-item {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(0, 0, 0, 0.04);
            border-radius: 18px;
            padding: 20px 16px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .summary-item:active {
            transform: scale(0.97);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 6px;
            font-variant-numeric: tabular-nums;
        }
        
        .summary-label {
            font-size: 12px;
            color: #86868b;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        /* 底部导航栏 - 极简苹果风格 */
        .bottom-navigation {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 88px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 0.33px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            padding-bottom: 34px;
            z-index: 10;
        }
        
        /* Home Indicator - 精细设计 */
        .home-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: #1d1d1f;
            border-radius: 2.5px;
            opacity: 0.4;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            padding: 4px 8px;
            transition: opacity 0.2s ease;
            position: relative;
        }
        
        .nav-icon {
            width: 26px;
            height: 26px;
            margin-bottom: 3px;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            line-height: 1.1;
            letter-spacing: 0.1px;
        }
        
        .nav-item.active .nav-icon {
            color: #007aff;
            transform: translateY(-1px);
        }
        
        .nav-item.active .nav-label {
            color: #007aff;
        }
        
        .nav-item:not(.active) .nav-icon {
            color: #86868b;
        }
        
        .nav-item:not(.active) .nav-label {
            color: #86868b;
        }
        
        .nav-item:active {
            opacity: 0.6;
        }
        
        /* 页面切换 */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* 手机外壳的精细装饰 */
        .phone-container .screen-protector {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: transparent;
            border-radius: 45px;
            pointer-events: none;
            z-index: 1;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* 响应式 */
        @media (max-width: 400px) {
            body {
                padding: 20px 10px;
            }
            
            .phone-container {
                width: 100%;
                max-width: 390px;
                height: auto;
                aspect-ratio: 390 / 844;
                transform: none;
                border-width: 2px;
            }
            
            .phone-container:hover {
                transform: none;
            }
        }
        
        @media (min-width: 401px) {
            .phone-container {
                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
        }
        
    </style>
</head>
<body>
    <div class="phone-container">
        <!-- 屏幕保护装饰 -->
        <div class="screen-protector"></div>
        
        <!-- iPhone 13 刘海 -->
        <div class="notch"></div>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-time">13:34</div>
            <div class="status-icons">
                <svg width="18" height="18" fill="#1f2937" viewBox="0 0 20 20">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                </svg>
                <svg width="18" height="18" fill="#1f2937" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1v0a1 1 0 110 2v0a1 1 0 01-1-1z"></path>
                </svg>
                <div class="battery">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 首页内容 -->
            <div id="home" class="page-content active">
                <div class="page-header">
                    <h1 class="page-title">光伏</h1>
                    <p class="page-subtitle">今天 8月 20日</p>
                </div>
                
                <div class="status-card">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div class="power-reading">7.2<span style="font-size:28px;color:#86868b;font-weight:500;margin-left:6px;">kW</span></div>
                        <div class="power-label">当前发电功率</div>
                    </div>
                    <div style="display:flex;justify-content:center;align-items:center;">
                        <div style="width:8px;height:8px;background:#30d158;border-radius:50%;margin-right:8px;"></div>
                        <div style="font-size:17px;color:#1d1d1f;font-weight:500;">系统正常运行</div>
                    </div>
                </div>
                
                <div class="energy-cards">
                    <div class="energy-card">
                        <div class="energy-value">2.4<span class="energy-unit">kW</span></div>
                        <div class="energy-label">家庭用电</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-value">85<span class="energy-unit">%</span></div>
                        <div class="energy-label">电池电量</div>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">36.4 kWh</div>
                        <div class="summary-label">今日发电</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">¥18.2</div>
                        <div class="summary-label">今日收益</div>
                    </div>
                </div>
            </div>
            
            <!-- 历史页面 -->
            <div id="history" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">历史</h1>
                    <p class="page-subtitle">发电记录</p>
                </div>
                
                <div class="summary-grid" style="margin-bottom: 16px;">
                    <div class="summary-item">
                        <div class="summary-value">203 kWh</div>
                        <div class="summary-label">本周发电</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">¥101</div>
                        <div class="summary-label">本周收益</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">1.2 MWh</div>
                        <div class="summary-label">本月发电</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">95%</div>
                        <div class="summary-label">达成率</div>
                    </div>
                </div>
                
                <div style="text-align: center; color: #8e8e93; font-size: 17px; margin-top: 60px;">
                    📊<br><br>详细图表功能<br>即将上线
                </div>
            </div>
            
            <!-- 设备页面 -->
            <div id="device" class="page-content">
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <h1 class="page-title">设备</h1>
                        </div>
                        <div style="background: #007aff; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);" onclick="openAddDevice()" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                            <svg width="18" height="18" fill="white" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 无设备时的缺省页面 -->
                <div id="emptyDeviceState" style="display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; text-align: center; padding: 40px 20px;">
                    <!-- 设备图标 -->
                    <div style="width: 120px; height: 120px; background: rgba(0, 122, 255, 0.08); border-radius: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 32px;">
                        <svg width="60" height="60" fill="none" viewBox="0 0 24 24">
                            <path stroke="#007aff" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/>
                        </svg>
                    </div>
                    
                    <!-- 标题和描述 -->
                    <h2 style="font-size: 22px; font-weight: 600; color: #1d1d1f; margin: 0 0 40px 0; letter-spacing: -0.2px;">还没有设备</h2>
                    
                    <!-- 添加设备按钮 -->
                    <div style="background: #007aff; border-radius: 14px; padding: 16px 32px; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);" onclick="openAddDevice()" onmousedown="this.style.transform='scale(0.96)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                        <div style="color: white; font-size: 17px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                            </svg>
                            添加设备
                        </div>
                    </div>
                    
                </div>
                
                <!-- 有设备时的列表（隐藏） -->
                <div id="deviceListState" style="display: none;">
                    <div style="display: grid; gap: 12px;">
                        <!-- 设备卡片将通过JavaScript动态添加 -->
                    </div>
                    
                    <!-- 底部添加按钮 -->
                    <div style="margin-top: 24px; text-align: center;">
                        <div style="display: inline-block; background: rgba(0, 122, 255, 0.1); border: 1px solid #007aff; border-radius: 16px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease;" onclick="openAddDevice()">
                            <div style="color: #007aff; font-size: 15px; font-weight: 500;">+ 添加更多设备</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 设置页面 -->
            <div id="settings" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">系统设置</h1>
                    <p class="page-subtitle">管理系统配置和偏好</p>
                </div>
                
                <div style="display: grid; gap: 12px;">
                    <div id="networkConfigItem" onclick="openNetworkSettingsPanel()" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#ffffff'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10B981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <svg width="18" height="18" fill="white" viewBox="0 0 24 24">
                                        <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                                    </svg>
                                </div>
                                <span style="font-size: 16px; font-weight: 500;">网络配置</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #10B981; font-size: 14px;">已连接</span>
                                <svg width="20" height="20" fill="#9ca3af" viewBox="0 0 24 24">
                                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>通知设置</span>
                            <span style="color: #9333EA; font-size: 14px;">开启</span>
                        </div>
                    </div>
                    
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>夜间模式</span>
                            <span style="color: #6b7280; font-size: 14px;">关闭</span>
                        </div>
                    </div>
                    
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>语言设置</span>
                            <span style="color: #6b7280; font-size: 14px;">中文</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 我的页面 -->
            <div id="mine" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">我的账户</h1>
                    <p class="page-subtitle">个人信息与统计</p>
                </div>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #9333EA, #06B6D4); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">👤</div>
                    <div style="font-weight: 600; margin-bottom: 4px;">光伏用户</div>
                    <div style="font-size: 14px; color: #71717A;">ID: 20240120001</div>
                    <div style="background: linear-gradient(135deg, #ffd700, #ffb300); color: white; padding: 4px 16px; border-radius: 12px; font-size: 12px; margin-top: 8px; display: inline-block;">VIP会员</div>
                </div>
                
                <div class="energy-cards">
                    <div class="energy-card">
                        <div class="energy-value">12,458<span class="energy-unit">kWh</span></div>
                        <div class="energy-label">累计发电量</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-value">¥8,920</div>
                        <div class="energy-label">累计节省</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-value">6,229<span class="energy-unit">kg</span></div>
                        <div class="energy-label">减少CO₂</div>
                    </div>
                    <div class="energy-card">
                        <div class="energy-value">311</div>
                        <div class="energy-label">相当于植树</div>
                    </div>
                </div>
                
                <!-- 蓝牙连接按钮 -->
                <div style="margin-top: 24px;">
                    <button onclick="openBluetoothModal()" style="
                        width: 100%; 
                        background: linear-gradient(135deg, #007AFF, #5856D6); 
                        border: none; 
                        color: white; 
                        font-size: 17px; 
                        font-weight: 600; 
                        padding: 16px 24px; 
                        border-radius: 16px; 
                        cursor: pointer; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        gap: 8px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.transform='scale(0.98)'" onmouseout="this.style.transform='scale(1)'">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M12 2L17 7L13 11L17 15L12 20V12L8 16L6 14L10 10L6 6L8 4L12 8V2Z"/>
                        </svg>
                        蓝牙连接
                    </button>
                </div>
            </div>
        </div>
        
        
        <!-- 添加设备页面 -->
        <div id="addDevicePage" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #ffffff; z-index: 1500; display: none; transform: translateX(100%);">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="status-time">13:34</div>
                <div class="status-icons">
                    <svg width="18" height="18" fill="#1d1d1f" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <svg width="18" height="18" fill="#1d1d1f" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1v0a1 1 0 110 2v0a1 1 0 01-1-1z"></path>
                    </svg>
                    <div class="battery">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- 导航栏 -->
            <div style="height: 44px; display: flex; align-items: center; padding: 0 20px; border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);">
                <button onclick="closeAddDevicePage()" style="background: none; border: none; padding: 8px; margin-left: -8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" fill="#007aff" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <div style="flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: #1d1d1f;">添加设备</div>
                <button onclick="openQRScanner()" style="background: none; border: none; padding: 8px; margin-right: -8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" fill="#007aff" viewBox="0 0 24 24">
                        <path d="M3 3h4v2H5v2H3V3zm14 0h4v4h-2V5h-2V3zM3 17v4h4v-2H5v-2H3zm16 0v2h-2v2h4v-4h-2z"/>
                        <path d="M9 9h2v2H9V9zm4 0h2v2h-2V9zm0 4h2v2h-2v-2zm-4 0h2v2H9v-2z"/>
                        <rect x="6" y="12" width="1" height="6"/>
                        <rect x="12" y="6" width="6" height="1"/>
                    </svg>
                </button>
            </div>
            
            <!-- 扫描区域 -->
            <div style="padding: 24px; text-align: center;">
                <div style="color: #1d1d1f; font-size: 20px; font-weight: 600; margin-bottom: 4px;">扫描附近设备</div>
                <div style="color: #86868b; font-size: 14px; margin-bottom: 32px;">持续自动搜索中...</div>
                
                <!-- 扫描动画 -->
                <div id="scanningAnimation" style="width: 200px; height: 200px; margin: 20px auto; border: 3px solid rgba(0, 0, 0, 0.1); border-radius: 20px; position: relative; overflow: hidden; background: rgba(0, 122, 255, 0.02);">
                    <!-- 扫描线 -->
                    <div style="position: absolute; width: 100%; height: 3px; background: linear-gradient(90deg, transparent, #007aff, transparent); animation: scanLine 2s linear infinite;"></div>
                    
                    <!-- 手机图标 -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 90px; border: 2px solid #86868b; border-radius: 12px; background: #f8f8f8;">
                        <!-- 刘海 -->
                        <div style="position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: #86868b; border-radius: 2px;"></div>
                        <!-- Home指示器 -->
                        <div style="position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); width: 20px; height: 2px; background: #86868b; border-radius: 1px;"></div>
                    </div>
                </div>
                
                <!-- 发现的设备列表 -->
                <div id="foundDevicesSection" style="display: none;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div style="color: #1d1d1f; font-size: 18px; font-weight: 600;">发现 <span id="deviceCount">0</span> 个设备</div>
                        <button onclick="refreshDeviceScan()" style="background: none; border: none; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <svg width="20" height="20" fill="#007aff" viewBox="0 0 24 24">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="foundDevicesList" style="display: grid; gap: 12px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 二维码扫描页面 -->
        <div id="qrScanPage" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000000; z-index: 1600; display: none; transform: translateX(100%);">
            <!-- 状态栏 -->
            <div class="status-bar" style="background: transparent;">
                <div class="status-time" style="color: white;">13:34</div>
                <div class="status-icons">
                    <svg width="18" height="18" fill="white" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <div class="battery" style="border-color: white;">
                        <div class="battery-level" style="background: white;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 导航栏 -->
            <div style="height: 44px; display: flex; align-items: center; padding: 0 20px; background: transparent;">
                <button onclick="closeQRScanner()" style="background: none; border: none; padding: 8px; margin-left: -8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </button>
                <div style="flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: white;">扫码添加设备</div>
                <div style="width: 40px;"></div>
            </div>
            
            <!-- 扫描区域 -->
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px;">
                <!-- 手机图标 -->
                <div style="font-size: 80px; margin-bottom: 32px;">📱</div>
                
                <!-- 扫描框 -->
                <div class="qr-scan-frame" style="position: relative; width: 280px; height: 280px; margin-bottom: 40px;">
                    <!-- 扫描框边角 -->
                    <div style="position: absolute; top: 0; left: 0; width: 40px; height: 40px; border-top: 4px solid #007aff; border-left: 4px solid #007aff; border-radius: 8px 0 0 0;"></div>
                    <div style="position: absolute; top: 0; right: 0; width: 40px; height: 40px; border-top: 4px solid #007aff; border-right: 4px solid #007aff; border-radius: 0 8px 0 0;"></div>
                    <div style="position: absolute; bottom: 0; left: 0; width: 40px; height: 40px; border-bottom: 4px solid #007aff; border-left: 4px solid #007aff; border-radius: 0 0 0 8px;"></div>
                    <div style="position: absolute; bottom: 0; right: 0; width: 40px; height: 40px; border-bottom: 4px solid #007aff; border-right: 4px solid #007aff; border-radius: 0 0 8px 0;"></div>
                    
                    <!-- 扫描线动画 -->
                    <div class="qr-scan-line" style="position: absolute; top: 50px; left: 20px; right: 20px; height: 2px; background: #007aff; box-shadow: 0 0 10px #007aff; animation: qrScan 2s ease-in-out infinite;"></div>
                    
                    <!-- 模拟摄像头预览 -->
                    <div style="position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;"></div>
                </div>
                
                <div style="color: white; font-size: 18px; font-weight: 600; margin-bottom: 8px; text-align: center;">对准设备上的二维码</div>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; text-align: center; line-height: 1.5; max-width: 280px;">请将摄像头对准设备标签上的二维码<br>保持适当距离以获得最佳识别效果</div>
                
                <!-- 扫描成功区域 -->
                <div id="qrSuccessArea"></div>
            </div>
        </div>
        
        <style>
        @keyframes scanLine {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        @keyframes qrScan {
            0%, 50% { top: 50px; opacity: 1; }
            100% { top: 200px; opacity: 0.3; }
        }
        </style>
        
        <!-- 底部导航栏 -->
        <div class="bottom-navigation">
            <div class="nav-item active" onclick="switchPage('home', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="nav-label">首页</span>
            </div>
            
            <div class="nav-item" onclick="switchPage('history', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
                <span class="nav-label">历史</span>
            </div>
            
            <div class="nav-item" onclick="switchPage('device', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/>
                </svg>
                <span class="nav-label">设备</span>
            </div>
            
            <div class="nav-item" onclick="switchPage('settings', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                <span class="nav-label">设置</span>
            </div>
            
            <div class="nav-item" onclick="switchPage('mine', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <span class="nav-label">我的</span>
            </div>
            
            <!-- Home Indicator -->
            <div class="home-indicator"></div>
        </div>
    </div>

    <script>
        // 检查登录状态
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn || isLoggedIn !== 'true') {
                // 未登录，跳转到登录页面
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        
        // 页面加载时检查登录状态
        window.addEventListener('load', function() {
            checkLoginStatus();
        });
        
        // 页面切换功能
        function switchPage(pageId, navElement) {
            // 隐藏所有页面
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            
            // 显示选中页面
            document.getElementById(pageId).classList.add('active');
            
            // 更新导航状态
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            navElement.classList.add('active');
        }
        
        
        // 设备详情相关函数
        function openDeviceDetail(deviceName, deviceSN, isOnline) {
            // 跳转到设备详情页面
            window.location.href = 'home.html';
        }
        
        
        
        // 设备数据存储
        let devices = [];
        let lastAddedDevice = null; // 记录最后添加的设备
        
        function openAddDevice() {
            // 临时清理权限用于测试 - 可以删除这两行
            localStorage.removeItem('locationPermission');
            localStorage.removeItem('bluetoothPermission');
            
            // 直接进入添加设备页面
            showAddDevicePage();
        }
        
        function showAddDevicePage() {
            // 检查权限状态
            const locationPermission = localStorage.getItem('locationPermission');
            const bluetoothPermission = localStorage.getItem('bluetoothPermission');
            
            console.log('Checking permissions:', { locationPermission, bluetoothPermission });
            
            // 如果已有权限，直接显示添加设备页面
            if (locationPermission && bluetoothPermission === 'allowed') {
                console.log('Permissions already granted, showing device page directly');
                showAddDevicePageDirectly();
                return;
            }
            
            // 否则先显示权限请求弹窗
            console.log('Showing location permission dialog');
            showLocationPermissionDialog();
        }
        
        function showAddDevicePageDirectly() {
            const addPage = document.getElementById('addDevicePage');
            const phoneContainer = document.querySelector('.phone-container');
            
            // 隐藏手机外壳的3D效果
            phoneContainer.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
            
            // 显示添加设备页面
            addPage.style.display = 'block';
            
            // 添加页面切换动画
            setTimeout(() => {
                addPage.style.transform = 'translateX(0)';
                addPage.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            }, 10);
            
            // 开始扫描设备
            setTimeout(() => {
                showFoundDevices();
            }, 3000);
        }
        
        function closeAddDevicePage() {
            const addPage = document.getElementById('addDevicePage');
            const phoneContainer = document.querySelector('.phone-container');
            
            // 恢复手机外壳的3D效果
            phoneContainer.style.transform = 'perspective(1000px) rotateX(-5deg) rotateY(2deg)';
            
            // 隐藏添加设备页面
            addPage.style.transform = 'translateX(100%)';
            setTimeout(() => {
                addPage.style.display = 'none';
            }, 300);
        }
        
        function refreshDeviceScan() {
            // 隐藏发现设备列表
            const foundDevicesSection = document.getElementById('foundDevicesSection');
            if (foundDevicesSection) {
                foundDevicesSection.style.display = 'none';
            }
            
            // 显示扫描动画
            const scanningAnimation = document.getElementById('scanningAnimation');
            if (scanningAnimation) {
                scanningAnimation.style.display = 'block';
            }
            
            // 重新开始扫描
            setTimeout(() => {
                showFoundDevices();
            }, 3000);
            
            // 显示刷新成功提示
            showSuccessMessage('正在刷新扫描...');
        }
        
        function startBluetoothScanPage() {
            closeAddDevicePage();
            setTimeout(() => {
                showBluetoothScanModal();
            }, 300);
        }
        
        function showManualAddPage() {
            closeAddDevicePage();
            setTimeout(() => {
                showManualAddOptions();
            }, 300);
        }
        
        function showFoundDevices() {
            const foundDevicesSection = document.getElementById('foundDevicesSection');
            const foundDevicesList = document.getElementById('foundDevicesList');
            const deviceCount = document.getElementById('deviceCount');
            
            // 模拟发现的设备
            const discoveredDevices = [
                { name: 'BEI-001', id: 'SN2024012345', type: '储能系统', icon: '🔋' },
                { name: 'PV-102', id: 'SN2024012346', type: '光伏逆变器', icon: '☀️' },
                { name: 'EV-203', id: 'SN2024012347', type: '充电桩', icon: '⚡' }
            ];
            
            deviceCount.textContent = discoveredDevices.length;
            foundDevicesList.innerHTML = '';
            
            discoveredDevices.forEach((device, index) => {
                const deviceItem = document.createElement('div');
                deviceItem.style.cssText = `
                    background: rgba(255, 255, 255, 0.9);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    border-radius: 16px;
                    border: 0.5px solid rgba(0, 0, 0, 0.04);
                    padding: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                deviceItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="color: #1d1d1f; font-size: 16px; font-weight: 600;">${device.name}</div>
                        </div>
                        <div id="add-status-${index}">
                            <button onclick="confirmAddDevice('${device.name}', '${device.type}', '${device.id}', ${index})" style="background: #007aff; color: white; border: none; border-radius: 8px; padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">添加</button>
                        </div>
                    </div>
                `;
                
                foundDevicesList.appendChild(deviceItem);
            });
            
            foundDevicesSection.style.display = 'block';
        }
        
        function confirmAddDevice(deviceName, deviceType, deviceId, index) {
            // 更新按钮状态
            const statusDiv = document.getElementById(`add-status-${index}`);
            statusDiv.innerHTML = '<div style="color: #30d158; font-size: 14px; font-weight: 600;">✓ 已添加</div>';
            
            // 添加到设备列表
            const deviceIcons = {
                '储能系统': '🔋',
                '光伏逆变器': '☀️',
                '充电桩': '⚡'
            };
            
            const newDevice = {
                id: `device_${Date.now()}`,
                name: deviceName,
                type: deviceType,
                sn: deviceId,
                online: true,
                icon: deviceIcons[deviceType] || '🔧',
                soc: Math.floor(Math.random() * 40) + 60,
                soh: Math.floor(Math.random() * 10) + 90,
                status: Math.random() > 0.5 ? '充电' : '放电'
            };
            
            devices.push(newDevice);
            lastAddedDevice = newDevice; // 记录最后添加的设备
            
            // 显示成功提示
            showSuccessMessage('添加成功');
            
            // 2秒后关闭页面并更新设备列表
            setTimeout(() => {
                closeAddDevicePage();
                updateDeviceDisplay();
                // 显示网络配置弹窗
                setTimeout(() => {
                    showNetworkConfigModal();
                }, 500);
            }, 2000);
        }
        
        function startBluetoothScan() {
            closeAddDevice();
            showBluetoothScanModal();
        }
        
        function showBluetoothScanModal() {
            const scanHTML = `
                <div id="bluetoothScanModal" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #1a1a1a; border-radius: 24px; width: 90%; max-width: 350px; padding: 0; overflow: hidden; position: relative;">
                        <!-- 头部 -->
                        <div style="background: linear-gradient(135deg, #007aff, #0056b3); padding: 20px; text-align: center; position: relative;">
                            <button onclick="closeBluetooth()" style="position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; width: 32px; height: 32px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">×</button>
                            <h2 style="color: white; margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">蓝牙扫描</h2>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">搜索附近的设备</div>
                        </div>
                        
                        <!-- 扫描内容 -->
                        <div style="padding: 24px;">
                            <!-- 扫描动画 -->
                            <div id="scanningAnimation" style="text-align: center; margin-bottom: 24px;">
                                <div style="width: 80px; height: 80px; margin: 0 auto 16px; border: 3px solid #007aff; border-radius: 50%; border-top: 3px solid transparent; animation: spin 1s linear infinite;"></div>
                                <div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px;">正在扫描...</div>
                                <div style="color: #86868b; font-size: 14px;">请将手机靠近要添加的设备</div>
                            </div>
                            
                            <!-- 发现的设备列表 -->
                            <div id="discoveredDevices" style="display: none;">
                                <div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 16px;">发现 <span id="deviceCount">0</span> 台设备</div>
                                <div id="deviceList" style="display: grid; gap: 12px;">
                                    <!-- 设备将通过JS动态添加 -->
                                </div>
                            </div>
                            
                            <!-- 底部按钮 -->
                            <div style="margin-top: 24px; text-align: center;">
                                <div onclick="showManualAddOptions()" style="background: transparent; border: 1px solid #3a3a3a; border-radius: 12px; padding: 12px 20px; cursor: pointer; transition: all 0.3s ease; display: inline-block;" onmouseover="this.style.borderColor='#007aff'" onmouseout="this.style.borderColor='#3a3a3a'">
                                    <div style="color: #86868b; font-size: 14px;">扫描不到？手动添加</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                </style>
            `;
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', scanHTML);
            
            // 模拟蓝牙扫描过程
            setTimeout(() => {
                simulateDeviceDiscovery();
            }, 3000);
        }
        
        function simulateDeviceDiscovery() {
            // 模拟发现的设备
            const discoveredDevicesList = [
                { name: '储能系统 BEI-001', type: '储能系统', signal: 85, mac: 'AA:BB:CC:DD:EE:01' },
                { name: '光伏逆变器 PV-102', type: '光伏逆变器', signal: 72, mac: 'AA:BB:CC:DD:EE:02' },
                { name: '充电桩 EV-203', type: '充电桩', signal: 68, mac: 'AA:BB:CC:DD:EE:03' }
            ];
            
            const scanAnimation = document.getElementById('scanningAnimation');
            const discoveredDevices = document.getElementById('discoveredDevices');
            const deviceList = document.getElementById('deviceList');
            const deviceCount = document.getElementById('deviceCount');
            
            if (scanAnimation) scanAnimation.style.display = 'none';
            if (discoveredDevices) discoveredDevices.style.display = 'block';
            if (deviceCount) deviceCount.textContent = discoveredDevicesList.length;
            
            const deviceIcons = {
                '储能系统': '🔋',
                '光伏逆变器': '☀️',
                '充电桩': '⚡'
            };
            
            if (deviceList) {
                deviceList.innerHTML = discoveredDevicesList.map(device => `
                    <div onclick="addDiscoveredDevice('${device.name}', '${device.type}', '${device.mac}')" style="background: #2a2a2a; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent;" onmouseover="this.style.borderColor='#007aff'" onmouseout="this.style.borderColor='transparent'">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px;">${deviceIcons[device.type]}</div>
                                <div>
                                    <div style="color: white; font-size: 15px; font-weight: 600; margin-bottom: 2px;">${device.name}</div>
                                    <div style="color: #86868b; font-size: 12px;">${device.type} • ${device.mac}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 8px; background: #30d158; border-radius: 1px;"></div>
                                <div style="width: 12px; height: 8px; background: ${device.signal > 70 ? '#30d158' : '#86868b'}; border-radius: 1px;"></div>
                                <div style="width: 12px; height: 8px; background: ${device.signal > 80 ? '#30d158' : '#86868b'}; border-radius: 1px;"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function addDiscoveredDevice(deviceName, deviceType, deviceMac) {
            const newDevice = {
                id: `device_${Date.now()}`,
                name: deviceName,
                type: deviceType,
                sn: deviceMac.replace(/:/g, ''),
                online: true,
                icon: deviceType === '储能系统' ? '🔋' : deviceType === '光伏逆变器' ? '☀️' : '⚡',
                soc: Math.floor(Math.random() * 40) + 60,
                soh: Math.floor(Math.random() * 10) + 90,
                status: Math.random() > 0.5 ? '充电' : '放电',
                networkConfigured: false // 新添加的设备默认未配网
            };
            
            devices.push(newDevice);
            lastAddedDevice = newDevice; // 记录最后添加的设备
            closeBluetooth();
            updateDeviceDisplay();
            showSuccessMessage('添加成功');
            
            // 显示网络配置弹窗
            setTimeout(() => {
                showNetworkConfigModal();
            }, 500);
        }
        
        function closeBluetooth() {
            const modal = document.getElementById('bluetoothScanModal');
            if (modal) modal.remove();
        }
        
        function showManualAddOptions() {
            closeBluetooth();
            closeAddDevice();
            
            // 显示手动添加设备类型选择
            const manualAddHTML = `
                <div id="manualAddModal" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #1a1a1a; border-radius: 24px; width: 90%; max-width: 350px; padding: 0; overflow: hidden; position: relative;">
                        <!-- 头部 -->
                        <div style="background: linear-gradient(135deg, #34c759, #28a745); padding: 20px; text-align: center; position: relative;">
                            <button onclick="closeManualAdd()" style="position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; width: 32px; height: 32px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">×</button>
                            <h2 style="color: white; margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">手动添加</h2>
                            <div style="color: rgba(255, 255, 255, 0.8); font-size: 14px;">选择要添加的设备类型</div>
                        </div>
                        
                        <!-- 设备类型选择 -->
                        <div style="padding: 24px;">
                            <div style="display: grid; gap: 16px;">
                                <div onclick="addNewDevice('储能系统')" style="background: #2a2a2a; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;" onmouseover="this.style.borderColor='#34c759'" onmouseout="this.style.borderColor='transparent'">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #9333EA, #6B46C1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">🔋</div>
                                        <div>
                                            <div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px;">储能系统</div>
                                            <div style="color: #86868b; font-size: 13px;">电池储能管理系统</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div onclick="addNewDevice('光伏逆变器')" style="background: #2a2a2a; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;" onmouseover="this.style.borderColor='#34c759'" onmouseout="this.style.borderColor='transparent'">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #45B7D1, #96CEB4); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">☀️</div>
                                        <div>
                                            <div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px;">光伏逆变器</div>
                                            <div style="color: #86868b; font-size: 13px;">太阳能发电设备</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div onclick="addNewDevice('充电桩')" style="background: #2a2a2a; border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;" onmouseover="this.style.borderColor='#34c759'" onmouseout="this.style.borderColor='transparent'">
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">⚡</div>
                                        <div>
                                            <div style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px;">充电桩</div>
                                            <div style="color: #86868b; font-size: 13px;">电动汽车充电设备</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', manualAddHTML);
        }
        
        function closeManualAdd() {
            const modal = document.getElementById('manualAddModal');
            if (modal) modal.remove();
        }
        
        function closeAddDevice() {
            const modal = document.getElementById('addDeviceModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function addNewDevice(deviceType) {
            // 生成设备数据
            const deviceNumber = devices.length + 1;
            const deviceIcons = {
                '储能系统': '🔋',
                '光伏逆变器': '☀️',
                '充电桩': '⚡'
            };
            
            const newDevice = {
                id: `device_${Date.now()}`,
                name: `${deviceType} ${deviceNumber.toString().padStart(2, '0')}`,
                type: deviceType,
                sn: `SN${new Date().getFullYear()}${Math.random().toString().substr(2, 6)}`,
                online: Math.random() > 0.3, // 70%概率在线
                icon: deviceIcons[deviceType],
                soc: Math.floor(Math.random() * 40) + 60, // 60-100%
                soh: Math.floor(Math.random() * 10) + 90,  // 90-100%
                status: Math.random() > 0.5 ? '充电' : '待机',
                networkConfigured: false // 新添加的设备默认未配网
            };
            
            devices.push(newDevice);
            lastAddedDevice = newDevice; // 记录最后添加的设备
            closeAddDevice();
            closeManualAdd();
            updateDeviceDisplay();
            
            // 显示添加成功提示
            showSuccessMessage(`${deviceType} 添加成功！`);
            
            // 显示网络配置弹窗
            setTimeout(() => {
                showNetworkConfigModal();
            }, 500);
        }
        
        function updateDeviceDisplay() {
            const emptyState = document.getElementById('emptyDeviceState');
            const listState = document.getElementById('deviceListState');
            const deviceContainer = listState.querySelector('div[style*="display: grid"]');
            const pageTitle = document.querySelector('#device .page-title');
            
            if (devices.length === 0) {
                emptyState.style.display = 'flex';
                listState.style.display = 'none';
                pageTitle.textContent = '设备';
            } else {
                emptyState.style.display = 'none';
                listState.style.display = 'block';
                
                // 更新页面标题
                pageTitle.textContent = '设备';
                
                // 生成设备卡片
                deviceContainer.innerHTML = devices.map((device, index) => `
                    <div onclick="openDeviceDetail('${device.name}', '${device.sn}', ${device.online})" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 18px; border: 0.5px solid rgba(0, 0, 0, 0.04); padding: 20px; transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); position: relative; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; flex: 1; gap: 8px;">
                                <div style="font-weight: 600; font-size: 17px; color: #1d1d1f;">${device.name}</div>
                                <div onclick="event.stopPropagation(); goToNetworkConfig()" style="color: ${device.networkConfigured ? '#2e7d0d' : '#fff'}; background-color: ${device.networkConfigured ? 'rgba(46, 125, 13, 0.1)' : '#d97706'}; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; padding: 4px 8px; border-radius: 6px;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                                    ${device.networkConfigured ? '已配网' : '未配网'}>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="color: ${device.online ? '#30d158' : '#86868b'}; font-size: 13px; font-weight: 600;">● ${device.online ? '在线' : '离线'}</div>
                                <button onclick="event.stopPropagation(); openDeviceDetail('${device.name}', '${device.sn}', ${device.online})" style="background: none; border: none; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s ease; font-size: 16px;" onmouseover="this.style.background='rgba(0, 122, 255, 0.1)'" onmouseout="this.style.background='none'" title="查看详情">
                                    ➡️
                                </button>
                                <button onclick="event.stopPropagation(); showDeleteConfirmation('${device.id}', '${device.name}', ${index})" style="background: none; border: none; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255, 59, 48, 0.1)'" onmouseout="this.style.background='none'">
                                    <svg width="16" height="16" fill="#ff3b30" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-around; margin-bottom: 16px;">
                                <div style="text-align: center;">
                                    <div style="color: #86868b; font-size: 11px; margin-bottom: 6px; letter-spacing: 0.2px;">状态</div>
                                    <div style="color: #1d1d1f; font-size: 16px; font-weight: 600;">${device.status}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #86868b; font-size: 11px; margin-bottom: 6px; letter-spacing: 0.2px;">SOC</div>
                                    <div style="color: #1d1d1f; font-size: 16px; font-weight: 600;">${device.soc}%</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: #86868b; font-size: 11px; margin-bottom: 6px; letter-spacing: 0.2px;">SOH</div>
                                    <div style="color: #1d1d1f; font-size: 16px; font-weight: 600;">${device.soh}%</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid rgba(0, 0, 0, 0.08); padding-top: 12px; display: flex; justify-content: flex-end;">
                                <button onclick="event.stopPropagation(); openDeviceDetail('${device.name}', '${device.sn}', ${device.online})" style="background: none; border: none; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-radius: 8px; transition: all 0.2s ease; color: #007AFF; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='rgba(0, 122, 255, 0.08)'" onmouseout="this.style.background='none'">
                                    <span>详情</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M5 12h14"/>
                                        <path d="M12 5l7 7-7 7"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // 删除设备功能
        function showDeleteConfirmation(deviceId, deviceName, deviceIndex) {
            const deleteModalHTML = `
                <div id="deleteConfirmModal" onclick="closeDeleteConfirmation()" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div onclick="event.stopPropagation()" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-radius: 20px; width: 85%; max-width: 300px; overflow: hidden; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); border: 0.5px solid rgba(0, 0, 0, 0.1);">
                        <!-- 内容 -->
                        <div style="padding: 24px 20px 20px; text-align: center;">
                            <div style="color: #1d1d1f; font-size: 18px; font-weight: 600; margin-bottom: 8px; line-height: 1.3;">删除设备"${deviceName}"？</div>
                            <div style="color: #86868b; font-size: 14px; line-height: 1.4;">设备将从列表中永久移除。</div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div style="border-top: 0.5px solid rgba(0, 0, 0, 0.1);">
                            <div style="display: flex;">
                                <button onclick="closeDeleteConfirmation()" style="flex: 1; background: none; border: none; padding: 16px; font-size: 17px; font-weight: 400; cursor: pointer; color: #007aff; border-right: 0.5px solid rgba(0, 0, 0, 0.1); transition: all 0.2s ease;" 
                                    onmousedown="this.style.background='rgba(0, 122, 255, 0.1)'" 
                                    onmouseup="this.style.background='none'" 
                                    onmouseleave="this.style.background='none'"
                                    ontouchstart="this.style.background='rgba(0, 122, 255, 0.1)'" 
                                    ontouchend="this.style.background='none'">
                                    取消
                                </button>
                                <button onclick="confirmDeleteDevice('${deviceId}', ${deviceIndex})" style="flex: 1; background: none; border: none; padding: 16px; font-size: 17px; font-weight: 600; cursor: pointer; color: #ff3b30; transition: all 0.2s ease;" 
                                    onmousedown="this.style.background='rgba(255, 59, 48, 0.1)'" 
                                    onmouseup="this.style.background='none'" 
                                    onmouseleave="this.style.background='none'"
                                    ontouchstart="this.style.background='rgba(255, 59, 48, 0.1)'" 
                                    ontouchend="this.style.background='none'">
                                    删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', deleteModalHTML);
        }
        
        function closeDeleteConfirmation() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) modal.remove();
        }
        
        function confirmDeleteDevice(deviceId, deviceIndex) {
            // 从设备数组中删除设备
            const deletedDevice = devices.find(device => device.id === deviceId);
            devices = devices.filter(device => device.id !== deviceId);
            
            // 关闭确认弹窗
            closeDeleteConfirmation();
            
            // 更新设备显示
            updateDeviceDisplay();
            
            // 显示删除成功提示
            showSuccessMessage(`${deletedDevice.name} 已删除`);
        }
        
        function showSuccessMessage(message) {
            // 清除之前的提示
            const existingMessage = document.getElementById('successMessage');
            if (existingMessage) existingMessage.remove();
            
            const successHTML = `
                <div id="successMessage" style="position: absolute; top: 100px; left: 50%; transform: translateX(-50%); background: #30d158; color: white; padding: 16px 28px; border-radius: 24px; font-size: 16px; font-weight: 600; z-index: 9999; box-shadow: 0 8px 32px rgba(48, 209, 88, 0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2);">
                    ✓ ${message}
                </div>
            `;
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', successHTML);
            
            // 2秒后自动消失
            setTimeout(() => {
                const msg = document.getElementById('successMessage');
                if (msg) {
                    msg.style.transform = 'translateX(-50%) translateY(-30px)';
                    msg.style.opacity = '0';
                    setTimeout(() => msg.remove(), 300);
                }
            }, 2000);
        }
        
        // 网络配置弹窗
        function showNetworkConfigModal() {
            const modalHTML = `
                <div id="networkConfigModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
                    <div style="background: #ffffff; border-radius: 24px; width: 90%; max-width: 340px; padding: 0; overflow: hidden; position: relative; animation: slideUp 0.3s ease;">
                        <!-- 图标和标题 -->
                        <div style="padding: 32px 24px 20px; text-align: center;">
                            <!-- WiFi图标 -->
                            <div style="width: 72px; height: 72px; background: linear-gradient(135deg, #007aff 0%, #0056b3 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                <svg width="36" height="36" fill="white" viewBox="0 0 24 24">
                                    <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                                </svg>
                            </div>
                            
                            <h2 style="font-size: 22px; font-weight: 600; color: #1d1d1f; margin: 0 0 8px 0;">设置网络连接</h2>
                            <p style="font-size: 15px; color: #86868b; margin: 0; line-height: 1.4;">为新添加的设备配置网络，确保设备能够正常联网运行</p>
                        </div>
                        
                        <!-- 按钮组 -->
                        <div style="padding: 0 24px 24px;">
                            <!-- 前往设置按钮 -->
                            <button onclick="goToNetworkSettings()" style="width: 100%; background: #007aff; color: white; border: none; border-radius: 12px; padding: 16px; font-size: 17px; font-weight: 600; cursor: pointer; margin-bottom: 12px; transition: all 0.2s ease;">
                                前往设置
                            </button>
                            
                            <!-- 稍后设置按钮 -->
                            <button onclick="closeNetworkConfigModal()" style="width: 100%; background: rgba(0, 0, 0, 0.04); color: #007aff; border: none; border-radius: 12px; padding: 16px; font-size: 17px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                                稍后设置
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加样式动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // 关闭网络配置弹窗
        function closeNetworkConfigModal() {
            const modal = document.getElementById('networkConfigModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // 前往网络设置页面
        function goToNetworkSettings() {
            closeNetworkConfigModal();
            
            // 直接跳转到网络配置页面
            window.location.href = './network-config.html';
        }
        
        // 跳转到网络配置页面
        function goToNetworkConfig() {
            window.location.href = './network-config.html';
        }
        
        // 打开网络设置面板（从设置页面点击）
        function openNetworkSettingsPanel() {
            showNetworkSettingsPage();
        }
        
        // 显示网络设置页面
        function showNetworkSettingsPage() {
            const networkPageHTML = `
                <div id="networkSettingsPage" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f2f2f7; z-index: 2500; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
                    <!-- 状态栏 -->
                    <div class="status-bar">
                        <div class="status-time">13:34</div>
                        <div class="status-icons">
                            <svg width="18" height="18" fill="#1d1d1f" viewBox="0 0 20 20">
                                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                            </svg>
                            <svg width="18" height="18" fill="#1d1d1f" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1v0a1 1 0 110 2v0a1 1 0 01-1-1z"></path>
                            </svg>
                            <div class="battery">
                                <div class="battery-level"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 导航栏 -->
                    <div style="background: white; border-bottom: 0.5px solid rgba(0, 0, 0, 0.1); padding: 0 20px; height: 44px; display: flex; align-items: center;">
                        <button onclick="closeNetworkSettingsPage()" style="background: none; border: none; padding: 8px; margin-left: -8px; cursor: pointer;">
                            <svg width="24" height="24" fill="#007aff" viewBox="0 0 24 24">
                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                            </svg>
                        </button>
                        <div style="flex: 1; text-align: center; font-size: 17px; font-weight: 600;">网络配置</div>
                        <div style="width: 40px;"></div>
                    </div>
                    
                    <!-- 内容区域 -->
                    <div style="flex: 1; overflow-y: auto; padding: 20px;">
                        <!-- WiFi设置卡片 -->
                        <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 32px; height: 32px; background: #007aff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg width="18" height="18" fill="white" viewBox="0 0 24 24">
                                            <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div style="font-size: 16px; font-weight: 600; color: #1d1d1f;">Wi-Fi</div>
                                        <div style="font-size: 13px; color: #86868b;">已连接到 Office_5G</div>
                                    </div>
                                </div>
                                <label style="position: relative; display: inline-block; width: 51px; height: 31px;">
                                    <input type="checkbox" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #34c759; transition: .4s; border-radius: 31px;">
                                        <span style="position: absolute; content: ''; height: 27px; width: 27px; left: 2px; bottom: 2px; background: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: translateX(20px);"></span>
                                    </span>
                                </label>
                            </div>
                            
                            <!-- 可用网络列表 -->
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                                <div style="font-size: 13px; color: #86868b; margin-bottom: 12px;">可用网络</div>
                                
                                <div onclick="connectToWiFi('Office_5G')" style="display: flex; align-items: center; justify-content: between; padding: 12px; background: #f2f2f7; border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; color: #1d1d1f;">Office_5G</div>
                                        <div style="font-size: 12px; color: #007aff;">已连接</div>
                                    </div>
                                    <svg width="20" height="20" fill="#86868b" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                
                                <div onclick="connectToWiFi('Home_Network')" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f2f2f7'" onmouseout="this.style.background='transparent'">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; color: #1d1d1f;">Home_Network</div>
                                        <div style="font-size: 12px; color: #86868b;">信号强</div>
                                    </div>
                                    <svg width="16" height="16" fill="#c7c7cc" viewBox="0 0 24 24">
                                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                                    </svg>
                                </div>
                                
                                <div onclick="connectToWiFi('Guest_WiFi')" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f2f2f7'" onmouseout="this.style.background='transparent'">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; color: #1d1d1f;">Guest_WiFi</div>
                                        <div style="font-size: 12px; color: #86868b;">信号中等</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 设备网络信息 -->
                        <div style="background: white; border-radius: 12px; padding: 16px;">
                            <div style="font-size: 16px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px;">设备网络信息</div>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #86868b; font-size: 14px;">IP地址</span>
                                    <span style="color: #1d1d1f; font-size: 14px;">192.168.1.128</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #86868b; font-size: 14px;">子网掩码</span>
                                    <span style="color: #1d1d1f; font-size: 14px;">255.255.255.0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #86868b; font-size: 14px;">网关</span>
                                    <span style="color: #1d1d1f; font-size: 14px;">192.168.1.1</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #86868b; font-size: 14px;">DNS</span>
                                    <span style="color: #1d1d1f; font-size: 14px;">8.8.8.8</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 底部按钮 -->
                    <div style="padding: 20px; background: white; border-top: 0.5px solid rgba(0, 0, 0, 0.1);">
                        <button onclick="saveNetworkSettings()" style="width: 100%; background: #007aff; color: white; border: none; border-radius: 12px; padding: 16px; font-size: 17px; font-weight: 600; cursor: pointer;">
                            保存设置
                        </button>
                    </div>
                </div>
            `;
            
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', networkPageHTML);
            
            // 显示页面动画
            setTimeout(() => {
                document.getElementById('networkSettingsPage').style.transform = 'translateX(0)';
            }, 10);
        }
        
        // 关闭网络设置页面
        function closeNetworkSettingsPage() {
            const page = document.getElementById('networkSettingsPage');
            if (page) {
                page.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    page.remove();
                }, 300);
            }
        }
        
        // 连接到WiFi
        function connectToWiFi(networkName) {
            if (networkName === 'Home_Network' || networkName === 'Guest_WiFi') {
                // 显示密码输入框
                showPasswordPrompt(networkName);
            }
        }
        
        // 显示密码输入弹窗
        function showPasswordPrompt(networkName) {
            const promptHTML = `
                <div id="passwordPrompt" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 14px; width: 90%; max-width: 320px; padding: 20px;">
                        <h3 style="font-size: 17px; font-weight: 600; margin-bottom: 8px;">输入密码</h3>
                        <p style="font-size: 14px; color: #86868b; margin-bottom: 16px;">请输入 "${networkName}" 的密码</p>
                        <input type="password" id="wifiPassword" placeholder="密码" style="width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; font-size: 16px; margin-bottom: 16px;">
                        <div style="display: flex; gap: 12px;">
                            <button onclick="cancelPasswordPrompt()" style="flex: 1; padding: 12px; border: 1px solid #d1d1d6; background: white; border-radius: 8px; font-size: 16px; color: #007aff; cursor: pointer;">取消</button>
                            <button onclick="confirmWiFiConnection('${networkName}')" style="flex: 1; padding: 12px; border: none; background: #007aff; color: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">连接</button>
                        </div>
                    </div>
                </div>
            `;
            document.querySelector('.phone-container').insertAdjacentHTML('beforeend', promptHTML);
        }
        
        // 取消密码输入
        function cancelPasswordPrompt() {
            const prompt = document.getElementById('passwordPrompt');
            if (prompt) prompt.remove();
        }
        
        // 确认WiFi连接
        function confirmWiFiConnection(networkName) {
            cancelPasswordPrompt();
            showSuccessMessage(`已连接到 ${networkName}`);
        }
        
        // 保存网络设置
        function saveNetworkSettings() {
            closeNetworkSettingsPage();
            showSuccessMessage('网络设置已保存');
        }
        
        
        // QR扫码功能
        function openQRScanner() {
            const qrPage = document.getElementById('qrScanPage');
            if (qrPage) {
                // 重置页面内容为原始状态
                resetQRScannerPage();
                
                qrPage.style.display = 'block';
                qrPage.style.transform = 'translateX(0)';
                
                // 开始模拟扫描
                setTimeout(() => {
                    simulateQRScan();
                }, 2000);
            }
        }
        
        function resetQRScannerPage() {
            const qrPage = document.getElementById('qrScanPage');
            qrPage.innerHTML = `
                <!-- 状态栏 -->
                <div class="status-bar" style="background: transparent;">
                    <div class="status-time" style="color: white;">13:34</div>
                    <div class="status-icons">
                        <svg width="18" height="18" fill="white" viewBox="0 0 20 20">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                        </svg>
                        <svg width="18" height="18" fill="white" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM14.95 11.05a7 7 0 00-9.9 0 1 1 0 01-1.414-1.414 9 9 0 0112.728 0 1 1 0 01-1.414 1.414zM12.12 13.88a3 3 0 00-4.242 0 1 1 0 01-1.415-1.415 5 5 0 017.072 0 1 1 0 01-1.415 1.415zM9 16a1 1 0 011-1v0a1 1 0 110 2v0a1 1 0 01-1-1z"></path>
                        </svg>
                        <div class="battery" style="border-color: white;">
                            <div class="battery-level" style="background: white;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 导航栏 -->
                <div style="height: 44px; display: flex; align-items: center; padding: 0 20px; background: transparent;">
                    <button onclick="closeQRScanner()" style="background: none; border: none; padding: 8px; margin-left: -8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                    </button>
                    <div style="flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: white;">扫码添加设备</div>
                    <div style="width: 40px;"></div>
                </div>
                
                <!-- 扫描区域 -->
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px;">
                    <!-- 扫描框 -->
                    <div class="qr-scan-frame" style="position: relative; width: 280px; height: 280px;">
                        <!-- 扫描框边角 -->
                        <div style="position: absolute; top: 0; left: 0; width: 40px; height: 40px; border-top: 4px solid #007aff; border-left: 4px solid #007aff; border-radius: 8px 0 0 0;"></div>
                        <div style="position: absolute; top: 0; right: 0; width: 40px; height: 40px; border-top: 4px solid #007aff; border-right: 4px solid #007aff; border-radius: 0 8px 0 0;"></div>
                        <div style="position: absolute; bottom: 0; left: 0; width: 40px; height: 40px; border-bottom: 4px solid #007aff; border-left: 4px solid #007aff; border-radius: 0 0 0 8px;"></div>
                        <div style="position: absolute; bottom: 0; right: 0; width: 40px; height: 40px; border-bottom: 4px solid #007aff; border-right: 4px solid #007aff; border-radius: 0 0 8px 0;"></div>
                        
                        <!-- 扫描线动画 -->
                        <div class="qr-scan-line" style="position: absolute; top: 50px; left: 20px; right: 20px; height: 2px; background: #007aff; box-shadow: 0 0 10px #007aff; animation: qrScan 2s ease-in-out infinite;"></div>
                        
                        <!-- 模拟摄像头预览 -->
                        <div style="position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;"></div>
                    </div>
                    
                    <!-- 扫描成功区域 -->
                    <div id="qrSuccessArea"></div>
                </div>
            `;
        }
        
        function closeQRScanner() {
            const qrPage = document.getElementById('qrScanPage');
            if (qrPage) {
                qrPage.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    qrPage.style.display = 'none';
                }, 300);
            }
        }
        
        function simulateQRScan() {
            // 模拟扫描到设备二维码
            const mockQRDevices = [
                { name: 'BEI-QR01', type: '储能系统', qr: 'BEIENERGY_BAT_001_2024' },
                { name: 'PV-QR02', type: '光伏逆变器', qr: 'BEIENERGY_INV_002_2024' },
                { name: 'EV-QR03', type: '充电桩', qr: 'BEIENERGY_CHG_003_2024' }
            ];
            
            const randomDevice = mockQRDevices[Math.floor(Math.random() * mockQRDevices.length)];
            
            // 显示扫描成功状态
            const successArea = document.getElementById('qrSuccessArea');
            const scanFrame = document.querySelector('.qr-scan-frame');
            
            if (successArea && scanFrame) {
                // 停止扫描动画
                const scanLine = document.querySelector('.qr-scan-line');
                if (scanLine) scanLine.style.animation = 'none';
                
                // 显示成功状态
                scanFrame.style.borderColor = '#30d158';
                
                // 立即自动添加设备
                setTimeout(() => {
                    addQRDeviceDirectly(randomDevice.name, randomDevice.type, randomDevice.qr);
                }, 500);
            }
        }
        
        function addQRDeviceDirectly(deviceName, deviceType, qrCode) {
            const deviceIcons = {
                '储能系统': '🔋',
                '光伏逆变器': '☀️',
                '充电桩': '⚡'
            };
            
            const newDevice = {
                id: `device_${Date.now()}`,
                name: deviceName,
                type: deviceType,
                sn: qrCode,
                online: true,
                icon: deviceIcons[deviceType],
                soc: Math.floor(Math.random() * 40) + 60,
                soh: Math.floor(Math.random() * 10) + 90,
                status: Math.random() > 0.5 ? '充电' : '放电',
                networkConfigured: false // 新添加的设备默认未配网
            };
            
            devices.push(newDevice);
            lastAddedDevice = newDevice; // 记录最后添加的设备
            closeQRScanner();
            closeAddDevicePage();
            updateDeviceDisplay();
            
            // 手动切换到设备页面
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById('device').classList.add('active');
            
            // 显示网络配置弹窗
            setTimeout(() => {
                showNetworkConfigModal();
            }, 1000);
            
            // 更新导航状态
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            
            // 显示添加成功提示 - 增加延迟确保页面切换完成
            setTimeout(() => {
                showSuccessMessage('添加成功');
            }, 1000);
        }
        
        // 蓝牙连接相关函数
        function openBluetoothModal() {
            openAddDevice();
        }
        
        function closeBluetoothModal() {
            // 这个函数保留以兼容性，但实际使用 closeAddDevicePage
            closeAddDevicePage();
        }
        
        function connectBMSDevice() {
            const statusEl = document.getElementById('bmsStatus');
            const btnEl = document.getElementById('bmsConnectBtn');
            
            btnEl.textContent = '连接中...';
            btnEl.disabled = true;
            
            // 模拟连接过程
            setTimeout(() => {
                statusEl.textContent = '已连接';
                statusEl.style.color = '#30D158';
                btnEl.textContent = '已连接';
                btnEl.style.background = '#30D158';
                btnEl.disabled = true;
                
                // 显示连接成功提示
                showToast('BMS设备连接成功');
            }, 2000);
        }
        
        function connectInverterDevice() {
            const statusEl = document.getElementById('invStatus');
            const btnEl = document.getElementById('invConnectBtn');
            
            btnEl.textContent = '连接中...';
            btnEl.disabled = true;
            
            // 模拟连接过程
            setTimeout(() => {
                statusEl.textContent = '已连接';
                statusEl.style.color = '#30D158';
                btnEl.textContent = '已连接';
                btnEl.style.background = '#30D158';
                btnEl.disabled = true;
                
                // 显示连接成功提示
                showToast('逆变器设备连接成功');
            }, 1500);
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('北能智能光伏管理系统已加载');
            
            // 模拟实时数据更新
            setInterval(() => {
                const powerValues = document.querySelectorAll('.energy-value');
                if (powerValues.length > 0) {
                    // 模拟光伏发电功率变化
                    const currentPower = parseFloat(powerValues[0].textContent);
                    const newPower = (currentPower + (Math.random() - 0.5) * 0.1).toFixed(2);
                    powerValues[0].innerHTML = newPower + '<span class="energy-unit">kW</span>';
                }
            }, 5000);
        });
        // 页面加载时检查是否需要跳转到特定页面
        window.addEventListener('DOMContentLoaded', function() {
            // 检查URL中的hash参数
            const hash = window.location.hash;
            if (hash === '#device') {
                // 自动切换到设备页面
                const deviceNavItem = document.querySelector('.nav-item[onclick*="device"]');
                if (deviceNavItem) {
                    deviceNavItem.click();
                }
            }
            
            // 检查localStorage中的默认页面设置
            const defaultPage = localStorage.getItem('defaultPage');
            if (defaultPage === 'device' && !hash) {
                // 如果设置了默认页面且URL没有hash，则跳转到设备页面
                const deviceNavItem = document.querySelector('.nav-item[onclick*="device"]');
                if (deviceNavItem) {
                    deviceNavItem.click();
                }
                // 清除默认页面设置，避免每次都跳转
                localStorage.removeItem('defaultPage');
            }
        });

        // 显示位置权限请求弹窗
        function showLocationPermissionDialog() {
            // 创建弹窗容器
            const dialog = document.createElement('div');
            dialog.id = 'locationPermissionDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            
            // 创建弹窗内容
            const content = document.createElement('div');
            content.style.cssText = `
                background: #f2f2f7;
                border-radius: 14px;
                max-width: 320px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            `;
            
            // 标题部分
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px 20px 12px;
                text-align: center;
                background: white;
            `;
            
            const title = document.createElement('div');
            title.style.cssText = `
                font-size: 17px;
                font-weight: 600;
                color: #000;
                margin-bottom: 8px;
            `;
            title.innerHTML = '允许"北能BMS"<br>使用你的位置？';
            
            const subtitle = document.createElement('div');
            subtitle.style.cssText = `
                font-size: 13px;
                color: #3C3C43;
                line-height: 18px;
                opacity: 0.6;
                margin-top: 8px;
            `;
            subtitle.textContent = '位置权限用于快速连接设备、识别定位以及发现附近的设备和Wi-Fi列表。';
            
            header.appendChild(title);
            header.appendChild(subtitle);
            
            // 地图预览部分
            const mapContainer = document.createElement('div');
            mapContainer.style.cssText = `
                height: 160px;
                background: linear-gradient(to bottom, #e8f4f8, #d4e8ee);
                position: relative;
                overflow: hidden;
            `;
            
            // 添加简单的地图元素
            const mapContent = document.createElement('div');
            mapContent.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <div style="width: 20px; height: 20px; background: #007AFF; border-radius: 50%; box-shadow: 0 0 0 8px rgba(0, 122, 255, 0.2);"></div>
                </div>
                <div style="position: absolute; bottom: 10px; left: 10px; background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #666;">
                    <span>📍 当前位置</span>
                </div>
            `;
            mapContainer.appendChild(mapContent);
            
            // 按钮容器
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                background: white;
                padding: 0;
            `;
            
            // 允许一次按钮
            const allowOnceBtn = document.createElement('button');
            allowOnceBtn.style.cssText = `
                width: 100%;
                padding: 16px;
                border: none;
                background: white;
                font-size: 17px;
                color: #007AFF;
                cursor: pointer;
                border-bottom: 0.5px solid rgba(60, 60, 67, 0.13);
                transition: background-color 0.2s;
            `;
            allowOnceBtn.textContent = '允许一次';
            allowOnceBtn.onmouseover = () => allowOnceBtn.style.background = '#f9f9f9';
            allowOnceBtn.onmouseout = () => allowOnceBtn.style.background = 'white';
            allowOnceBtn.onclick = () => handleLocationPermission('once');
            
            // 使用App时允许按钮
            const allowWhileUsingBtn = document.createElement('button');
            allowWhileUsingBtn.style.cssText = `
                width: 100%;
                padding: 16px;
                border: none;
                background: white;
                font-size: 17px;
                color: #007AFF;
                cursor: pointer;
                border-bottom: 0.5px solid rgba(60, 60, 67, 0.13);
                transition: background-color 0.2s;
            `;
            allowWhileUsingBtn.textContent = '使用 App 时允许';
            allowWhileUsingBtn.onmouseover = () => allowWhileUsingBtn.style.background = '#f9f9f9';
            allowWhileUsingBtn.onmouseout = () => allowWhileUsingBtn.style.background = 'white';
            allowWhileUsingBtn.onclick = () => handleLocationPermission('while-using');
            
            // 不允许按钮
            const denyBtn = document.createElement('button');
            denyBtn.style.cssText = `
                width: 100%;
                padding: 16px;
                border: none;
                background: white;
                font-size: 17px;
                color: #007AFF;
                cursor: pointer;
                transition: background-color 0.2s;
            `;
            denyBtn.textContent = '不允许';
            denyBtn.onmouseover = () => denyBtn.style.background = '#f9f9f9';
            denyBtn.onmouseout = () => denyBtn.style.background = 'white';
            denyBtn.onclick = () => handleLocationPermission('denied');
            
            buttonContainer.appendChild(allowOnceBtn);
            buttonContainer.appendChild(allowWhileUsingBtn);
            buttonContainer.appendChild(denyBtn);
            
            content.appendChild(header);
            content.appendChild(mapContainer);
            content.appendChild(buttonContainer);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }
        
        // 处理位置权限选择
        function handleLocationPermission(permission) {
            const dialog = document.getElementById('locationPermissionDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
            
            // 保存权限选择
            localStorage.setItem('locationPermission', permission);
            
            switch(permission) {
                case 'once':
                    showToast('已允许使用位置（仅限本次）');
                    // 显示蓝牙权限弹窗
                    setTimeout(() => {
                        showBluetoothPermissionDialog();
                    }, 1000);
                    // 本次使用后清除权限
                    setTimeout(() => {
                        localStorage.removeItem('locationPermission');
                    }, 30000); // 30秒后清除
                    break;
                    
                case 'while-using':
                    showToast('已允许在使用App时访问位置');
                    // 显示蓝牙权限弹窗
                    setTimeout(() => {
                        showBluetoothPermissionDialog();
                    }, 1000);
                    break;
                    
                case 'denied':
                    showToast('已拒绝位置权限');
                    // 不继续蓝牙连接
                    break;
            }
        }
        
        // 显示蓝牙权限请求弹窗
        function showBluetoothPermissionDialog() {
            // 创建弹窗容器
            const dialog = document.createElement('div');
            dialog.id = 'bluetoothPermissionDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            `;
            
            // 创建弹窗内容
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 14px;
                max-width: 320px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            `;
            
            // 内容部分
            const body = document.createElement('div');
            body.style.cssText = `
                padding: 32px 20px 20px;
                text-align: center;
                background: white;
            `;
            
            // 蓝牙图标
            const iconContainer = document.createElement('div');
            iconContainer.style.cssText = `
                margin-bottom: 20px;
            `;
            iconContainer.innerHTML = `
                <svg width="56" height="56" viewBox="0 0 56 56" fill="none" style="margin: 0 auto;">
                    <rect width="56" height="56" rx="14" fill="#007AFF" fill-opacity="0.1"/>
                    <path d="M28 16L35 23L30 28L35 33L28 40V28L23 33L21 31L26 26L21 21L23 19L28 24V16Z" 
                          stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
            `;
            
            const title = document.createElement('div');
            title.style.cssText = `
                font-size: 17px;
                font-weight: 600;
                color: #000;
                margin-bottom: 12px;
                line-height: 24px;
            `;
            title.innerHTML = '"北能BMS"想要使用蓝牙';
            
            const message = document.createElement('div');
            message.style.cssText = `
                font-size: 13px;
                color: #3C3C43;
                opacity: 0.6;
                line-height: 18px;
                margin-bottom: 4px;
            `;
            message.textContent = '连接逆变器时需要打开蓝牙。请允许"北能BMS"使用蓝牙来发现、连接附近的设备。';
            
            body.appendChild(iconContainer);
            body.appendChild(title);
            body.appendChild(message);
            
            // 按钮容器
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                border-top: 0.5px solid rgba(60, 60, 67, 0.13);
            `;
            
            // 不允许按钮
            const denyBtn = document.createElement('button');
            denyBtn.style.cssText = `
                flex: 1;
                padding: 17px;
                border: none;
                background: white;
                font-size: 17px;
                color: #007AFF;
                cursor: pointer;
                border-right: 0.5px solid rgba(60, 60, 67, 0.13);
                transition: background-color 0.2s;
            `;
            denyBtn.textContent = '不允许';
            denyBtn.onmouseover = () => denyBtn.style.background = '#f9f9f9';
            denyBtn.onmouseout = () => denyBtn.style.background = 'white';
            denyBtn.onclick = () => handleBluetoothPermission('denied');
            
            // 好按钮（允许）
            const allowBtn = document.createElement('button');
            allowBtn.style.cssText = `
                flex: 1;
                padding: 17px;
                border: none;
                background: white;
                font-size: 17px;
                color: #007AFF;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
            `;
            allowBtn.textContent = '好';
            allowBtn.onmouseover = () => allowBtn.style.background = '#f9f9f9';
            allowBtn.onmouseout = () => allowBtn.style.background = 'white';
            allowBtn.onclick = () => handleBluetoothPermission('allowed');
            
            buttonContainer.appendChild(denyBtn);
            buttonContainer.appendChild(allowBtn);
            
            content.appendChild(body);
            content.appendChild(buttonContainer);
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }
        
        // 处理蓝牙权限选择
        function handleBluetoothPermission(permission) {
            const dialog = document.getElementById('bluetoothPermissionDialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
            
            // 保存蓝牙权限选择
            localStorage.setItem('bluetoothPermission', permission);
            
            if (permission === 'allowed') {
                showToast('已允许使用蓝牙');
                // 继续添加设备流程
                setTimeout(() => {
                    showAddDevicePageDirectly();
                }, 500);
            } else {
                showToast('已拒绝蓝牙权限');
            }
        }
    </script>
</body>
</html>